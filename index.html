<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>DSHS School System</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="theme-color" content="#8B0000">
<meta name="description" content="Dumingag Senior High School Management System">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="DSHS">

<link rel="manifest" href="manifest.json">
<link rel="apple-touch-icon" href="icons/icon-192x192.png">

<!-- Firebase SDK (v9 Modular) -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
  import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, sendPasswordResetEmail, updatePassword } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
  import { getFirestore, collection, doc, getDoc, getDocs, setDoc, updateDoc, deleteDoc, query, where, onSnapshot, addDoc, serverTimestamp, orderBy, limit, writeBatch } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";
  import { getAnalytics } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-analytics.js";
  import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-storage.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBr-wATdD81M4lc8dlxqhRUEMKVtHPj-DU",
    authDomain: "connect-ta-13ab9.firebaseapp.com",
    projectId: "connect-ta-13ab9",
    storageBucket: "connect-ta-13ab9.firebasestorage.app",
    messagingSenderId: "38813026824",
    appId: "1:38813026824:web:b471597524cdd56618dfbd",
    measurementId: "G-641QGL0YPZ"
  };

  try {
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const analytics = getAnalytics(app);
    const storage = getStorage(app);

    window.firebaseApp = app;
    window.firebaseAuth = auth;
    window.firebaseDB = db;
    window.firebaseAnalytics = analytics;
    window.firebaseStorage = storage;
    window.firebaseFns = {
      onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, sendPasswordResetEmail, updatePassword,
      collection, doc, getDoc, getDocs, setDoc, updateDoc, deleteDoc, query, where, onSnapshot, addDoc, serverTimestamp, orderBy, limit, writeBatch,
      ref, uploadBytes, getDownloadURL
    };
    
    console.log('Firebase initialized successfully');
  } catch (error) {
    console.error('Firebase initialization error:', error);
    alert('Failed to initialize Firebase. Please check your internet connection.');
  }
</script>

<style>
  :root {
    --main-red: #8B0000;
    --main-blue: #003366;
    --main-gray: #6c757d;
    --sub-yellow: #ffc107;
    --sub-orange: #fd7e14;
    --light-gray: #f8f9fa;
    --dark-gray: #495057;
    --success-green: #28a745;
    --danger-red: #dc3545;
    --warning-yellow: #ffc107;
  }
  
  * { box-sizing: border-box; }
  
  body { 
    margin: 0; 
    min-height: 100vh;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    position: relative;
    overflow-x: hidden;
  }
  
  /* RED-BLUE GRADIENT BACKGROUND */
  body::before {
    content: '';
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: linear-gradient(135deg, #8B0000 0%, #003366 100%);
    background-attachment: fixed;
    z-index: -1;
  }
  
  body.dark-mode {
    --main-red: #a00000;
    --main-blue: #004080;
    --light-gray: #2d2d2d;
    --dark-gray: #e0e0e0;
  }
  
  body.dark-mode::before {
    background: linear-gradient(135deg, #1a0000 0%, #001a33 100%);
  }
  
  body.dark-mode .box,
  body.dark-mode .section,
  body.dark-mode .id-card,
  body.dark-mode .parent-account-card,
  body.dark-mode .print-controls,
  body.dark-mode .school-map-container,
  body.dark-mode .attendance-legend,
  body.dark-mode .performance-box,
  body.dark-mode .chatbox,
  body.dark-mode .planner-container,
  body.dark-mode .subject-item,
  body.dark-mode .planner-item,
  body.dark-mode .analytics-card,
  body.dark-mode .notification-panel,
  body.dark-mode .messaging-container .contacts-list,
  body.dark-mode .messaging-container .chat-area,
  body.dark-mode .assignment-card,
  body.dark-mode .honor-roll,
  body.dark-mode .transmutation-table,
  body.dark-mode .conference-slot,
  body.dark-mode .payment-method,
  body.dark-mode .payment-history-item,
  body.dark-mode .behavior-item,
  body.dark-mode .upload-zone,
  body.dark-mode .quiz-question,
  body.dark-mode .settings-section {
    background: #2d2d2d;
    color: #e0e0e0;
    border-color: #444;
  }
  
  body.dark-mode input,
  body.dark-mode select,
  body.dark-mode textarea {
    background: #1a1a1a;
    color: #e0e0e0;
    border-color: #444;
  }
  
  body.dark-mode table th {
    background: linear-gradient(135deg, #660000 0%, #002244 100%);
  }
  
  body.dark-mode .schedule-box div {
    background: linear-gradient(135deg, #2d2d2d 0%, #1a1a1a 100%);
    border-color: #444;
  }
  
  #loadingOverlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(139, 0, 0, 0.95);
    z-index: 10000;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    color: white;
    transition: opacity 0.5s;
  }
  
  .spinner {
    width: 50px;
    height: 50px;
    border: 4px solid rgba(255,255,255,0.3);
    border-top-color: white;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin-bottom: 20px;
  }
  
  @keyframes spin { to { transform: rotate(360deg); } }
  
  .signup-link { color: var(--main-blue); font-weight: bold; cursor: pointer; }
  .signup-link:hover { text-decoration: underline; }
  
  .password-strength {
    height: 5px;
    margin-top: 5px;
    border-radius: 3px;
    transition: all 0.3s;
  }
  
  .password-strength.weak { background: #dc3545; width: 33%; }
  .password-strength.medium { background: #ffc107; width: 66%; }
  .password-strength.strong { background: #28a745; width: 100%; }
  
  .strength-text { font-size: 12px; margin-top: 3px; font-weight: bold; }
  
  input, button, textarea, select { 
    width: 100%; 
    padding: 12px; 
    margin-top: 8px; 
    font-size: 14px;
    border: 2px solid #ddd;
    border-radius: 6px;
    transition: border-color 0.3s;
  }
  
  input:focus, textarea:focus, select:focus {
    border-color: var(--main-blue);
    outline: none;
  }
  
  button { 
    cursor: pointer; 
    border-radius: 6px; 
    font-weight: bold;
    transition: all 0.3s;
    border: none;
  }
  
  button:hover:not(:disabled) {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
  }
  
  button:disabled {
    opacity: 0.6;
    cursor: not-allowed;
    transform: none;
  }
  
  .toggle-btn { 
    background: linear-gradient(135deg, var(--main-red) 0%, var(--main-blue) 100%); 
    color: white; 
    font-size: 18px; 
    position: fixed; 
    top: 12px; 
    left: 12px; 
    z-index: 1000; 
    padding: 12px 18px; 
    border-radius: 8px;
    display: flex;
    align-items: center;
    gap: 8px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.3);
  }
  
  .toggle-btn:hover:not(:disabled) { 
    background: linear-gradient(135deg, #660000 0%, #002244 100%);
    transform: scale(1.05);
  }
  
  .toggle-btn .icon { font-size: 22px; }
  .toggle-btn .text { font-weight: bold; }
  .toggle-btn.small { padding: 8px 12px; font-size: 14px; }
  .toggle-btn.small .text { display: none; }
  
  .logout-btn {
    position: fixed;
    top: 12px;
    right: 80px;
    background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
    color: white;
    font-size: 14px;
    padding: 12px 20px;
    border-radius: 8px;
    z-index: 999;
    display: flex;
    align-items: center;
    gap: 8px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.3);
  }
  
  .logout-btn:hover {
    background: linear-gradient(135deg, #c82333 0%, #a71e2a 100%);
    transform: scale(1.05);
  }
  
  .session-warning {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    background: #dc3545;
    color: white;
    text-align: center;
    padding: 10px;
    z-index: 10000;
    display: none;
    animation: pulse 2s infinite;
  }
  
  @keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.8; }
  }
  
  .login { 
    min-height: 100vh; 
    display: flex; 
    justify-content: center; 
    align-items: center; 
    padding: 20px;
    position: relative;
    z-index: 1;
  }
  
  .box { 
    background: rgba(255,255,255,0.98); 
    padding: 40px; 
    width: 100%; 
    max-width: 420px; 
    border-radius: 15px; 
    box-shadow: 0 15px 40px rgba(0,0,0,0.3); 
    text-align: center; 
    border-top: 5px solid var(--main-red);
    backdrop-filter: blur(10px);
  }
  
  .box h2 { color: var(--main-blue); margin-bottom: 25px; }
  
  .pass-wrapper { position: relative; }
  .pass-wrapper span { 
    position: absolute; 
    right: 15px; 
    top: 18px; 
    cursor: pointer; 
    font-size: 18px;
  }
  
  .dashboard { display: none; min-height: 100vh; position: relative; z-index: 1; }
  
  .header { 
    background: linear-gradient(135deg, var(--main-red) 0%, var(--main-blue) 100%); 
    color: white; 
    padding: 18px; 
    text-align: center; 
    font-size: 18px; 
    position: relative; 
    z-index: 1;
    padding-left: 70px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.2);
  }
  
  .container { 
    display: flex; 
    min-height: calc(100vh - 60px); 
    position: relative; 
  }
  
  .menu-overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.6);
    z-index: 998;
    backdrop-filter: blur(3px);
  }
  .menu-overlay.show { display: block; }
  
  .menu {
    width: 300px;
    background: linear-gradient(180deg, var(--main-red) 0%, #5a0000 50%, var(--main-blue) 100%);
    padding: 15px;
    display: flex;
    flex-direction: column;
    position: fixed;
    top: 0;
    left: 0;
    height: 100%;
    z-index: 999;
    transition: transform 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
    transform: translateX(-100%);
    overflow-y: auto;
    padding-top: 80px;
    box-shadow: 5px 0 25px rgba(0,0,0,0.4);
  }
  
  .menu.show { transform: translateX(0); }
  
  .menu-header {
    color: white;
    text-align: center;
    padding: 15px;
    border-bottom: 2px solid rgba(255,255,255,0.3);
    margin-bottom: 20px;
    background: rgba(255,255,255,0.1);
    border-radius: 10px;
  }
  
  .menu-header h3 { margin: 0; font-size: 22px; color: var(--sub-yellow); }
  .menu-header p { margin: 5px 0 0 0; font-size: 13px; opacity: 0.9; }
  
  .menu button {
    background: rgba(255,255,255,0.15);
    color: white;
    margin-top: 10px;
    font-size: 15px;
    border: 1px solid rgba(255,255,255,0.25);
    border-radius: 8px;
    padding: 14px 15px;
    transition: all 0.3s;
    text-align: left;
    display: flex;
    align-items: center;
    gap: 12px;
  }
  
  .menu button:hover:not(:disabled) { 
    background: rgba(255,255,255,0.3); 
    transform: translateX(8px);
    padding-left: 20px;
  }
  
  .menu button .tab-icon { font-size: 20px; width: 30px; text-align: center; }
  
  .logout { 
    margin-top: auto; 
    background: var(--sub-orange) !important; 
    color: white !important; 
    text-align: center;
    justify-content: center;
  }
  
  .content { 
    flex: 1; 
    padding: 25px; 
    display: flex; 
    flex-direction: column; 
    align-items: center; 
    overflow-y: auto; 
    background: rgba(248,249,250,0.9);
    min-height: calc(100vh - 60px);
  }
  
  .section { 
    background: white; 
    padding: 25px; 
    border-radius: 12px; 
    width: 100%; 
    max-width: 850px; 
    margin-top: 20px; 
    box-shadow: 0 4px 20px rgba(0,0,0,0.1);
    border-left: 5px solid var(--main-blue);
  }
  
  .section h3 {
    color: var(--main-blue);
    border-bottom: 2px solid var(--sub-yellow);
    padding-bottom: 10px;
    margin-top: 0;
  }
  
  /* Report Card Styles - DepEd Format */
  .report-card {
    background: white;
    border: 3px solid var(--main-blue);
    padding: 30px;
    max-width: 800px;
    margin: 0 auto;
    font-family: 'Times New Roman', Times, serif;
  }
  
  .report-card-header {
    text-align: center;
    border-bottom: 3px double var(--main-blue);
    padding-bottom: 20px;
    margin-bottom: 20px;
  }
  
  .report-card-header h2 {
    margin: 0;
    font-size: 24px;
    text-transform: uppercase;
    letter-spacing: 2px;
  }
  
  .report-card-header h3 {
    margin: 10px 0;
    font-size: 18px;
    color: var(--main-blue);
    border: none;
    padding: 0;
  }
  
  .report-card-info {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 15px;
    margin-bottom: 20px;
    font-size: 14px;
  }
  
  .report-card-info p { margin: 5px 0; }
  
  .report-card table {
    width: 100%;
    border-collapse: collapse;
    margin: 20px 0;
    font-size: 13px;
  }
  
  .report-card th, .report-card td {
    border: 1px solid #333;
    padding: 8px;
    text-align: center;
  }
  
  .report-card th {
    background: #f0f0f0;
    font-weight: bold;
    color: #000;
  }
  
  .report-card .descriptor-row {
    font-size: 11px;
    background: #f9f9f9;
  }
  
  .report-card-footer {
    margin-top: 30px;
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 30px;
  }
  
  .signature-line {
    border-top: 1px solid #333;
    margin-top: 40px;
    padding-top: 5px;
    text-align: center;
    font-size: 12px;
  }
  
  /* Transmutation Table */
  .transmutation-table {
    background: #f8f9fa;
    padding: 20px;
    border-radius: 10px;
    margin: 15px 0;
  }
  
  .transmutation-table h4 {
    margin-top: 0;
    color: var(--main-blue);
  }
  
  /* Honor Roll */
  .honor-roll {
    background: linear-gradient(135deg, #ffd700 0%, #ffed4e 100%);
    border: 3px solid #b8860b;
    padding: 20px;
    border-radius: 15px;
    margin: 15px 0;
  }
  
  .honor-roll h4 {
    color: #8b6914;
    margin-top: 0;
    text-align: center;
    font-size: 20px;
  }
  
  .honor-roll-list {
    list-style: none;
    padding: 0;
  }
  
  .honor-roll-list li {
    padding: 10px;
    border-bottom: 1px solid rgba(0,0,0,0.1);
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  
  .honor-badge {
    background: #b8860b;
    color: white;
    padding: 5px 15px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: bold;
  }
  
  /* Messaging System */
  .messaging-container {
    display: grid;
    grid-template-columns: 250px 1fr;
    gap: 20px;
    height: 500px;
  }
  
  .contacts-list {
    background: #f8f9fa;
    border-radius: 10px;
    overflow-y: auto;
    padding: 10px;
  }
  
  .contact-item {
    padding: 12px;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.3s;
    margin-bottom: 8px;
    display: flex;
    align-items: center;
    gap: 10px;
  }
  
  .contact-item:hover, .contact-item.active {
    background: var(--main-blue);
    color: white;
  }
  
  .contact-avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: #ddd;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 20px;
  }
  
  .chat-area {
    display: flex;
    flex-direction: column;
    background: white;
    border-radius: 10px;
    border: 2px solid #dee2e6;
  }
  
  .chat-header {
    padding: 15px;
    border-bottom: 2px solid #dee2e6;
    background: linear-gradient(135deg, var(--main-red) 0%, var(--main-blue) 100%);
    color: white;
    border-radius: 8px 8px 0 0;
  }
  
  .chat-messages {
    flex: 1;
    overflow-y: auto;
    padding: 15px;
    background: #f8f9fa;
  }
  
  .message {
    max-width: 70%;
    padding: 12px;
    border-radius: 15px;
    margin-bottom: 10px;
    position: relative;
    animation: fadeIn 0.3s ease;
  }
  
  .message.sent {
    background: linear-gradient(135deg, var(--main-blue) 0%, #0056b3 100%);
    color: white;
    margin-left: auto;
    border-bottom-right-radius: 5px;
  }
  
  .message.received {
    background: white;
    border: 1px solid #dee2e6;
    margin-right: auto;
    border-bottom-left-radius: 5px;
  }
  
  .message-time {
    font-size: 11px;
    opacity: 0.7;
    margin-top: 5px;
  }
  
  .chat-input-area {
    padding: 15px;
    border-top: 2px solid #dee2e6;
    display: flex;
    gap: 10px;
  }
  
  .chat-input-area input {
    flex: 1;
    margin: 0;
  }
  
  /* Conference Scheduling */
  .conference-slot {
    padding: 15px;
    border: 2px solid #dee2e6;
    border-radius: 10px;
    margin: 10px 0;
    display: flex;
    justify-content: space-between;
    align-items: center;
    transition: all 0.3s;
  }
  
  .conference-slot:hover {
    border-color: var(--main-blue);
    transform: translateX(5px);
  }
  
  .conference-slot.booked {
    background: #f8d7da;
    border-color: #dc3545;
  }
  
  .conference-slot.available {
    background: #d4edda;
    border-color: #28a745;
  }
  
  /* Payment Styles */
  .payment-method {
    padding: 20px;
    border: 2px solid #dee2e6;
    border-radius: 10px;
    margin: 10px 0;
    cursor: pointer;
    transition: all 0.3s;
    display: flex;
    align-items: center;
    gap: 15px;
  }
  
  .payment-method:hover, .payment-method.selected {
    border-color: var(--main-blue);
    background: #f0f8ff;
  }
  
  .payment-icon {
    font-size: 30px;
  }
  
  .payment-history-item {
    padding: 15px;
    border-left: 4px solid var(--main-blue);
    background: #f8f9fa;
    margin: 10px 0;
    border-radius: 0 8px 8px 0;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  
  .payment-status {
    padding: 5px 15px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: bold;
  }
  
  .payment-status.paid {
    background: #d4edda;
    color: #155724;
  }
  
  .payment-status.pending {
    background: #fff3cd;
    color: #856404;
  }
  
  /* Notification Center */
  .notification-bell {
    position: fixed;
    top: 20px;
    right: 20px;
    background: var(--main-red);
    color: white;
    width: 50px;
    height: 50px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 24px;
    cursor: pointer;
    z-index: 999;
    box-shadow: 0 4px 15px rgba(0,0,0,0.3);
    transition: all 0.3s;
  }
  
  .notification-bell:hover {
    transform: scale(1.1);
  }
  
  .notification-badge {
    position: absolute;
    top: -5px;
    right: -5px;
    background: var(--sub-orange);
    color: white;
    width: 25px;
    height: 25px;
    border-radius: 50%;
    font-size: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
  }
  
  .notification-panel {
    position: fixed;
    top: 80px;
    right: 20px;
    width: 350px;
    max-height: 500px;
    background: white;
    border-radius: 12px;
    box-shadow: 0 10px 40px rgba(0,0,0,0.3);
    z-index: 998;
    display: none;
    overflow: hidden;
  }
  
  .notification-panel.show {
    display: block;
  }
  
  .notification-header {
    background: linear-gradient(135deg, var(--main-red) 0%, var(--main-blue) 100%);
    color: white;
    padding: 15px;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  
  .notification-list {
    max-height: 400px;
    overflow-y: auto;
  }
  
  .notification-item {
    padding: 15px;
    border-bottom: 1px solid #eee;
    cursor: pointer;
    transition: all 0.3s;
  }
  
  .notification-item:hover {
    background: #f8f9fa;
  }
  
  .notification-item.unread {
    border-left: 4px solid var(--main-blue);
    background: #f0f8ff;
  }
  
  /* Calendar Styles */
  .calendar-grid {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 5px;
    margin-top: 20px;
  }
  
  .calendar-day {
    aspect-ratio: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    border: 1px solid #dee2e6;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.3s;
    position: relative;
  }
  
  .calendar-day:hover {
    background: #f0f8ff;
    transform: scale(1.05);
  }
  
  .calendar-day.has-event::after {
    content: '';
    position: absolute;
    bottom: 5px;
    width: 6px;
    height: 6px;
    background: var(--main-red);
    border-radius: 50%;
  }
  
  .calendar-day.today {
    background: var(--main-blue);
    color: white;
    font-weight: bold;
  }
  
  /* Analytics Dashboard */
  .analytics-card {
    background: white;
    padding: 20px;
    border-radius: 12px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    text-align: center;
  }
  
  .analytics-number {
    font-size: 36px;
    font-weight: bold;
    color: var(--main-blue);
    margin: 10px 0;
  }
  
  .analytics-label {
    color: var(--main-gray);
    font-size: 14px;
  }
  
  .chart-container {
    background: white;
    padding: 20px;
    border-radius: 12px;
    margin: 20px 0;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
  }
  
  /* Enrollment Form */
  .enrollment-step {
    display: none;
  }
  
  .enrollment-step.active {
    display: block;
  }
  
  .step-indicator {
    display: flex;
    justify-content: space-between;
    margin-bottom: 30px;
  }
  
  .step {
    flex: 1;
    text-align: center;
    padding: 10px;
    border-bottom: 3px solid #dee2e6;
    color: var(--main-gray);
  }
  
  .step.active {
    border-color: var(--main-blue);
    color: var(--main-blue);
    font-weight: bold;
  }
  
  .step.completed {
    border-color: var(--success-green);
    color: var(--success-green);
  }
  
  /* Behavioral Report */
  .behavior-item {
    display: flex;
    align-items: center;
    padding: 15px;
    border-left: 4px solid;
    margin: 10px 0;
    background: #f8f9fa;
    border-radius: 0 8px 8px 0;
  }
  
  .behavior-item.merit {
    border-color: var(--success-green);
  }
  
  .behavior-item.demerit {
    border-color: var(--danger-red);
  }
  
  .behavior-points {
    font-size: 24px;
    font-weight: bold;
    margin-right: 20px;
  }
  
  .behavior-item.merit .behavior-points {
    color: var(--success-green);
  }
  
  .behavior-item.demerit .behavior-points {
    color: var(--danger-red);
  }
  
  /* Assignment Submission */
  .assignment-card {
    padding: 20px;
    border: 2px solid #dee2e6;
    border-radius: 12px;
    margin: 15px 0;
    transition: all 0.3s;
  }
  
  .assignment-card:hover {
    border-color: var(--main-blue);
  }
  
  .assignment-status {
    display: inline-block;
    padding: 5px 15px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: bold;
    margin-top: 10px;
  }
  
  .assignment-status.pending {
    background: #fff3cd;
    color: #856404;
  }
  
  .assignment-status.submitted {
    background: #d4edda;
    color: #155724;
  }
  
  .assignment-status.graded {
    background: #cce5ff;
    color: #004085;
  }
  
  .assignment-status.late {
    background: #f8d7da;
    color: #721c24;
  }
  
  /* File Upload Zone */
  .upload-zone {
    border: 3px dashed #dee2e6;
    border-radius: 12px;
    padding: 40px;
    text-align: center;
    transition: all 0.3s;
    cursor: pointer;
  }
  
  .upload-zone:hover, .upload-zone.dragover {
    border-color: var(--main-blue);
    background: #f0f8ff;
  }
  
  .upload-zone i {
    font-size: 48px;
    color: var(--main-gray);
    margin-bottom: 15px;
  }
  
  /* Quiz/Exam Styles */
  .quiz-timer {
    position: fixed;
    top: 80px;
    right: 20px;
    background: var(--danger-red);
    color: white;
    padding: 15px 25px;
    border-radius: 10px;
    font-size: 24px;
    font-weight: bold;
    z-index: 100;
    box-shadow: 0 4px 15px rgba(0,0,0,0.3);
  }
  
  .quiz-question {
    background: white;
    padding: 25px;
    border-radius: 12px;
    margin: 20px 0;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
  }
  
  .quiz-options {
    display: grid;
    gap: 10px;
    margin-top: 20px;
  }
  
  .quiz-option {
    padding: 15px;
    border: 2px solid #dee2e6;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.3s;
  }
  
  .quiz-option:hover {
    border-color: var(--main-blue);
    background: #f0f8ff;
  }
  
  .quiz-option.selected {
    border-color: var(--main-blue);
    background: var(--main-blue);
    color: white;
  }
  
  /* Settings Panel */
  .settings-section {
    padding: 20px;
    border-bottom: 1px solid #dee2e6;
  }
  
  .settings-section:last-child {
    border-bottom: none;
  }
  
  .toggle-switch {
    position: relative;
    display: inline-block;
    width: 60px;
    height: 34px;
  }
  
  .toggle-switch input {
    opacity: 0;
    width: 0;
    height: 0;
  }
  
  .slider {
    position: absolute;
    cursor: pointer;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: #ccc;
    transition: .4s;
    border-radius: 34px;
  }
  
  .slider:before {
    position: absolute;
    content: "";
    height: 26px;
    width: 26px;
    left: 4px;
    bottom: 4px;
    background-color: white;
    transition: .4s;
    border-radius: 50%;
  }
  
  input:checked + .slider {
    background-color: var(--main-blue);
  }
  
  input:checked + .slider:before {
    transform: translateX(26px);
  }
  
  /* PWA Install Button */
  .install-pwa-btn {
    position: fixed;
    bottom: 20px;
    right: 20px;
    background: var(--success-green);
    color: white;
    padding: 15px 25px;
    border-radius: 50px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.3);
    z-index: 999;
    display: none;
  }
  
  .install-pwa-btn.show {
    display: block;
  }
  
  /* Loading Spinner */
  .spinner {
    border: 4px solid #f3f3f3;
    border-top: 4px solid var(--main-blue);
    border-radius: 50%;
    width: 40px;
    height: 40px;
    animation: spin 1s linear infinite;
    margin: 20px auto;
  }
  
  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }
  
  /* Accessibility: Focus visible */
  *:focus-visible {
    outline: 3px solid var(--sub-yellow);
    outline-offset: 2px;
  }
  
  /* Screen reader only */
  .sr-only {
    position: absolute;
    width: 1px;
    height: 1px;
    padding: 0;
    margin: -1px;
    overflow: hidden;
    clip: rect(0,0,0,0);
    white-space: nowrap;
    border: 0;
  }
  
  table { 
    border-collapse: collapse; 
    width: 100%; 
    margin-top: 20px; 
    overflow-x: auto;
    display: block;
  }
  
  table, th, td { 
    border: 1px solid #dee2e6; 
    text-align: center; 
    padding: 12px; 
  }
  
  th { 
    background: linear-gradient(135deg, var(--main-red) 0%, var(--main-blue) 100%); 
    color: white; 
    font-weight: bold;
  }
  
  tr:nth-child(even) { background-color: #f8f9fa; }
  tr:hover { background-color: #e9ecef; }
  
  /* Updated Weekly Schedule Styles */
  .weekly-schedule {
    width: 100%;
    overflow-x: auto;
    margin-top: 20px;
  }
  
  .weekly-schedule table {
    width: 100%;
    min-width: 800px;
    border-collapse: collapse;
  }
  
  .weekly-schedule th {
    background: linear-gradient(135deg, var(--main-red) 0%, var(--main-blue) 100%);
    color: white;
    padding: 12px;
    border: 1px solid #dee2e6;
  }
  
  .weekly-schedule td {
    padding: 12px;
    border: 1px solid #dee2e6;
    text-align: center;
    vertical-align: middle;
  }
  
  .weekly-schedule .time-slot {
    font-weight: bold;
    background: #f8f9fa;
  }
  
  .weekly-schedule .recess {
    background: #fff3cd;
    font-style: italic;
  }
  
  .weekly-schedule .lunch {
    background: #d4edda;
    font-weight: bold;
  }
  
  .weekly-schedule tr:hover td {
    background-color: #e9ecef;
  }
  
  .chatbox { 
    border: 2px solid #dee2e6; 
    padding: 15px; 
    height: 320px; 
    width: 100%; 
    overflow-y: auto; 
    margin-top: 12px; 
    border-radius: 8px; 
    background: #fafafa;
  }
  
  .chat-message { 
    margin-bottom: 12px; 
    padding: 12px; 
    border-radius: 8px;
    animation: fadeIn 0.3s ease;
  }
  
  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
  }
  
  .chat-user { 
    background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%); 
    text-align: left; 
    margin-left: 20%;
  }
  .chat-ai { 
    background: linear-gradient(135deg, #f3e5f5 0%, #e1bee7 100%); 
    text-align: left; 
    margin-right: 20%;
  }
  
  .id-card { 
    background: linear-gradient(135deg, var(--main-red) 0%, var(--main-blue) 100%); 
    border: 4px solid var(--sub-yellow); 
    border-radius: 18px; 
    padding: 22px; 
    width: 100%; 
    max-width: 360px; 
    margin: 18px; 
    display: inline-block; 
    vertical-align: top; 
    color: white;
    position: relative;
    box-shadow: 0 10px 30px rgba(0,0,0,0.3);
  }
  
  .id-card-header { 
    background: rgba(255,255,255,0.12); 
    padding: 18px; 
    text-align: center; 
    border-radius: 12px 12px 0 0; 
    margin: -22px -22px 18px -22px; 
    border-bottom: 3px solid var(--sub-yellow);
  }
  
  .id-card-header h3 { 
    margin: 0; 
    font-size: 17px; 
    color: var(--sub-yellow); 
    letter-spacing: 1px;
  }
  
  .id-card-header p { 
    margin: 6px 0 0 0; 
    font-size: 11px; 
    color: #ddd; 
  }
  
  .id-card-photo { 
    width: 110px; 
    height: 110px; 
    background: #eee; 
    border-radius: 50%; 
    margin: 12px auto; 
    display: flex; 
    align-items: center; 
    justify-content: center; 
    overflow: hidden; 
    border: 5px solid var(--sub-yellow);
    box-shadow: 0 4px 15px rgba(0,0,0,0.3);
    font-size: 48px;
    cursor: pointer;
    transition: transform 0.3s;
  }
  
  .id-card-photo:hover {
    transform: scale(1.05);
  }
  
  .id-card-photo img { 
    width: 100%; 
    height: 100%; 
    object-fit: cover; 
  }
  
  .id-card-info { 
    text-align: left; 
    font-size: 14px; 
    background: rgba(0,0,0,0.25); 
    padding: 18px; 
    border-radius: 12px;
  }
  
  .id-card-info p { 
    margin: 10px 0; 
    display: flex;
    justify-content: space-between;
  }
  
  .id-card-info strong { 
    color: var(--sub-yellow); 
  }
  
  .id-card-footer {
    text-align: center;
    margin-top: 18px;
    padding-top: 12px;
    border-top: 1px solid rgba(255,255,255,0.3);
    font-size: 10px;
    color: #ccc;
  }
  
  .id-card-checkbox {
    position: absolute;
    top: 12px;
    right: 12px;
    width: 28px;
    height: 28px;
    cursor: pointer;
    accent-color: var(--sub-yellow);
  }
  
  .attendance-calendar { 
    display: grid; 
    grid-template-columns: repeat(7, 1fr); 
    gap: 6px; 
    margin-top: 18px; 
    overflow-x: auto;
  }
  
  .attendance-day { 
    padding: 14px 10px; 
    text-align: center; 
    border: 2px solid #dee2e6; 
    border-radius: 8px; 
    min-width: 45px;
    cursor: pointer;
    transition: all 0.2s;
    font-weight: bold;
  }
  
  .attendance-day:hover {
    transform: scale(1.1);
    border-color: var(--main-blue);
  }
  
  .attendance-day.present { 
    background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%); 
    border-color: #28a745;
  }
  
  .attendance-day.absent { 
    background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%); 
    border-color: #dc3545;
  }
  
  .attendance-day.header { 
    background: linear-gradient(135deg, var(--main-red) 0%, var(--main-blue) 100%); 
    color: white; 
    font-weight: bold; 
    padding: 12px;
    cursor: default;
  }
  
  .attendance-day.header:hover {
    transform: none;
  }
  
  .subject-item { 
    display: flex;
    align-items: center; 
    padding: 12px; 
    border: 2px solid #dee2e6; 
    margin: 10px 0; 
    border-radius: 8px; 
    flex-wrap: wrap;
    gap: 12px;
    background: #fafafa;
  }
  
  .subject-item:hover {
    border-color: var(--main-blue);
    background: white;
  }
  
  .subject-item input[type="text"] { 
    flex: 1; 
    min-width: 140px; 
    margin: 0; 
  }
  
  .planner-container { 
    max-height: 450px; 
    overflow-y: auto; 
    padding: 18px; 
    border: 2px solid #dee2e6; 
    border-radius: 10px; 
    background: #f8f9fa; 
  }
  
  .planner-section { margin-bottom: 25px; }
  
  .planner-section h4 { 
    background: linear-gradient(135deg, var(--main-red) 0%, var(--main-blue) 100%); 
    color: white; 
    padding: 12px; 
    margin: 0 0 12px 0; 
    border-radius: 8px 8px 0 0; 
    display: flex;
    align-items: center;
    gap: 10px;
  }
  
  .planner-item { 
    display: flex; 
    align-items: center; 
    padding: 12px; 
    border: 2px solid #dee2e6; 
    margin: 8px 0; 
    border-radius: 8px; 
    background: white; 
    flex-wrap: wrap;
    gap: 12px;
    transition: all 0.2s;
  }
  
  .planner-item:hover {
    border-color: var(--main-blue);
  }
  
  .planner-item input[type="checkbox"] { 
    width: auto; 
    margin: 0; 
    width: 22px;
    height: 22px;
    cursor: pointer;
    accent-color: var(--main-blue);
  }
  
  .planner-item.completed { 
    text-decoration: line-through; 
    opacity: 0.6; 
    background: #f0f0f0;
  }
  
  .planner-item .goal-text { 
    flex: 1; 
    min-width: 180px; 
  }
  
  .planner-item .goal-time { 
    font-size: 13px; 
    color: var(--main-gray);
    background: #e9ecef;
    padding: 4px 10px;
    border-radius: 15px;
  }
  
  .planner-item .alarm-btn { 
    width: auto; 
    padding: 8px 14px; 
    font-size: 13px; 
    background: linear-gradient(135deg, var(--main-red) 0%, var(--main-blue) 100%); 
    color: white; 
    border-radius: 20px;
  }
  
  .attendance-legend { 
    position: fixed; 
    bottom: 25px; 
    right: 25px; 
    background: white; 
    padding: 18px; 
    border-radius: 10px; 
    box-shadow: 0 4px 20px rgba(0,0,0,0.25); 
    z-index: 100;
    border: 3px solid var(--main-blue);
    min-width: 180px;
  }
  
  .attendance-legend h4 {
    margin: 0 0 12px 0;
    color: var(--main-blue);
  }
  
  .performance-box {
    background: linear-gradient(135deg, var(--main-red) 0%, var(--main-blue) 100%); 
    color: white;
    padding: 25px;
    border-radius: 12px;
    margin: 20px 0;
    text-align: center;
    box-shadow: 0 6px 20px rgba(0,0,0,0.2);
  }
  
  .performance-box h3 {
    color: var(--sub-yellow);
    margin-top: 0;
  }
  
  .performance-stats { 
    display: flex; 
    justify-content: space-around; 
    margin-top: 20px; 
    flex-wrap: wrap;
    gap: 15px;
  }
  
  .stat-item { 
    text-align: center; 
    background: rgba(255,255,255,0.15);
    padding: 15px 25px;
    border-radius: 10px;
    min-width: 100px;
  }
  
  .stat-number { 
    font-size: 32px; 
    font-weight: bold; 
    color: var(--sub-yellow);
  }
  
  .stat-label { 
    font-size: 13px; 
    opacity: 0.9; 
    margin-top: 5px;
  }
  
  .mood-selector {
    display: flex;
    justify-content: center;
    gap: 18px;
    margin: 25px 0;
    flex-wrap: wrap;
  }
  
  .mood-btn {
    width: 70px;
    height: 70px;
    border-radius: 50%;
    border: 4px solid transparent;
    font-size: 35px;
    cursor: pointer;
    transition: all 0.3s;
    background: white;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
  }
  
  .mood-btn:hover { 
    transform: scale(1.15); 
    border-color: var(--main-blue);
    box-shadow: 0 8px 25px rgba(0,0,0,0.2);
  }
  
  .mood-btn.selected {
    transform: scale(1.2);
    border-color: var(--sub-orange);
    box-shadow: 0 0 25px rgba(253, 126, 20, 0.5);
  }
  
  .parent-account-card {
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    border: 3px solid var(--main-blue);
    border-radius: 12px;
    padding: 20px;
    margin: 15px 0;
  }
  
  .parent-account-card h4 {
    color: var(--main-blue);
    margin-top: 0;
    display: flex;
    align-items: center;
    gap: 10px;
  }
  
  .parent-account-card .credentials {
    background: white;
    padding: 15px;
    border-radius: 8px;
    margin-top: 12px;
    border: 2px dashed var(--main-blue);
  }
  
  .parent-account-card .credentials p {
    margin: 8px 0;
    font-family: 'Courier New', monospace;
    font-weight: bold;
    color: var(--main-blue);
  }
  
  .print-controls {
    background: linear-gradient(135deg, #fff3cd 0%, #ffeeba 100%);
    padding: 18px;
    border-radius: 10px;
    margin-bottom: 20px;
    border: 3px solid var(--sub-yellow);
  }
  
  .print-controls h4 {
    color: var(--main-gray);
    margin-top: 0;
    display: flex;
    align-items: center;
    gap: 10px;
  }
  
  .school-map-container {
    background: #f8f9fa;
    border-radius: 12px;
    padding: 20px;
    margin-top: 15px;
  }
  
  .school-map-container h4 {
    color: var(--main-blue);
    text-align: center;
    margin-top: 0;
  }
  
  .school-map-container img {
    max-width: 100%;
    border-radius: 10px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.2);
  }
  
  .map-legend {
    margin-top: 15px;
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 12px;
  }
  
  .map-legend-item {
    background: white;
    padding: 12px;
    border-radius: 8px;
    border-left: 4px solid var(--main-red);
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  }
  
  .map-legend-item strong {
    color: var(--main-blue);
    display: block;
    margin-bottom: 5px;
  }
  
  .qr-scanner-container {
    background: #000;
    border-radius: 10px;
    overflow: hidden;
    margin: 15px 0;
    max-width: 400px;
  }
  
  #qr-scanner video {
    width: 100%;
    display: block;
  }
  
  .scanner-result {
    padding: 12px;
    border-radius: 8px;
    margin-top: 12px;
    text-align: center;
    font-weight: bold;
  }
  
  .scanner-result.success {
    background: #d4edda;
    color: #155724;
    border: 2px solid #c3e6cb;
  }
  
  .scanner-result.error {
    background: #f8d7da;
    color: #721c24;
    border: 2px solid #f5c6cb;
  }
  
  .sem-selector {
    display: flex;
    gap: 12px;
    margin: 15px 0;
    flex-wrap: wrap;
    justify-content: center;
  }
  
  .sem-btn {
    padding: 12px 24px;
    border: 3px solid var(--main-blue);
    background: white;
    color: var(--main-blue);
    border-radius: 25px;
    font-weight: bold;
    cursor: pointer;
    transition: all 0.3s;
    min-width: 140px;
  }
  
  .sem-btn:hover {
    background: var(--main-blue);
    color: white;
    transform: translateY(-2px);
  }
  
  .sem-btn.active {
    background: linear-gradient(135deg, var(--main-red) 0%, var(--main-blue) 100%);
    color: white;
    border-color: var(--sub-yellow);
  }
  
  .quarter-selector {
    display: flex;
    gap: 10px;
    margin: 15px 0;
    flex-wrap: wrap;
    justify-content: center;
  }
  
  .quarter-btn {
    padding: 10px 20px;
    border: 2px solid var(--main-gray);
    background: white;
    color: var(--main-gray);
    border-radius: 20px;
    font-weight: bold;
    cursor: pointer;
    transition: all 0.3s;
  }
  
  .quarter-btn:hover {
    border-color: var(--main-blue);
    color: var(--main-blue);
  }
  
  .quarter-btn.active {
    background: var(--main-blue);
    color: white;
    border-color: var(--main-blue);
  }
  
  .school-welcome {
    background: linear-gradient(135deg, var(--main-red) 0%, var(--main-blue) 100%);
    color: white;
    padding: 30px;
    border-radius: 15px;
    text-align: center;
    margin-bottom: 25px;
    box-shadow: 0 8px 25px rgba(0,0,0,0.2);
  }
  
  .school-welcome h2 {
    margin: 0 0 10px 0;
    color: var(--sub-yellow);
  }
  
  .school-welcome p {
    margin: 0;
    opacity: 0.95;
  }
  
  /* Admin badge styling */
  .admin-badge {
    background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
    color: #000;
    padding: 2px 8px;
    border-radius: 4px;
    font-size: 11px;
    font-weight: bold;
    margin-left: 5px;
  }
  
  .offline-indicator {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    background: #ffc107;
    color: #333;
    text-align: center;
    padding: 8px;
    z-index: 10001;
    display: none;
    font-weight: bold;
  }
  
  @media (max-width: 768px) {
    .menu { width: 85%; max-width: 340px; }
    .section { padding: 18px; margin-top: 12px; }
    .header { padding-left: 55px; font-size: 15px; }
    .toggle-btn { padding: 10px 14px; font-size: 14px; }
    .logout-btn { right: 70px; padding: 10px 15px; font-size: 12px; }
    .box { padding: 25px; }
    .notification-panel { width: 90%; right: 5%; }
    table { display: block; overflow-x: auto; white-space: nowrap; }
    .id-card { max-width: 100%; margin: 12px 0; }
    .mood-selector { gap: 12px; }
    .mood-btn { width: 60px; height: 60px; font-size: 28px; }
    .messaging-container { grid-template-columns: 1fr; }
    .contacts-list { max-height: 200px; }
    .attendance-legend { position: relative; bottom: auto; right: auto; margin-top: 18px; width: 100%; }
    .weekly-schedule table { font-size: 12px; }
    .weekly-schedule th, .weekly-schedule td { padding: 8px; }
    .stat-number { font-size: 26px; }
    .login-wrapper img { width: 120px; }
  }
  
  @media print {
    .menu, .toggle-btn, .header, .print-controls, .attendance-legend, .menu-overlay,
    .notification-bell, .session-warning, .quiz-timer, .install-pwa-btn, .logout-btn,
    .offline-indicator, #loadingOverlay, body::before {
      display: none !important;
    }
    .id-card { break-inside: avoid; page-break-inside: avoid; border: 3px solid #000; display: inline-block; margin: 10px; }
    .content { padding: 0; }
    .section { box-shadow: none; padding: 10px; border: none; }
    .report-card { border: 2px solid #000; }
  }
  
  /* Modal Styles */
  .modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.7);
    z-index: 10000;
    display: flex;
    justify-content: center;
    align-items: center;
  }
  
  .modal-content {
    background: white;
    padding: 30px;
    border-radius: 15px;
    max-width: 500px;
    width: 90%;
    max-height: 80vh;
    overflow-y: auto;
    box-shadow: 0 20px 60px rgba(0,0,0,0.3);
  }
  
  .modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    padding-bottom: 15px;
    border-bottom: 2px solid #eee;
  }
  
  .modal-close {
    background: none;
    border: none;
    font-size: 24px;
    cursor: pointer;
    color: #666;
    width: auto;
    padding: 0;
  }
  
  .modal-close:hover {
    color: #000;
    transform: none;
    box-shadow: none;
  }
  
  /* Toast Notification */
  .toast {
    position: fixed;
    bottom: 20px;
    left: 50%;
    transform: translateX(-50%);
    background: #333;
    color: white;
    padding: 15px 30px;
    border-radius: 50px;
    z-index: 10001;
    animation: slideUp 0.3s ease;
  }
  
  @keyframes slideUp {
    from { transform: translate(-50%, 100px); opacity: 0; }
    to { transform: translate(-50%, 0); opacity: 1; }
  }
  
  .toast.success { background: #28a745; }
  .toast.error { background: #dc3545; }
  .toast.info { background: #17a2b8; }
</style>

<!-- QRCode.js and HTML5-QRCode -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>
  
  <div id="loadingOverlay">
    <div class="spinner"></div>
    <p>Loading DSHS System...</p>
    <p id="loadingStatus" style="font-size: 12px; opacity: 0.8;">Connecting to Firebase</p>
  </div>

  <div class="offline-indicator" id="offlineIndicator">
    ‚ö†Ô∏è You are offline. Some features may be limited.
  </div>

  <div class="session-warning" id="sessionWarning">
    ‚ö†Ô∏è Your session will expire in <span id="countdown">60</span> seconds. Click anywhere to stay logged in.
  </div>
  
  <div class="notification-bell" id="notificationBell" onclick="toggleNotifications()">
    üîî
    <span class="notification-badge" id="notificationBadge" style="display: none;">0</span>
  </div>
  
  <div class="notification-panel" id="notificationPanel">
    <div class="notification-header">
      <strong>üîî Notifications</strong>
      <button onclick="toggleNotifications()" style="width: auto; padding: 5px 10px; background: white; color: var(--main-blue);">‚úï</button>
    </div>
    <div class="notification-list" id="notificationList"></div>
  </div>
  
  <button class="install-pwa-btn" id="installPwaBtn" onclick="installPWA()">
    üì± Install App
  </button>

<div class="login" id="login">
  <div class="box">
    <h2>üéì DSHS Login</h2>
    <input type="text" id="loginEmail" placeholder="üìß Email or Username">
    <div class="pass-wrapper">
      <input type="password" id="loginPassword" placeholder="üîí Password">
      <span onclick="togglePassword()">üëÅÔ∏è</span>
    </div>
    <p id="loginAttempts" style="color: #dc3545; font-size: 12px; display: none;">‚ö†Ô∏è Failed attempts: <span id="attemptCount">0</span>/5</p>
    <button onclick="login()" style="background: linear-gradient(135deg, var(--main-red) 0%, var(--main-blue) 100%); color: white; padding: 14px; font-size: 16px;">üöÄ Login</button>
    <p id="msg" style="color: #dc3545; margin-top: 10px;"></p>
    <p style="font-size: 13px; margin-top: 12px;">
      <span class="signup-link" onclick="showForgotPassword()">Forgot Password?</span> | 
      <span class="signup-link" onclick="showSignup()">Sign up!</span>
    </p>
    <p style="font-size: 11px; color: #666; margin-top: 15px; padding: 8px; background: #f8f9fa; border-radius: 5px;">
      üîë <strong>Admin Login:</strong> Username: <code>admin</code> | Password: <code>admin</code>
    </p>
  </div>
</div>

<div class="login" id="forgotPassword" style="display:none;">
  <div class="box">
    <h2>üîë Password Recovery</h2>
    <p style="font-size: 13px; color: #666;">Enter your email to receive a password reset link.</p>
    <input type="email" id="recoveryEmail" placeholder="üìß Email">
    <button onclick="sendRecoveryEmail()" style="background: linear-gradient(135deg, var(--main-red) 0%, var(--main-blue) 100%); color: white; padding: 14px; font-size: 16px;">üìß Send Reset Link</button>
    <p id="recoveryMsg" style="margin-top: 10px; font-size: 13px;"></p>
    <p style="font-size: 13px; margin-top: 12px;"><span class="signup-link" onclick="showLogin()">Back to Login</span></p>
  </div>
</div>

<div class="login" id="signup" style="display:none;">
  <div class="box">
    <h2>üìù Student Sign Up</h2>
    <input type="text" id="signupName" placeholder="üë§ Full Name">
    <input type="text" id="signupID" placeholder="üÜî Student I.D">
    <input type="text" id="signupSection" placeholder="üè´ Section">
    <input type="text" id="signupTrack" placeholder="üìö Track">
    <input type="text" id="signupStrand" placeholder="üéØ Strand">
    <input type="text" id="signupGradeLevel" placeholder="üìñ Grade Level">
    <input type="email" id="signupEmail" placeholder="üìß Email">
    <div class="pass-wrapper">
      <input type="password" id="signupPass" placeholder="üîí Password (min 8 chars)" onkeyup="checkPasswordStrength()">
    </div>
    <div class="password-strength" id="signupPasswordStrength"></div>
    <p class="strength-text" id="signupStrengthText"></p>
    <p style="font-size: 11px; color: #666; text-align: left; margin-top: 5px;">
      Password must contain: 8+ characters, uppercase, lowercase, number, special character
    </p>
    <label style="display: flex; align-items: center; gap: 8px; font-size: 12px; margin: 10px 0;">
      <input type="checkbox" id="agreeTerms" style="width: auto;"> I agree to the Terms and Conditions
    </label>
    <button onclick="submitSignup()" id="signupBtn" style="background: linear-gradient(135deg, var(--main-red) 0%, var(--main-blue) 100%); color: white; padding: 14px; font-size: 16px;" disabled>‚úÖ Create Account</button>
    <button onclick="clearSignup()" style="background: var(--main-gray); color: white; margin-top: 10px;">üîÑ Clear</button>
    <p style="font-size: 13px; margin-top: 12px;">Already have an account? <span class="signup-link" onclick="showLogin()">Login</span></p>
  </div>
</div>

<div class="dashboard" id="dashboard">
  <button class="toggle-btn" id="toggleBtn" onclick="toggleMenu()">
    <span class="icon">‚ò∞</span>
    <span class="text">Menu</span>
  </button>
  
  <button class="logout-btn" id="headerLogoutBtn" onclick="logout()">
    <span>üö™</span>
    <span>Logout</span>
  </button>
  
  <div class="menu-overlay" id="menuOverlay" onclick="toggleMenu()"></div>
  <div class="header" id="roleTitle"></div>
  <div class="container">
    <div class="menu" id="menu"></div>
    <div class="content" id="content">
      <div class="school-welcome">
        <h2>üè´ Dumingag Senior High School</h2>
        <p>Welcome to the DSHS School System</p>
      </div>
      <div class="section"><h3>üëã Welcome</h3><p>Select an option from the menu to get started.</p></div>
    </div>
  </div>
</div>

<script>
  //====== GLOBAL VARIABLES ======
  let role = "", currentUser = "", currentUserId = "", currentUserData = null;
  let loginAttempts = 0;
  const MAX_LOGIN_ATTEMPTS = 5;
  let lockoutTimer = null;
  let sessionTimer = null;
  let sessionWarningTimer = null;
  const SESSION_TIMEOUT = 30 * 60 * 1000;
  const WARNING_BEFORE = 60 * 1000;
  let db, auth, storage;
  let unsubscribers = [];
  let html5QrCodeScanner = null;
  let currentContact = null;
  let currentSemester = 1;
  let currentQuarter = 1;
  let selectedPaymentMethod = null;
  let currentQuiz = null;
  let quizTimer = null;
  let selectedAnswers = {};
  
  // HARDCODED ADMIN CREDENTIALS
  const HARDCODED_ADMIN = {
    username: "admin",
    password: "admin",
    name: "System Administrator",
    email: "admin@dshs.edu",
    role: "admin"
  };
  
  // Weekly Schedule Configuration
  const WEEKLY_SCHEDULE = {
    periods: [
      { name: "1st Period", time: "7:45-8:45" },
      { name: "2nd Period", time: "8:45-9:45" },
      { name: "Recess", time: "9:45-10:00", type: "break" },
      { name: "3rd Period", time: "10:00-11:00" },
      { name: "4th Period", time: "11:00-12:00" },
      { name: "Lunch", time: "12:00-1:00", type: "break" },
      { name: "5th Period", time: "1:00-2:00" },
      { name: "6th Period", time: "2:00-3:00" },
      { name: "7th Period", time: "3:00-4:00" }
    ],
    days: ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday"]
  };
  
  //====== INITIALIZATION ======
  document.addEventListener('DOMContentLoaded', async function() {
    let attempts = 0;
    const maxAttempts = 50;
    
    while(!window.firebaseApp && attempts < maxAttempts) {
      await new Promise(r => setTimeout(r, 100));
      attempts++;
    }
    
    if(!window.firebaseApp) {
      console.error('Firebase failed to initialize');
      document.getElementById('loadingStatus').textContent = 'Failed to connect to Firebase';
      return;
    }
    
    db = window.firebaseDB;
    auth = window.firebaseAuth;
    storage = window.firebaseStorage;
    
    document.getElementById('loadingStatus').textContent = 'Checking authentication...';
    
    window.firebaseFns.onAuthStateChanged(auth, async (user) => {
      try {
        if(user) {
          currentUserId = user.uid;
          await loadUserData(user.uid);
        }
        
        document.getElementById('loadingOverlay').style.opacity = '0';
        setTimeout(() => {
          document.getElementById('loadingOverlay').style.display = 'none';
        }, 500);
      } catch(error) {
        console.error('Auth state error:', error);
        document.getElementById('loadingOverlay').style.display = 'none';
      }
    });
    
    window.addEventListener('online', () => {
      document.getElementById('offlineIndicator').style.display = 'none';
    });
    
    window.addEventListener('offline', () => {
      document.getElementById('offlineIndicator').style.display = 'block';
    });
    
    setupPWA();
    
    const termsCheckbox = document.getElementById('agreeTerms');
    if(termsCheckbox) {
      termsCheckbox.addEventListener('change', checkPasswordStrength);
    }
  });
  
  //====== ANALYTICS SYNC FUNCTIONS ======
  async function updateAnalytics() {
    try {
      const allUsers = await getCollectionData('users');
      const students = allUsers.filter(u => u.role === 'student');
      const teachers = allUsers.filter(u => u.role === 'teacher');
      const parents = allUsers.filter(u => u.role === 'parent');
      const pending = students.filter(s => !s.approved).length;
      
      const trackData = {};
      students.forEach(s => {
        trackData[s.track] = (trackData[s.track] || 0) + 1;
      });
      
      const analyticsData = {
        totalStudents: students.length,
        totalTeachers: teachers.length,
        totalParents: parents.length,
        pendingApprovals: pending,
        trackDistribution: trackData,
        lastUpdated: window.firebaseFns.serverTimestamp()
      };
      
      await window.firebaseFns.setDoc(
        window.firebaseFns.doc(db, 'analytics', 'dashboard'),
        analyticsData,
        { merge: true }
      );
      
      console.log('Analytics updated successfully');
    } catch(error) {
      console.error('Error updating analytics:', error);
    }
  }
  
  async function subscribeToAnalytics(callback) {
    try {
      const unsubscribe = window.firebaseFns.onSnapshot(
        window.firebaseFns.doc(db, 'analytics', 'dashboard'),
        (doc) => {
          if(doc.exists()) {
            callback(doc.data());
          }
        },
        (error) => {
          console.error('Analytics subscription error:', error);
        }
      );
      unsubscribers.push(unsubscribe);
      return unsubscribe;
    } catch(error) {
      console.error('Subscribe analytics error:', error);
    }
  }
  
  //====== FIREBASE DATA FUNCTIONS ======
  async function loadUserData(uid) {
    try {
      const userDoc = await window.firebaseFns.getDoc(window.firebaseFns.doc(db, 'users', uid));
      if(userDoc.exists()) {
        currentUserData = userDoc.data();
        role = currentUserData.role;
        currentUser = currentUserData.name || currentUserData.email;
        
        document.getElementById('login').style.display = 'none';
        document.getElementById('signup').style.display = 'none';
        document.getElementById('dashboard').style.display = 'block';
        
        if(role === 'student' && currentUserData.approved && currentUserData.section) {
          await syncStudentWithTeacher();
        }
        
        loadDashboard();
        startSessionTimer();
        addNotification('Welcome back, ' + currentUser + '!', 'system');
      } else {
        console.error('User document not found');
        showError('User data not found');
      }
    } catch(error) {
      console.error('Error loading user data:', error);
      showError('Error loading user data');
    }
  }
  
  // Sync student with teacher based on section
  async function syncStudentWithTeacher() {
    try {
      const teachersQuery = window.firebaseFns.query(
        window.firebaseFns.collection(db, 'users'),
        window.firebaseFns.where('role', '==', 'teacher'),
        window.firebaseFns.where('sectionHandled', '==', currentUserData.section)
      );
      
      const teacherSnapshot = await window.firebaseFns.getDocs(teachersQuery);
      
      if(!teacherSnapshot.empty) {
        const teacher = teacherSnapshot.docs[0];
        const teacherData = teacher.data();
        
        await window.firebaseFns.setDoc(
          window.firebaseFns.doc(db, 'users', currentUserId),
          {
            teacherId: teacher.id,
            teacherName: teacherData.name,
            teacherEmail: teacherData.email,
            syncedAt: window.firebaseFns.serverTimestamp()
          },
          { merge: true }
        );
        
        const teacherStudentsRef = window.firebaseFns.doc(db, 'teacherStudents', teacher.id);
        const teacherStudentsDoc = await window.firebaseFns.getDoc(teacherStudentsRef);
        
        if(teacherStudentsDoc.exists()) {
          const data = teacherStudentsDoc.data();
          const students = data.students || [];
          if(!students.find(s => s.id === currentUserId)) {
            students.push({
              id: currentUserId,
              name: currentUserData.name,
              studentId: currentUserData.studentId,
              section: currentUserData.section,
              gradeLevel: currentUserData.gradeLevel,
              addedAt: new Date().toISOString()
            });
            await window.firebaseFns.setDoc(teacherStudentsRef, { students }, { merge: true });
          }
        } else {
          await window.firebaseFns.setDoc(teacherStudentsRef, {
            students: [{
              id: currentUserId,
              name: currentUserData.name,
              studentId: currentUserData.studentId,
              section: currentUserData.section,
              gradeLevel: currentUserData.gradeLevel,
              addedAt: new Date().toISOString()
            }]
          });
        }
        
        console.log('Student synced with teacher:', teacherData.name);
      }
    } catch(error) {
      console.error('Error syncing student with teacher:', error);
    }
  }
  
  async function getCollectionData(collectionName, constraints = []) {
    try {
      const q = window.firebaseFns.query(
        window.firebaseFns.collection(db, collectionName),
        ...constraints
      );
      const snapshot = await window.firebaseFns.getDocs(q);
      return snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
    } catch(error) {
      console.error('Error getting collection:', error);
      return [];
    }
  }
  
  async function setDocument(collectionName, docId, data) {
    try {
      await window.firebaseFns.setDoc(
        window.firebaseFns.doc(db, collectionName, docId),
        { ...data, updatedAt: window.firebaseFns.serverTimestamp() },
        { merge: true }
      );
      return true;
    } catch(error) {
      console.error('Error setting document:', error);
      showError('Failed to save data');
      return false;
    }
  }
  
  async function addDocument(collectionName, data) {
    try {
      const docRef = await window.firebaseFns.addDoc(
        window.firebaseFns.collection(db, collectionName),
        { ...data, createdAt: window.firebaseFns.serverTimestamp(), updatedAt: window.firebaseFns.serverTimestamp() }
      );
      return docRef.id;
    } catch(error) {
      console.error('Error adding document:', error);
      showError('Failed to add data');
      return null;
    }
  }
  
  function subscribeToCollection(collectionName, callback, constraints = []) {
    try {
      const q = window.firebaseFns.query(
        window.firebaseFns.collection(db, collectionName),
        ...constraints
      );
      const unsubscribe = window.firebaseFns.onSnapshot(q, (snapshot) => {
        const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        callback(data);
      }, (error) => {
        console.error('Subscription error:', error);
      });
      unsubscribers.push(unsubscribe);
      return unsubscribe;
    } catch(error) {
      console.error('Subscribe collection error:', error);
    }
  }
  
  //====== AUTHENTICATION FUNCTIONS ======
  async function login() {
    const email = document.getElementById("loginEmail").value.trim();
    const password = document.getElementById("loginPassword").value;
    
    if(!email || !password) {
      showError("Please enter email/username and password");
      return;
    }
    
    if(email === HARDCODED_ADMIN.username && password === HARDCODED_ADMIN.password) {
      document.getElementById('loadingOverlay').style.display = 'flex';
      document.getElementById('loadingStatus').textContent = 'Logging in as Admin...';
      
      role = HARDCODED_ADMIN.role;
      currentUser = HARDCODED_ADMIN.name;
      currentUserId = "HARDCODED_ADMIN_" + Date.now();
      currentUserData = {
        name: HARDCODED_ADMIN.name,
        email: HARDCODED_ADMIN.email,
        role: HARDCODED_ADMIN.role,
        uid: currentUserId
      };
      
      setTimeout(() => {
        document.getElementById('login').style.display = 'none';
        document.getElementById('signup').style.display = 'none';
        document.getElementById('dashboard').style.display = 'block';
        document.getElementById('loadingOverlay').style.display = 'none';
        
        loadDashboard();
        startSessionTimer();
        addNotification('Welcome back, Administrator!', 'system');
      }, 500);
      
      return;
    }
    
    if(loginAttempts >= MAX_LOGIN_ATTEMPTS) {
      showError("Account temporarily locked. Please try again later.");
      return;
    }
    
    try {
      document.getElementById('loadingOverlay').style.display = 'flex';
      document.getElementById('loadingStatus').textContent = 'Authenticating...';
      
      const userCredential = await window.firebaseFns.signInWithEmailAndPassword(auth, email, password);
      resetLoginAttempts();
      
    } catch(error) {
      document.getElementById('loadingOverlay').style.display = 'none';
      console.error('Login error:', error);
      recordFailedLogin();
      
      let errorMsg = "Login failed";
      switch(error.code) {
        case 'auth/user-not-found':
          errorMsg = "User not found";
          break;
        case 'auth/wrong-password':
          errorMsg = "Invalid password";
          break;
        case 'auth/invalid-email':
          errorMsg = "Invalid email format";
          break;
        case 'auth/user-disabled':
          errorMsg = "Account disabled";
          break;
        case 'auth/invalid-credential':
          errorMsg = "Invalid email or password";
          break;
      }
      showError(errorMsg);
    }
  }
  
  async function submitSignup() {
    const name = document.getElementById("signupName").value.trim();
    const id = document.getElementById("signupID").value.trim();
    const section = document.getElementById("signupSection").value.trim();
    const track = document.getElementById("signupTrack").value.trim();
    const strand = document.getElementById("signupStrand").value.trim();
    const gradeLevel = document.getElementById("signupGradeLevel").value.trim();
    const email = document.getElementById("signupEmail").value.trim();
    const password = document.getElementById("signupPass").value;
    
    if(!name || !id || !section || !track || !strand || !gradeLevel || !email || !password) {
      showError("All fields required!");
      return;
    }
    
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    if(!emailRegex.test(email)) {
      showError("Please enter a valid email address");
      return;
    }
    
    try {
      document.getElementById('loadingOverlay').style.display = 'flex';
      document.getElementById('loadingStatus').textContent = 'Creating account...';
      
      // Create student account
      const userCredential = await window.firebaseFns.createUserWithEmailAndPassword(auth, email, password);
      const uid = userCredential.user.uid;
      
      await window.firebaseFns.setDoc(window.firebaseFns.doc(db, 'users', uid), {
        uid,
        name,
        studentId: id,
        section,
        track,
        strand,
        gradeLevel,
        email,
        role: 'student',
        approved: false,
        createdAt: window.firebaseFns.serverTimestamp()
      });
      
      await updateAnalytics();
      
      // Create parent account with auto-generated password
      const parentPassword = Math.random().toString(36).slice(-8);
      const parentEmail = `parent_${email.replace(/[@.]/g, '_')}@dshs.edu`;
      
      const parentCredential = await window.firebaseFns.createUserWithEmailAndPassword(auth, parentEmail, parentPassword);
      await window.firebaseFns.setDoc(window.firebaseFns.doc(db, 'users', parentCredential.user.uid), {
        uid: parentCredential.user.uid,
        name: `Parent of ${name}`,
        childName: name,
        childId: id,
        childSection: section,
        email: parentEmail,
        role: 'parent',
        approved: true,
        createdAt: window.firebaseFns.serverTimestamp()
      });
      
      await updateAnalytics();
      
      await window.firebaseFns.setDoc(window.firebaseFns.doc(db, 'parentAccounts', parentCredential.user.uid), {
        studentName: name,
        studentId: id,
        section: section,
        parentEmail: parentEmail,
        parentPassword: parentPassword,
        createdAt: window.firebaseFns.serverTimestamp()
      });
      
      await window.firebaseFns.signOut(auth);
      document.getElementById('loadingOverlay').style.display = 'none';
      
      // Show parent credentials notification
      showParentCredentialsNotification(name, parentEmail, parentPassword);
      
      clearSignup();
      showLogin();
      
    } catch(error) {
      document.getElementById('loadingOverlay').style.display = 'none';
      console.error('Signup error:', error);
      
      let errorMsg = "Signup failed";
      if(error.code === 'auth/email-already-in-use') {
        errorMsg = "Email already registered";
      } else if(error.code === 'auth/weak-password') {
        errorMsg = "Password is too weak";
      } else if(error.code === 'auth/invalid-email') {
        errorMsg = "Invalid email address";
      } else if(error.message) {
        errorMsg = error.message;
      }
      showError(errorMsg);
    }
  }
  
  function showParentCredentialsNotification(studentName, parentEmail, parentPassword) {
    const modal = document.createElement('div');
    modal.className = 'modal-overlay';
    modal.innerHTML = `
      <div class="modal-content">
        <div class="modal-header">
          <h3>üéâ Account Created Successfully!</h3>
          <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">√ó</button>
        </div>
        <div style="background: #d4edda; padding: 15px; border-radius: 10px; margin-bottom: 20px;">
          <p><strong>‚úÖ Your student account is pending approval.</strong></p>
          <p style="font-size: 14px; margin-top: 10px;">Please wait for admin approval before logging in.</p>
        </div>
        
        <div style="background: #fff3cd; padding: 20px; border-radius: 10px; border: 2px dashed var(--main-blue);">
          <h4 style="color: var(--main-blue); margin-top: 0;">üë®‚Äçüë©‚Äçüëß Parent Account Credentials</h4>
          <p style="font-size: 14px; margin-bottom: 15px;">Share these credentials with your parent/guardian:</p>
          
          <div style="background: white; padding: 15px; border-radius: 8px; font-family: monospace;">
            <p style="margin: 5px 0;"><strong>Student:</strong> ${studentName}</p>
            <p style="margin: 5px 0;"><strong>Parent Email:</strong> ${parentEmail}</p>
            <p style="margin: 5px 0;"><strong>Parent Password:</strong> ${parentPassword}</p>
          </div>
          
          <button onclick="copyParentCredentials('${parentEmail}', '${parentPassword}')" 
                  style="background: var(--main-blue); color: white; margin-top: 15px; width: auto; padding: 10px 20px;">
            üìã Copy Credentials
          </button>
        </div>
        
        <p style="font-size: 12px; color: #666; margin-top: 15px; text-align: center;">
          ‚ö†Ô∏è Please save these credentials. They will not be shown again.
        </p>
      </div>
    `;
    document.body.appendChild(modal);
  }
  
  function copyParentCredentials(email, password) {
    const text = `DSHS Parent Account\nEmail: ${email}\nPassword: ${password}`;
    navigator.clipboard.writeText(text).then(() => {
      showToast('Credentials copied to clipboard!', 'success');
    });
  }
  
  function showToast(message, type = 'info') {
    const existing = document.querySelector('.toast');
    if(existing) existing.remove();
    
    const toast = document.createElement('div');
    toast.className = `toast ${type}`;
    toast.textContent = message;
    document.body.appendChild(toast);
    
    setTimeout(() => toast.remove(), 3000);
  }
  
  async function sendRecoveryEmail() {
    const email = document.getElementById("recoveryEmail").value.trim();
    if(!email) {
      showError("Please enter your email");
      return;
    }
    
    try {
      await window.firebaseFns.sendPasswordResetEmail(auth, email);
      document.getElementById("recoveryMsg").style.color = "green";
      document.getElementById("recoveryMsg").textContent = "‚úÖ Password reset email sent! Check your inbox.";
    } catch(error) {
      document.getElementById("recoveryMsg").style.color = "red";
      document.getElementById("recoveryMsg").textContent = "‚ùå " + error.message;
    }
  }
  
  async function logout() {
    unsubscribers.forEach(unsub => {
      try {
        unsub();
      } catch(e) {
        console.error('Error unsubscribing:', e);
      }
    });
    unsubscribers = [];
    
    if(html5QrCodeScanner) {
      try {
        await html5QrCodeScanner.stop();
        html5QrCodeScanner = null;
      } catch(e) {
        console.error('Error stopping scanner:', e);
      }
    }
    
    if(currentUserId && currentUserId.startsWith("HARDCODED_ADMIN_")) {
      role = "";
      currentUser = "";
      currentUserId = "";
      currentUserData = null;
      
      document.getElementById("dashboard").style.display = "none";
      document.getElementById("login").style.display = "flex";
      document.getElementById("menu").classList.remove("show");
      document.getElementById("menuOverlay").classList.remove("show");
      
      if(sessionTimer) clearTimeout(sessionTimer);
      if(sessionWarningTimer) clearTimeout(sessionWarningTimer);
      document.getElementById('sessionWarning').style.display = 'none';
      return;
    }
    
    try {
      await window.firebaseFns.signOut(auth);
    } catch(error) {
      console.error('Logout error:', error);
    }
    
    role = "";
    currentUser = "";
    currentUserId = "";
    currentUserData = null;
    
    document.getElementById("dashboard").style.display = "none";
    document.getElementById("login").style.display = "flex";
    document.getElementById("menu").classList.remove("show");
    document.getElementById("menuOverlay").classList.remove("show");
    
    if(sessionTimer) clearTimeout(sessionTimer);
    if(sessionWarningTimer) clearTimeout(sessionWarningTimer);
    document.getElementById('sessionWarning').style.display = 'none';
  }
  
  //====== UI FUNCTIONS ======
  function toggleMenu() {
    const menu = document.getElementById("menu");
    const overlay = document.getElementById("menuOverlay");
    const toggleBtn = document.getElementById("toggleBtn");
    
    menu.classList.toggle("show");
    overlay.classList.toggle("show");
    toggleBtn.classList.toggle("small", menu.classList.contains("show"));
  }
  
  function togglePassword() {
    const p = document.getElementById("loginPassword");
    p.type = (p.type === "password") ? "text" : "password";
  }
  
  function showSignup() {
    document.getElementById("login").style.display = "none";
    document.getElementById("signup").style.display = "flex";
  }
  
  function showLogin() {
    document.getElementById("signup").style.display = "none";
    document.getElementById("forgotPassword").style.display = "none";
    document.getElementById("login").style.display = "flex";
  }
  
  function showForgotPassword() {
    document.getElementById("login").style.display = "none";
    document.getElementById("forgotPassword").style.display = "flex";
  }
  
  function clearSignup() {
    ["signupName","signupID","signupSection","signupTrack","signupStrand","signupGradeLevel","signupEmail","signupPass"].forEach(function(id) {
      document.getElementById(id).value = "";
    });
    document.getElementById('signupPasswordStrength').className = 'password-strength';
    document.getElementById('signupStrengthText').textContent = '';
    document.getElementById('agreeTerms').checked = false;
    document.getElementById('signupBtn').disabled = true;
  }
  
  function checkPasswordStrength() {
    const password = document.getElementById('signupPass').value;
    const strengthBar = document.getElementById('signupPasswordStrength');
    const strengthText = document.getElementById('signupStrengthText');
    const signupBtn = document.getElementById('signupBtn');
    
    let strength = 0;
    if(password.length >= 8) strength++;
    if(password.match(/[a-z]+/)) strength++;
    if(password.match(/[A-Z]+/)) strength++;
    if(password.match(/[0-9]+/)) strength++;
    if(password.match(/[$@#&!]+/)) strength++;
    
    strengthBar.className = 'password-strength';
    
    if(strength <= 2) {
      strengthBar.classList.add('weak');
      strengthText.textContent = 'Weak - Add more character types';
      strengthText.style.color = '#dc3545';
    } else if(strength === 3 || strength === 4) {
      strengthBar.classList.add('medium');
      strengthText.textContent = 'Medium - Good but could be stronger';
      strengthText.style.color = '#ffc107';
    } else {
      strengthBar.classList.add('strong');
      strengthText.textContent = 'Strong - Excellent password!';
      strengthText.style.color = '#28a745';
    }
    
    const termsAgreed = document.getElementById('agreeTerms').checked;
    signupBtn.disabled = strength < 3 || !termsAgreed;
  }
  
  //====== DASHBOARD FUNCTIONS ======
  function loadDashboard() {
    const isHardcodedAdmin = currentUserId && currentUserId.startsWith("HARDCODED_ADMIN_");
    const displayRole = isHardcodedAdmin ? "ADMIN (HARDCODED)" : role.toUpperCase();
    document.getElementById("roleTitle").innerHTML = displayRole + " DASHBOARD" + (isHardcodedAdmin ? ' <span class="admin-badge">HARDCODED</span>' : '');
    
    const menu = document.getElementById("menu");
    menu.innerHTML = "";
    
    let items = [];
    
    if(role === "teacher") {
      items = [
        {name: "Attendance", icon: "üìÖ"},
        {name: "Subject Schedule", icon: "üìö"},
        {name: "My Info", icon: "üë§"},
        {name: "Bulletin Board", icon: "üì¢"},
        {name: "Grades", icon: "üìä"},
        {name: "Report Cards", icon: "üìã"},
        {name: "Assignments", icon: "üìù"},
        {name: "Quizzes", icon: "‚ùì"},
        {name: "Course Materials", icon: "üìñ"},
        {name: "Messages", icon: "üí¨"},
        {name: "Conference Schedule", icon: "üìÖ"},
        {name: "Behavior Reports", icon: "üìã"},
        {name: "My Planner", icon: "üóìÔ∏è"},
        {name: "Emergency Numbers", icon: "üö®"},
        {name: "School Map", icon: "üó∫Ô∏è"},
        {name: "Settings", icon: "‚öôÔ∏è"}
      ];
    }
    else if(role === "student") {
      items = [
        {name: "Attendance", icon: "üìÖ"},
        {name: "Subject Schedule", icon: "üìö"},
        {name: "My Info", icon: "üë§"},
        {name: "Bulletin Board", icon: "üì¢"},
        {name: "Grades", icon: "üìä"},
        {name: "Transcript", icon: "üìú"},
        {name: "Assignments", icon: "üìù"},
        {name: "Quizzes", icon: "‚ùì"},
        {name: "Course Materials", icon: "üìñ"},
        {name: "QR Code", icon: "üî≥"},
        {name: "Messages", icon: "üí¨"},
        {name: "My Mood", icon: "üòä"},
        {name: "Honor Roll", icon: "üèÜ"},
        {name: "Payments", icon: "üí≥"},
        {name: "Emergency Numbers", icon: "üö®"},
        {name: "School Map", icon: "üó∫Ô∏è"},
        {name: "Settings", icon: "‚öôÔ∏è"}
      ];
    }
    else if(role === "parent") {
      items = [
        {name: "Child Attendance", icon: "üìÖ"},
        {name: "Child Grades", icon: "üìä"},
        {name: "Child Schedule", icon: "üìö"},
        {name: "My Info", icon: "üë§"},
        {name: "Bulletin Board", icon: "üì¢"},
        {name: "Messages", icon: "üí¨"},
        {name: "Conference Booking", icon: "üìÖ"},
        {name: "Progress Reports", icon: "üìà"},
        {name: "Behavior Reports", icon: "üìã"},
        {name: "Payments", icon: "üí≥"},
        {name: "Permission Slips", icon: "üìù"},
        {name: "Emergency Numbers", icon: "üö®"},
        {name: "School Map", icon: "üó∫Ô∏è"},
        {name: "Settings", icon: "‚öôÔ∏è"}
      ];
    }
    else if(role === "admin") {
      items = [
        {name: "Student Approval", icon: "‚úÖ"},
        {name: "Create Teacher", icon: "üë®‚Äçüè´"},
        {name: "All Students", icon: "üë®‚Äçüéì"},
        {name: "Parent Accounts", icon: "üë™"},
        {name: "Manage Users", icon: "‚öôÔ∏è"},
        {name: "Enrollment", icon: "üìù"},
        {name: "Class Scheduling", icon: "üìÖ"},
        {name: "Honor Roll", icon: "üèÜ"},
        {name: "Analytics", icon: "üìä"},
        {name: "Bulletin Board", icon: "üì¢"},
        {name: "Emergency Numbers", icon: "üö®"},
        {name: "School Map", icon: "üó∫Ô∏è"},
        {name: "Settings", icon: "‚öôÔ∏è"}
      ];
    }

    menu.innerHTML = '<div class="menu-header"><h3>üéì DSHS Menu</h3><p>üë§ ' + currentUser + (isHardcodedAdmin ? ' <span class="admin-badge">ADMIN</span>' : '') + '</p></div>';
    
    items.forEach(function(item) {
      const btn = document.createElement("button");
      btn.innerHTML = '<span class="tab-icon">' + item.icon + '</span> ' + item.name;
      btn.onclick = function() {
        toggleMenu();
        loadSection(item.name);
      };
      menu.appendChild(btn);
    });

    const logoutBtn = document.createElement("button");
    logoutBtn.innerHTML = '<span class="tab-icon">üö™</span> Logout';
    logoutBtn.className = "logout";
    logoutBtn.onclick = function() {
      toggleMenu();
      logout();
    };
    menu.appendChild(logoutBtn);
    
    updateNotificationBadge();
  }
  
  //====== SECTION LOADING FUNCTIONS ======
  async function loadSection(tab) {
    const content = document.getElementById("content");
    content.innerHTML = "";
    const section = document.createElement("div");
    section.className = "section";

    //------ ATTENDANCE ------
    if(tab === "Attendance" || tab === "Child Attendance") {
      section.innerHTML = "<h3>üìÖ Attendance</h3>";
      
      let studentName = currentUser;
      if(role === "teacher") {
        const students = await getCollectionData('users', [
          window.firebaseFns.where('role', '==', 'student'),
          window.firebaseFns.where('approved', '==', true)
        ]);
        
        const teacherSection = currentUserData.sectionHandled;
        const sectionStudents = students.filter(s => s.section === teacherSection);
        
        const selectStudent = document.createElement("select");
        selectStudent.id = "attendanceStudentSelect";
        sectionStudents.forEach(function(s){
          const opt = document.createElement("option");
          opt.value = s.name;
          opt.innerText = s.name;
          selectStudent.appendChild(opt);
        });
        section.appendChild(selectStudent);
        if(sectionStudents.length > 0) studentName = sectionStudents[0].name;
        
        selectStudent.onchange = function() {
          studentName = this.value;
          renderAttendanceCalendar(section, studentName);
        };
      } else if(role === "parent") {
        studentName = currentUserData.childName || currentUser;
      }
      
      const dateInput = document.createElement("input");
      dateInput.type = "month";
      dateInput.value = new Date().toISOString().split("T")[0].substring(0, 7);
      section.appendChild(dateInput);
      
      content.appendChild(section);
      renderAttendanceCalendar(section, studentName);
      
      if(role === "teacher") {
        const scannerDiv = document.createElement("div");
        scannerDiv.id = "qr-scanner";
        scannerDiv.className = "qr-scanner-container";
        scannerDiv.style.marginTop = "20px";
        section.appendChild(scannerDiv);
        
        const scannerResult = document.createElement("div");
        scannerResult.id = "scanner-result";
        scannerResult.className = "scanner-result";
        scannerResult.style.display = "none";
        section.appendChild(scannerResult);
        
        setTimeout(function(){
          initQRScanner(scannerDiv, section, studentName);
        }, 500);
      }
    }
    
    //------ GRADES ------
    else if(tab === "Grades" || tab === "Child Grades") {
      section.innerHTML = "<h3>üìä Grades</h3>";
      
      const gradesUnsubscribe = window.firebaseFns.onSnapshot(
        window.firebaseFns.collection(db, 'grades'),
        (snapshot) => {
          const gradesData = {};
          snapshot.docs.forEach(doc => {
            gradesData[doc.id] = doc.data();
          });
          window.realtimeGrades = gradesData;
          if(document.getElementById('gradesTable')) {
            const studentSelect = document.getElementById('gradesStudentSelect');
            const studentName = studentSelect ? studentSelect.value : currentUser;
            renderGradesTable(section, studentName);
          }
        }
      );
      unsubscribers.push(gradesUnsubscribe);
      
      const semSelector = document.createElement("div");
      semSelector.className = "sem-selector";
      semSelector.innerHTML = `
        <button class="sem-btn active" onclick="selectSemester(1, this)">1st Semester</button>
        <button class="sem-btn" onclick="selectSemester(2, this)">2nd Semester</button>
      `;
      section.appendChild(semSelector);
      
      const quarterSelector = document.createElement("div");
      quarterSelector.className = "quarter-selector";
      quarterSelector.id = "quarterSelector";
      quarterSelector.innerHTML = `
        <button class="quarter-btn active" onclick="selectQuarter(1, this)">1st Quarter</button>
        <button class="quarter-btn" onclick="selectQuarter(2, this)">2nd Quarter</button>
      `;
      section.appendChild(quarterSelector);
      
      const historyToggle = document.createElement('label');
      historyToggle.style.cssText = 'display: flex; align-items: center; gap: 10px; margin: 15px 0; cursor: pointer;';
      historyToggle.innerHTML = '<input type="checkbox" id="showHistory" style="width: auto;" onchange="toggleGradeHistory()"> Show Grade History';
      section.appendChild(historyToggle);
      
      let studentName = currentUser;
      if(role === "teacher") {
        const students = await getCollectionData('users', [
          window.firebaseFns.where('role', '==', 'student'),
          window.firebaseFns.where('approved', '==', true)
        ]);
        
        const teacherSection = currentUserData.sectionHandled;
        const sectionStudents = students.filter(s => s.section === teacherSection);
        
        const selectStudent = document.createElement("select");
        selectStudent.id = "gradesStudentSelect";
        sectionStudents.forEach(function(s){
          const opt = document.createElement("option");
          opt.value = s.name;
          opt.innerText = s.name;
          selectStudent.appendChild(opt);
        });
        section.appendChild(selectStudent);
        if(sectionStudents.length > 0) studentName = sectionStudents[0].name;
        
        selectStudent.onchange = function() {
          studentName = this.value;
          renderGradesTable(section, studentName);
        };
      } else if(role === "parent") {
        studentName = currentUserData.childName || currentUser;
      }
      
      content.appendChild(section);
      renderGradesTable(section, studentName);
    }
    
    //------ REPORT CARDS ------
    else if(tab === "Report Cards" && role === "teacher") {
      section.innerHTML = "<h3>üìã Report Cards</h3>";
      section.innerHTML += "<p>Generate official DepEd-style report cards for students.</p>";
      
      const students = await getCollectionData('users', [
        window.firebaseFns.where('role', '==', 'student'),
        window.firebaseFns.where('approved', '==', true)
      ]);
      
      const teacherSection = currentUserData.sectionHandled;
      const sectionStudents = students.filter(s => s.section === teacherSection);
      const sections = [...new Set(sectionStudents.map(s => s.section))];
      
      const sectionSelect = document.createElement('select');
      sectionSelect.innerHTML = '<option value="">Select Section</option>';
      sections.forEach(sec => {
        sectionSelect.innerHTML += `<option value="${sec}">${sec}</option>`;
      });
      section.appendChild(sectionSelect);
      
      const generateBtn = document.createElement('button');
      generateBtn.innerHTML = 'üìÑ Generate Report Cards';
      generateBtn.style.cssText = 'background: linear-gradient(135deg, var(--main-red) 0%, var(--main-blue) 100%); color: white; margin-top: 15px;';
      generateBtn.onclick = () => generateReportCards(sectionSelect.value, sectionStudents);
      section.appendChild(generateBtn);
      
      const reportContainer = document.createElement('div');
      reportContainer.id = 'reportCardsContainer';
      section.appendChild(reportContainer);
      
      content.appendChild(section);
    }
    
    //------ TRANSCRIPT ------
    else if(tab === "Transcript" && role === "student") {
      if(currentUserData.gradeLevel !== "12") {
        section.innerHTML = "<h3>üìú Transcript of Records</h3><p>‚ö†Ô∏è Transcripts are only available for Grade 12 students.</p>";
      } else {
        section.innerHTML = "<h3>üìú Transcript of Records</h3>";
        section.innerHTML += "<p>Official transcript for college/university applications.</p>";
        
        const gradesUnsubscribe = window.firebaseFns.onSnapshot(
          window.firebaseFns.doc(db, 'grades', currentUserData.name),
          (doc) => {
            const grades = doc.exists() ? doc.data() : {};
            renderTranscript(grades);
          }
        );
        unsubscribers.push(gradesUnsubscribe);
        
        const transcriptDiv = document.createElement('div');
        transcriptDiv.id = 'transcriptContainer';
        transcriptDiv.className = 'report-card';
        section.appendChild(transcriptDiv);
        
        const downloadBtn = document.createElement('button');
        downloadBtn.innerHTML = '‚¨áÔ∏è Download PDF';
        downloadBtn.style.cssText = 'background: #28a745; color: white; margin-top: 20px;';
        downloadBtn.onclick = () => downloadTranscriptPDF(currentUserData);
        section.appendChild(downloadBtn);
      }
      content.appendChild(section);
    }
    
    //------ ASSIGNMENTS ------
    else if(tab === "Assignments") {
      section.innerHTML = "<h3>üìù Assignments</h3>";
      
      const assignmentsUnsubscribe = window.firebaseFns.onSnapshot(
        window.firebaseFns.collection(db, 'assignments'),
        (snapshot) => {
          const assignments = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
          window.realtimeAssignments = assignments;
          if(document.getElementById('assignmentsContainer')) {
            renderAssignments();
          }
        }
      );
      unsubscribers.push(assignmentsUnsubscribe);
      
      const submissionsUnsubscribe = window.firebaseFns.onSnapshot(
        window.firebaseFns.collection(db, 'submissions'),
        (snapshot) => {
          const submissions = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
          window.realtimeSubmissions = submissions;
          if(document.getElementById('assignmentsContainer')) {
            renderAssignments();
          }
        }
      );
      unsubscribers.push(submissionsUnsubscribe);
      
      const container = document.createElement('div');
      container.id = 'assignmentsContainer';
      section.appendChild(container);
      
      if(role === "teacher") {
        section.innerHTML += `
          <div style="margin-bottom: 20px;">
            <button onclick="showCreateAssignment()" style="background: #28a745; color: white; width: auto;">‚ûï Create Assignment</button>
          </div>
          <div id="createAssignmentForm" style="display: none; background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
            <input type="text" id="assignmentTitle" placeholder="Assignment Title">
            <textarea id="assignmentDesc" placeholder="Description" rows="3"></textarea>
            <select id="assignmentSubject">
              <option value="3I's">3I's</option>
              <option value="Genchem 2">Genchem 2</option>
              <option value="P6 2">P6 2</option>
              <option value="Perdev">Perdev</option>
              <option value="CPAR">CPAR</option>
              <option value="Entrepreneurship">Entrepreneurship</option>
            </select>
            <input type="date" id="assignmentDue">
            <input type="number" id="assignmentPoints" placeholder="Total Points" value="100">
            <input type="file" id="assignmentFile" style="width: auto;">
            <button onclick="createAssignment()" style="background: var(--main-blue); color: white; margin-top: 10px;">‚úÖ Create</button>
          </div>
        `;
      }
      
      renderAssignments();
      content.appendChild(section);
    }
    
    //------ QUIZZES ------
    else if(tab === "Quizzes") {
      section.innerHTML = "<h3>‚ùì Quizzes & Exams</h3>";
      
      const quizzesUnsubscribe = window.firebaseFns.onSnapshot(
        window.firebaseFns.collection(db, 'quizzes'),
        (snapshot) => {
          const quizzes = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
          window.realtimeQuizzes = quizzes;
          if(document.getElementById('quizzesContainer')) {
            renderQuizzes();
          }
        }
      );
      unsubscribers.push(quizzesUnsubscribe);
      
      const resultsUnsubscribe = window.firebaseFns.onSnapshot(
        window.firebaseFns.collection(db, 'quizResults'),
        (snapshot) => {
          const results = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
          window.realtimeQuizResults = results;
          if(document.getElementById('quizzesContainer')) {
            renderQuizzes();
          }
        }
      );
      unsubscribers.push(resultsUnsubscribe);
      
      const container = document.createElement('div');
      container.id = 'quizzesContainer';
      section.appendChild(container);
      
      if(role === "teacher") {
        section.innerHTML += `
          <button onclick="showCreateQuiz()" style="background: #28a745; color: white; width: auto; margin-bottom: 20px;">‚ûï Create Quiz</button>
          <div id="createQuizForm" style="display: none; background: #f8f9fa; padding: 20px; border-radius: 10px;">
            <input type="text" id="quizTitle" placeholder="Quiz Title">
            <select id="quizSubject">
              <option value="3I's">3I's</option>
              <option value="Genchem 2">Genchem 2</option>
              <option value="P6 2">P6 2</option>
              <option value="Perdev">Perdev</option>
              <option value="CPAR">CPAR</option>
              <option value="Entrepreneurship">Entrepreneurship</option>
            </select>
            <input type="number" id="quizDuration" placeholder="Duration (minutes)" value="30">
            <input type="datetime-local" id="quizStart">
            <input type="datetime-local" id="quizEnd">
            <div id="quizQuestions"></div>
            <button onclick="addQuestion()" style="width: auto; background: var(--sub-yellow); color: #333; margin: 10px 5px 10px 0;">‚ûï Add Question</button>
            <button onclick="saveQuiz()" style="background: #28a745; color: white;">üíæ Save Quiz</button>
          </div>
        `;
      }
      
      renderQuizzes();
      content.appendChild(section);
    }
    
    //------ COURSE MATERIALS ------
    else if(tab === "Course Materials" && role === "student") {
      section.innerHTML = "<h3>üìñ Course Materials</h3>";
      
      const materialsUnsubscribe = window.firebaseFns.onSnapshot(
        window.firebaseFns.collection(db, 'courseMaterials'),
        (snapshot) => {
          const materials = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
          window.realtimeMaterials = materials;
          if(document.getElementById('materialsContainer')) {
            renderCourseMaterials();
          }
        }
      );
      unsubscribers.push(materialsUnsubscribe);
      
      const container = document.createElement('div');
      container.id = 'materialsContainer';
      section.appendChild(container);
      
      renderCourseMaterials();
      content.appendChild(section);
    }
    
    //------ MESSAGES ------
    else if(tab === "Messages") {
      section.innerHTML = "<h3>üí¨ Messages</h3>";
      
      const messagesUnsubscribe = window.firebaseFns.onSnapshot(
        window.firebaseFns.collection(db, 'messages'),
        (snapshot) => {
          const messages = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
          window.realtimeMessages = messages;
          if(currentContact) {
            loadMessages(currentContact.username);
          }
        }
      );
      unsubscribers.push(messagesUnsubscribe);
      
      const messagingContainer = document.createElement('div');
      messagingContainer.className = 'messaging-container';
      
      const contactsList = document.createElement('div');
      contactsList.className = 'contacts-list';
      
      let contacts = [];
      if(role === 'teacher') {
        const students = await getCollectionData('users', [
          window.firebaseFns.where('role', '==', 'student'),
          window.firebaseFns.where('approved', '==', true)
        ]);
        const teacherSection = currentUserData.sectionHandled;
        const sectionStudents = students.filter(s => s.section === teacherSection);
        
        sectionStudents.forEach(s => {
          contacts.push({name: s.name, username: s.name, type: 'student', avatar: 'üë®‚Äçüéì'});
        });
      } else if(role === 'parent') {
        const teachers = await getCollectionData('users', [
          window.firebaseFns.where('role', '==', 'teacher')
        ]);
        teachers.forEach(t => {
          contacts.push({name: t.name, username: t.name, type: 'teacher', avatar: 'üë®‚Äçüè´'});
        });
      } else if(role === 'student') {
        const teachers = await getCollectionData('users', [
          window.firebaseFns.where('role', '==', 'teacher')
        ]);
        teachers.forEach(t => {
          contacts.push({name: t.name, username: t.name, type: 'teacher', avatar: 'üë®‚Äçüè´'});
        });
      }
      
      contacts.forEach((contact, index) => {
        const contactDiv = document.createElement('div');
        contactDiv.className = 'contact-item' + (index === 0 ? ' active' : '');
        contactDiv.innerHTML = `
          <div class="contact-avatar">${contact.avatar}</div>
          <div>
            <div style="font-weight: bold;">${contact.name}</div>
            <div style="font-size: 12px; color: #666;">${contact.type}</div>
          </div>
        `;
        contactDiv.onclick = () => selectContact(contact, contactDiv);
        contactsList.appendChild(contactDiv);
      });
      
      messagingContainer.appendChild(contactsList);
      
      const chatArea = document.createElement('div');
      chatArea.className = 'chat-area';
      chatArea.id = 'chatArea';
      
      chatArea.innerHTML = `
        <div class="chat-header" id="chatHeader">Select a contact to start messaging</div>
        <div class="chat-messages" id="chatMessages"></div>
        <div class="chat-input-area">
          <input type="text" id="messageInput" placeholder="Type your message..." disabled>
          <button onclick="sendMessage()" id="sendBtn" disabled style="width: auto; background: var(--main-blue); color: white;">üì§</button>
        </div>
      `;
      
      messagingContainer.appendChild(chatArea);
      section.appendChild(messagingContainer);
      
      if(contacts.length > 0) {
        setTimeout(() => selectContact(contacts[0], contactsList.firstChild), 100);
      }
      
      content.appendChild(section);
    }
    
    //------ CONFERENCE SCHEDULING ------
    else if(tab === "Conference Schedule" || tab === "Conference Booking") {
      section.innerHTML = "<h3>üìÖ Parent-Teacher Conference</h3>";
      
      const conferencesUnsubscribe = window.firebaseFns.onSnapshot(
        window.firebaseFns.collection(db, 'conferences'),
        (snapshot) => {
          const conferences = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
          window.realtimeConferences = conferences;
          if(document.getElementById('conferencesContainer')) {
            renderConferences();
          }
        }
      );
      unsubscribers.push(conferencesUnsubscribe);
      
      const container = document.createElement('div');
      container.id = 'conferencesContainer';
      section.appendChild(container);
      
      if(role === "teacher") {
        section.innerHTML += `
          <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
            <h4>Set Available Slots</h4>
            <input type="date" id="conferenceDate">
            <input type="time" id="conferenceStart">
            <input type="time" id="conferenceEnd">
            <input type="number" id="slotDuration" placeholder="Slot duration (minutes)" value="30">
            <button onclick="generateSlots()" style="background: #28a745; color: white; margin-top: 10px;">‚ûï Generate Slots</button>
          </div>
        `;
      }
      
      renderConferences();
      content.appendChild(section);
    }
    
    //------ BEHAVIOR REPORTS ------
    else if(tab === "Behavior Reports") {
      section.innerHTML = "<h3>üìã Behavioral Records</h3>";
      
      const behaviorUnsubscribe = window.firebaseFns.onSnapshot(
        window.firebaseFns.collection(db, 'behaviorLog'),
        (snapshot) => {
          const logs = {};
          snapshot.docs.forEach(doc => {
            logs[doc.id] = doc.data().entries || [];
          });
          window.realtimeBehaviorLog = logs;
          if(document.getElementById('behaviorContainer')) {
            renderBehaviorReports();
          }
        }
      );
      unsubscribers.push(behaviorUnsubscribe);
      
      const container = document.createElement('div');
      container.id = 'behaviorContainer';
      section.appendChild(container);
      
      if(role === "teacher") {
        const students = await getCollectionData('users', [
          window.firebaseFns.where('role', '==', 'student'),
          window.firebaseFns.where('approved', '==', true)
        ]);
        
        const teacherSection = currentUserData.sectionHandled;
        const sectionStudents = students.filter(s => s.section === teacherSection);
        
        const studentSelect = document.createElement('select');
        studentSelect.id = 'behaviorStudent';
        sectionStudents.forEach(s => {
          studentSelect.innerHTML += `<option value="${s.name}">${s.name}</option>`;
        });
        section.appendChild(studentSelect);
        
        section.innerHTML += `
          <select id="behaviorType">
            <option value="merit">Merit (+)</option>
            <option value="demerit">Demerit (-)</option>
          </select>
          <input type="number" id="behaviorPoints" placeholder="Points" value="1" min="1" max="10">
          <input type="text" id="behaviorReason" placeholder="Reason/Description">
          <button onclick="addBehaviorRecord()" style="background: #28a745; color: white; margin-top: 10px;">‚ûï Add Record</button>
        `;
      }
      
      renderBehaviorReports();
      content.appendChild(section);
    }
    
    //------ HONOR ROLL ------
    else if(tab === "Honor Roll") {
      section.innerHTML = "<h3>üèÜ Honor Roll & Academic Excellence</h3>";
      
      const gradesUnsubscribe = window.firebaseFns.onSnapshot(
        window.firebaseFns.collection(db, 'grades'),
        (snapshot) => {
          const gradesData = {};
          snapshot.docs.forEach(doc => {
            gradesData[doc.id] = doc.data();
          });
          window.realtimeGrades = gradesData;
          if(document.getElementById('honorRollContainer')) {
            renderHonorRoll();
          }
        }
      );
      unsubscribers.push(gradesUnsubscribe);
      
      const studentsUnsubscribe = window.firebaseFns.onSnapshot(
        window.firebaseFns.query(
          window.firebaseFns.collection(db, 'users'),
          window.firebaseFns.where('role', '==', 'student'),
          window.firebaseFns.where('approved', '==', true)
        ),
        (snapshot) => {
          const students = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
          window.realtimeStudents = students;
          if(document.getElementById('honorRollContainer')) {
            renderHonorRoll();
          }
        }
      );
      unsubscribers.push(studentsUnsubscribe);
      
      const container = document.createElement('div');
      container.id = 'honorRollContainer';
      section.appendChild(container);
      
      renderHonorRoll();
      content.appendChild(section);
    }
    
    //------ PAYMENTS ------
    else if(tab === "Payments") {
      section.innerHTML = "<h3>üí≥ Payments & Financial Records</h3>";
      
      const paymentsUnsubscribe = window.firebaseFns.onSnapshot(
        window.firebaseFns.collection(db, 'payments'),
        (snapshot) => {
          const payments = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
          window.realtimePayments = payments;
          if(document.getElementById('paymentsContainer')) {
            renderPayments();
          }
        }
      );
      unsubscribers.push(paymentsUnsubscribe);
      
      const container = document.createElement('div');
      container.id = 'paymentsContainer';
      section.appendChild(container);
      
      renderPayments();
      content.appendChild(section);
    }
    
    //------ SETTINGS ------
    else if(tab === "Settings") {
      section.innerHTML = `
        <h3>‚öôÔ∏è Settings</h3>
        <div class="settings-section">
          <h4>üé® Appearance</h4>
          <div style="display: flex; justify-content: space-between; align-items: center; margin: 15px 0;">
            <div>
              <strong>Dark Mode</strong>
              <p style="margin: 5px 0; font-size: 13px; color: #666;">Easier on the eyes</p>
            </div>
            <label class="toggle-switch">
              <input type="checkbox" id="toggleDarkMode" onchange="toggleDarkMode()" ${localStorage.getItem('darkMode') === 'true' ? 'checked' : ''}>
              <span class="slider"></span>
            </label>
          </div>
        </div>
        <div class="settings-section">
          <h4>üîî Notifications</h4>
          <div style="display: flex; justify-content: space-between; align-items: center; margin: 15px 0;">
            <div>
              <strong>Push Notifications</strong>
              <p style="margin: 5px 0; font-size: 13px; color: #666;">Get notified about updates</p>
            </div>
            <label class="toggle-switch">
              <input type="checkbox" id="togglePushNotif" checked>
              <span class="slider"></span>
            </label>
          </div>
        </div>
        <div class="settings-section">
          <h4>üåê Language</h4>
          <select id="languageSelect" onchange="changeLanguage()">
            <option value="en">English</option>
            <option value="fil">Filipino</option>
            <option value="ceb">Cebuano</option>
          </select>
        </div>
      `;
      content.appendChild(section);
    }
    
    //------ SUBJECT SCHEDULE ------
    else if(tab === "Subject Schedule" || tab === "Child Schedule") {
      section.innerHTML = "<h3>üìö Weekly Subject Schedule</h3>";
      
      let studentName = currentUser;
      let userSection = currentUserData.section;
      
      if(role === "parent") {
        studentName = currentUserData.childName || currentUser;
        userSection = currentUserData.childSection;
      } else if(role === "teacher") {
        userSection = currentUserData.sectionHandled;
      }
      
      const scheduleUnsubscribe = window.firebaseFns.onSnapshot(
        window.firebaseFns.doc(db, 'schedules', userSection || 'default'),
        (doc) => {
          const scheduleData = doc.exists() ? doc.data() : null;
          window.realtimeSchedule = scheduleData;
          if(document.getElementById('scheduleTable')) {
            renderScheduleTable(userSection);
          }
        }
      );
      unsubscribers.push(scheduleUnsubscribe);
      
      const scheduleDiv = document.createElement("div");
      scheduleDiv.id = 'scheduleTable';
      scheduleDiv.className = "weekly-schedule";
      section.appendChild(scheduleDiv);
      
      renderScheduleTable(userSection);
      
      const legend = document.createElement("div");
      legend.style.marginTop = "20px";
      legend.style.padding = "15px";
      legend.style.background = "#f8f9fa";
      legend.style.borderRadius = "8px";
      legend.innerHTML = `
        <h4>üìã Schedule Legend</h4>
        <p><span style="display: inline-block; width: 20px; height: 20px; background: #fff3cd; margin-right: 10px; vertical-align: middle;"></span> Recess</p>
        <p><span style="display: inline-block; width: 20px; height: 20px; background: #d4edda; margin-right: 10px; vertical-align: middle;"></span> Lunch</p>
      `;
      section.appendChild(legend);
      
      if(role === "teacher" || role === "admin") {
        section.innerHTML += "<h4>Manage Schedule</h4>";
        section.innerHTML += `
          <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-top: 15px;">
            <p><strong>Current Section:</strong> ${userSection}</p>
            <p style="font-size: 13px; color: #666; margin-top: 10px;">
              üí° Tip: The schedule is automatically generated based on your section. 
              To customize subjects, use the Subject Management below.
            </p>
          </div>
        `;
        
        section.innerHTML += "<h4 style='margin-top: 25px;'>Subject Management</h4>";
        const subjects = ["3I's","Genchem 2","P6 2","Perdev","CPAR","Entrepreneurship"];
        subjects.forEach(function(sub, index){
          const item = document.createElement("div");
          item.className = "subject-item";
          item.innerHTML = '<input type="text" value="' + sub + '" onchange="updateSubject(' + index + ', this.value)">' +
            '<input type="text" placeholder="Time" onchange="updateScheduleTime(\'' + sub + '\', this.value)">' +
            '<button onclick="deleteSubject(' + index + ')" style="width:auto;background:#dc3545;color:white;">üóëÔ∏è Delete</button>';
          section.appendChild(item);
        });
        
        const addDiv = document.createElement("div");
        addDiv.className = "subject-item";
        addDiv.innerHTML = '<input type="text" id="newSubjectName" placeholder="New Subject">' +
          '<input type="text" id="newSubjectTime" placeholder="Time">' +
          '<button onclick="addSubject()" style="width:auto;background:#28a745;color:white;">‚ûï Add</button>';
        section.appendChild(addDiv);
      }
      
      content.appendChild(section);
    }

    //------ QR CODE ------
    else if(tab === "QR Code" && role === "student") {
      section.innerHTML = "<h3>üî≥ Your QR Code</h3>";
      const qrDiv = document.createElement("div");
      qrDiv.id = "qr-code";
      qrDiv.style.textAlign = "center";
      qrDiv.style.padding = "20px";
      section.appendChild(qrDiv);
      
      const qrCodeData = currentUser + "-" + new Date().toISOString().split("T")[0];
      setTimeout(() => {
        try {
          new QRCode(qrDiv, {
            text: qrCodeData,
            width: 200,
            height: 200,
            colorDark: "#003366",
            colorLight: "#ffffff"
          });
        } catch(e) {
          console.error('QR Code generation error:', e);
          qrDiv.innerHTML = '<p>Error generating QR code</p>';
        }
      }, 100);
      
      section.innerHTML += "<p style='text-align:center;margin-top:15px;'>üì± Scan this QR code for attendance</p>";
      
      const attendanceUnsubscribe = window.firebaseFns.onSnapshot(
        window.firebaseFns.doc(db, 'attendance', currentUser),
        (doc) => {
          const attendanceData = doc.exists() ? doc.data() : {};
          if(document.getElementById('attendanceStats')) {
            renderAttendanceStats(attendanceData);
          }
        }
      );
      unsubscribers.push(attendanceUnsubscribe);
      
      const perfBox = document.createElement("div");
      perfBox.id = 'attendanceStats';
      perfBox.className = "performance-box";
      section.appendChild(perfBox);
      
      renderAttendanceStats({});
      
      content.appendChild(section);
    }

    //------ MY INFO ------
    else if(tab === "My Info") {
      section.innerHTML = "<h3>üë§ My Information</h3>";
      
      const user = currentUserData;
      if(user) {
        const initials = user.name ? user.name.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase() : 'üë§';
        const photoURL = user.photoURL || null;
        
        section.innerHTML += `
          <div style="text-align: center; margin-bottom: 20px;">
            <div class="id-card-photo" id="profilePhoto" style="width: 120px; height: 120px; margin: 0 auto 15px; font-size: 48px; display: flex; align-items: center; justify-content: center; background: ${photoURL ? 'transparent' : 'linear-gradient(135deg, var(--main-red) 0%, var(--main-blue) 100%)'}; color: white; position: relative; overflow: hidden;">
              ${photoURL ? `<img src="${photoURL}" style="width: 100%; height: 100%; object-fit: cover;" />` : initials}
              <div onclick="triggerPhotoUpload()" style="position: absolute; bottom: 0; right: 0; background: rgba(0,0,0,0.7); color: white; padding: 5px 10px; font-size: 12px; cursor: pointer; border-radius: 20px 0 0 0;">
                üì∑ Change
              </div>
            </div>
            <input type="file" id="photoUpload" style="display: none;" accept="image/*" onchange="handlePhotoUpload(event)">
            <p style="font-size: 12px; color: #666; margin-top: 5px;">Click "Change" to upload photo</p>
          </div>
          <div class="id-card-info" style="background: #f8f9fa; color: #333; padding: 20px; border-radius: 10px;">
            <p><strong>Name:</strong> ${user.name || '-'}</p>
            <p><strong>Email:</strong> ${user.email || '-'}</p>
            <p><strong>Role:</strong> ${user.role || '-'}</p>
            <p><strong>Section:</strong> ${user.section || user.sectionHandled || '-'}</p>
            <p><strong>Track:</strong> ${user.track || '-'}</p>
            <p><strong>Strand:</strong> ${user.strand || '-'}</p>
            <p><strong>Grade Level:</strong> ${user.gradeLevel || '-'}</p>
            ${user.teacherName ? `<p><strong>Adviser:</strong> ${user.teacherName}</p>` : ''}
          </div>
        `;
      }
      
      content.appendChild(section);
    }

    //------ BULLETIN BOARD ------
    else if(tab === "Bulletin Board") {
      section.innerHTML = "<h3>üì¢ Bulletin Board</h3>";
      
      const board = document.createElement('div');
      board.id = 'bulletinBoard';
      section.appendChild(board);
      
      subscribeToCollection('bulletinBoard', (items) => {
        board.innerHTML = '';
        if(items.length === 0) {
          board.innerHTML = '<p>No announcements yet.</p>';
        } else {
          items.forEach(item => {
            const div = document.createElement('div');
            div.style.cssText = 'padding: 15px; border-bottom: 1px solid #ddd; margin-bottom: 10px; background: #f8f9fa; border-radius: 8px;';
            div.innerHTML = `
              <p>${item.content}</p>
              <small style="color: #666;">By ${item.author || 'Unknown'} ‚Ä¢ ${item.createdAt?.toDate ? item.createdAt.toDate().toLocaleString() : 'Just now'}</small>
            `;
            board.appendChild(div);
          });
        }
      }, [window.firebaseFns.orderBy('createdAt', 'desc')]);
      
      if(role === "teacher" || role === "admin") {
        const input = document.createElement('input');
        input.id = 'newAnnouncement';
        input.placeholder = 'Type new announcement...';
        section.appendChild(input);
        
        const btn = document.createElement('button');
        btn.innerText = '‚ûï Add Announcement';
        btn.style.cssText = 'background: linear-gradient(135deg, #8B0000 0%, #003366 100%); color: white; margin-top: 10px;';
        btn.onclick = async () => {
          const text = input.value.trim();
          if(text) {
            await addDocument('bulletinBoard', {
              content: text,
              author: currentUser,
              authorId: currentUserId,
              authorRole: role
            });
            input.value = '';
          }
        };
        section.appendChild(btn);
      }
      
      content.appendChild(section);
    }
    
    //------ ADMIN FUNCTIONS ------
    else if(role === "admin") {
      //------ STUDENT APPROVAL ------
      if(tab === "Student Approval") {
        section.innerHTML = "<h3>‚úÖ Approve Students</h3>";
        
        const pendingUnsubscribe = window.firebaseFns.onSnapshot(
          window.firebaseFns.query(
            window.firebaseFns.collection(db, 'users'),
            window.firebaseFns.where('role', '==', 'student'),
            window.firebaseFns.where('approved', '==', false)
          ),
          (snapshot) => {
            const pendingStudents = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            renderPendingStudents(section, pendingStudents);
          }
        );
        unsubscribers.push(pendingUnsubscribe);
        
        content.appendChild(section);
      }
      
      //------ CREATE TEACHER ------
      else if(tab === "Create Teacher") {
        section.innerHTML = "<h3>üë®‚Äçüè´ Create Teacher Account</h3>";
        section.innerHTML += `
          <input type="text" id="newTeacherName" placeholder="üë§ Full Name">
          <input type="text" id="newTeacherID" placeholder="üÜî Teacher ID">
          <input type="text" id="newTeacherPosition" placeholder="üíº Position">
          <input type="text" id="newTeacherSection" placeholder="üè´ Section Handled">
          <input type="text" id="newTeacherUsername" placeholder="üë§ Username">
          <input type="email" id="newTeacherEmail" placeholder="üìß Email">
          <input type="password" id="newTeacherPassword" placeholder="üîí Password (min 8 chars)">
          <button onclick="createTeacher()" style="background: linear-gradient(135deg, #8B0000 0%, #003366 100%); color: white; padding: 14px;">üë®‚Äçüè´ Create Teacher</button>
        `;
        
        content.appendChild(section);
      }
      
      //------ ALL STUDENTS ------
      else if(tab === "All Students") {
        section.innerHTML = "<h3>üë®‚Äçüéì All Students</h3>";
        
        const printControls = document.createElement("div");
        printControls.className = "print-controls";
        printControls.innerHTML = `
          <h4>üñ®Ô∏è Print ID Cards</h4>
          <p>Check the students you want to print, then click Print Selected.</p>
          <label><input type="checkbox" id="selectAllStudents" onchange="toggleSelectAllStudents()" style="width:auto;"> ‚úÖ Select All</label><br><br>
          <button onclick="printSelectedIDs()" style="background:#28a745;color:white;width:auto;padding:12px 24px;">üñ®Ô∏è Print Selected</button>
        `;
        section.appendChild(printControls);
        
        const studentsUnsubscribe = window.firebaseFns.onSnapshot(
          window.firebaseFns.query(
            window.firebaseFns.collection(db, 'users'),
            window.firebaseFns.where('role', '==', 'student'),
            window.firebaseFns.where('approved', '==', true)
          ),
          (snapshot) => {
            const students = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            window.realtimeAllStudents = students;
            if(document.getElementById('studentsContainer')) {
              renderAllStudents();
            }
          }
        );
        unsubscribers.push(studentsUnsubscribe);
        
        const filterSection = document.createElement("select");
        filterSection.id = "filterSection";
        filterSection.innerHTML = "<option value='all'>üìã All Sections</option>";
        section.appendChild(filterSection);
        
        const studentsContainer = document.createElement("div");
        studentsContainer.id = "studentsContainer";
        section.appendChild(studentsContainer);
        
        filterSection.onchange = function(){
          renderAllStudents();
        };
        
        content.appendChild(section);
      }
      
      //------ PARENT ACCOUNTS ------
      else if(tab === "Parent Accounts") {
        section.innerHTML = "<h3>üë™ Parent Accounts</h3>";
        section.innerHTML += "<p>üìù These credentials are auto-generated when students sign up.</p>";
        
        const parentsUnsubscribe = window.firebaseFns.onSnapshot(
          window.firebaseFns.collection(db, 'parentAccounts'),
          (snapshot) => {
            const parentAccounts = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            window.realtimeParentAccounts = parentAccounts;
            if(document.getElementById('parentContainer')) {
              renderParentAccounts();
            }
          }
        );
        unsubscribers.push(parentsUnsubscribe);
        
        const filterSection = document.createElement("select");
        filterSection.id = "filterParentSection";
        filterSection.innerHTML = "<option value='all'>üìã All Sections</option>";
        section.appendChild(filterSection);
        
        const parentContainer = document.createElement("div");
        parentContainer.id = "parentContainer";
        section.appendChild(parentContainer);
        
        filterSection.onchange = function(){
          renderParentAccounts();
        };
        
        content.appendChild(section);
      }
      
      //------ MANAGE USERS ------
      else if(tab === "Manage Users") {
        section.innerHTML = "<h3>‚öôÔ∏è Manage Users</h3>";
        
        const usersUnsubscribe = window.firebaseFns.onSnapshot(
          window.firebaseFns.collection(db, 'users'),
          (snapshot) => {
            const allUsers = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            renderManageUsers(allUsers);
          }
        );
        unsubscribers.push(usersUnsubscribe);
        
        const container = document.createElement('div');
        container.id = 'manageUsersContainer';
        section.appendChild(container);
        
        content.appendChild(section);
      }
      
      //------ ENROLLMENT ------
      else if(tab === "Enrollment") {
        section.innerHTML = "<h3>üìù Online Enrollment</h3>";
        
        section.innerHTML += `
          <div class="step-indicator">
            <div class="step active" id="step1">1. Personal Info</div>
            <div class="step" id="step2">2. Academic Info</div>
            <div class="step" id="step3">3. Documents</div>
            <div class="step" id="step4">4. Review</div>
          </div>
          
          <div class="enrollment-step active" id="enrollStep1">
            <h4>Personal Information</h4>
            <input type="text" id="enrollLastName" placeholder="Last Name">
            <input type="text" id="enrollFirstName" placeholder="First Name">
            <input type="text" id="enrollMiddleName" placeholder="Middle Name">
            <input type="date" id="enrollBirthdate" placeholder="Birthdate">
            <select id="enrollGender">
              <option value="">Select Gender</option>
              <option value="M">Male</option>
              <option value="F">Female</option>
            </select>
            <button onclick="nextEnrollStep(1)" style="background: var(--main-blue); color: white;">Next ‚û°Ô∏è</button>
          </div>
          
          <div class="enrollment-step" id="enrollStep2">
            <h4>Academic Information</h4>
            <select id="enrollTrack">
              <option value="">Select Track</option>
              <option value="Academic">Academic</option>
              <option value="TVL">Technical-Vocational-Livelihood</option>
              <option value="Arts">Arts and Design</option>
              <option value="Sports">Sports</option>
            </select>
            <select id="enrollStrand">
              <option value="">Select Strand</option>
              <option value="STEM">STEM</option>
              <option value="ABM">ABM</option>
              <option value="HUMSS">HUMSS</option>
              <option value="GAS">GAS</option>
            </select>
            <select id="enrollGrade">
              <option value="">Select Grade Level</option>
              <option value="11">Grade 11</option>
              <option value="12">Grade 12</option>
            </select>
            <div style="display: flex; gap: 10px;">
              <button onclick="prevEnrollStep(2)" style="background: #6c757d; color: white; flex: 1;">‚¨ÖÔ∏è Back</button>
              <button onclick="nextEnrollStep(2)" style="background: var(--main-blue); color: white; flex: 1;">Next ‚û°Ô∏è</button>
            </div>
          </div>
          
          <div class="enrollment-step" id="enrollStep3">
            <h4>Required Documents</h4>
            <div class="upload-zone" onclick="document.getElementById('doc1').click()">
              <div>üìÑ</div>
              <p><strong>Click to upload</strong> or drag and drop</p>
              <p style="font-size: 12px; color: #666;">Birth Certificate (PDF, JPG)</p>
              <input type="file" id="doc1" style="display: none;" accept=".pdf,.jpg,.png">
            </div>
            <div class="upload-zone" onclick="document.getElementById('doc2').click()" style="margin-top: 15px;">
              <div>üìÑ</div>
              <p><strong>Click to upload</strong> or drag and drop</p>
              <p style="font-size: 12px; color: #666;">Form 138 (Report Card)</p>
              <input type="file" id="doc2" style="display: none;" accept=".pdf,.jpg,.png">
            </div>
            <div style="display: flex; gap: 10px; margin-top: 15px;">
              <button onclick="prevEnrollStep(3)" style="background: #6c757d; color: white; flex: 1;">‚¨ÖÔ∏è Back</button>
              <button onclick="nextEnrollStep(3)" style="background: var(--main-blue); color: white; flex: 1;">Next ‚û°Ô∏è</button>
            </div>
          </div>
          
          <div class="enrollment-step" id="enrollStep4">
            <h4>Review Application</h4>
            <div id="enrollReview" style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin: 15px 0;"></div>
            <div style="display: flex; gap: 10px;">
              <button onclick="prevEnrollStep(4)" style="background: #6c757d; color: white; flex: 1;">‚¨ÖÔ∏è Back</button>
              <button onclick="submitEnrollment()" style="background: #28a745; color: white; flex: 1;">‚úÖ Submit Application</button>
            </div>
          </div>
        `;
        
        content.appendChild(section);
      }
      
      //------ ANALYTICS ------
      else if(tab === "Analytics") {
        section.innerHTML = "<h3>üìä School Analytics Dashboard</h3>";
        
        const container = document.createElement('div');
        container.id = 'analyticsContainer';
        section.appendChild(container);
        
        subscribeToAnalytics((data) => {
          renderAnalytics(data);
        });
        
        content.appendChild(section);
      }
    }
    
    //------ MY PLANNER ------
    else if(tab === "My Planner" && role === "teacher") {
      section.innerHTML = "<h3>üìù My Planner</h3>";
      
      const plannerUnsubscribe = window.firebaseFns.onSnapshot(
        window.firebaseFns.doc(db, 'planners', currentUserId),
        (doc) => {
          const plannerData = doc.exists() ? doc.data() : { daily: [], weekly: [], monthly: [] };
          window.realtimePlanner = plannerData;
          if(document.getElementById('plannerContainer')) {
            renderPlanner();
          }
        }
      );
      unsubscribers.push(plannerUnsubscribe);
      
      const container = document.createElement('div');
      container.id = 'plannerContainer';
      container.className = "planner-container";
      section.appendChild(container);
      
      renderPlanner();
      content.appendChild(section);
    }
    
    //------ MY MOOD ------
    else if(tab === "My Mood" && role === "student") {
      section.innerHTML = "<h3>ü§ó My Mood - AI Companion</h3>";
      section.innerHTML += "<p>Share how you're feeling and I'll help you feel better!</p>";
      
      const moodDiv = document.createElement("div");
      moodDiv.className = "mood-selector";
      moodDiv.innerHTML = '<button class="mood-btn" onclick="selectMood(\'üòä\')">üòä</button>' +
        '<button class="mood-btn" onclick="selectMood(\'üò¢\')">üò¢</button>' +
        '<button class="mood-btn" onclick="selectMood(\'üò†\')">üò†</button>' +
        '<button class="mood-btn" onclick="selectMood(\'üò∞\')">üò∞</button>' +
        '<button class="mood-btn" onclick="selectMood(\'üò¥\')">üò¥</button>' +
        '<button class="mood-btn" onclick="selectMood(\'ü§ó\')">ü§ó</button>';
      section.appendChild(moodDiv);
      
      const chatbox = document.createElement("div");
      chatbox.id = "moodChatbox";
      chatbox.className = "chatbox";
      chatbox.style.background = "#f0f8ff";
      chatbox.innerHTML = '<div class="chat-message chat-ai"><strong>ü§ó AI Companion:</strong> Hi! How are you feeling today? You can select a mood above or just tell me what\'s on your mind.</div>';
      section.appendChild(chatbox);
      
      const input = document.createElement("input");
      input.type = "text";
      input.id = "moodInput";
      input.placeholder = "Tell me what's on your mind...";
      section.appendChild(input);
      
      const sendBtn = document.createElement("button");
      sendBtn.innerText = "üí¨ Share";
      sendBtn.style.background = "#6c5ce7";
      sendBtn.style.color = "white";
      sendBtn.onclick = function() { sendMoodMessage(); };
      section.appendChild(sendBtn);
      
      section.innerHTML += '<div style="margin-top:18px;padding:15px;background:#fff3cd;border-radius:8px;font-size:13px;">' +
        '<strong>üí° Tips:</strong> Talk about your feelings! I\'m here to listen and help.' +
        '</div>';
      
      content.appendChild(section);
    }
    
    //------ EMERGENCY NUMBERS ------
    else if(tab === "Emergency Numbers") {
      section.innerHTML = "<h3>üö® Emergency Numbers</h3>";
      const numbers = [
        {name:"üöî PNP DUMINGAG", num:"099859558677"},
        {name:"üî• BFP DUMINGAG", num:"09300459871"},
        {name:"üèõÔ∏è LGU DUMINGAG", num:"09482121024"},
        {name:"üÜò MDRRMO DUMINGAG", num:"09098046609"}
      ];
      numbers.forEach(function(n){
        const div = document.createElement("div");
        div.style.margin = "12px 0";
        div.innerHTML = '<a href="tel:' + n.num + '" style="display:block;padding:18px;background:linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);border-radius:10px;border-left:5px solid #dc3545;text-decoration:none;color:#333;transition:all 0.3s;">' +
          '<strong>' + n.name + '</strong><br>' + n.num + '</a>';
        section.appendChild(div);
      });
      
      content.appendChild(section);
    }
    
    //------ SCHOOL MAP ------
    else if(tab === "School Map") {
      section.innerHTML = "<h3>üó∫Ô∏è School Map</h3>";
      
      const mapContainer = document.createElement("div");
      mapContainer.className = "school-map-container";
      mapContainer.innerHTML = `
        <h4>üè´ DSHS Campus Layout</h4>
        <img src="https://via.placeholder.com/800x600" alt="DSHS School Map" style="max-width:100%;border-radius:10px;box-shadow:0 4px 15px rgba(0,0,0,0.2);">
        <div class="map-legend">
          <div class="map-legend-item">
            <strong>üè¢ Building A</strong>
            Main Entrance & Administration
          </div>
          <div class="map-legend-item">
            <strong>üè´ Building B</strong>
            Classrooms 12-A, 12-B, 12-C
          </div>
          <div class="map-legend-item">
            <strong>üî¨ Building C</strong>
            Science Laboratory
          </div>
          <div class="map-legend-item">
            <strong>üìö Building D</strong>
            Library & Computer Room
          </div>
          <div class="map-legend-item">
            <strong>üë®‚Äçüè´ Building E</strong>
            Faculty Room
          </div>
          <div class="map-legend-item">
            <strong>üèÄ Gymnasium</strong>
            Physical Education Activities
          </div>
          <div class="map-legend-item">
            <strong>üçΩÔ∏è Cafeteria</strong>
            Student Lounge
          </div>
          <div class="map-legend-item">
            <strong>üíº Guidance Office</strong>
            Counseling Services
          </div>
        </div>
      `;
      section.appendChild(mapContainer);
      
      content.appendChild(section);
    }
    
    //------ DEFAULT ------
    else {
      section.innerHTML = `
        <div class="school-welcome">
          <h2>üè´ ${tab}</h2>
          <p>This feature is coming soon!</p>
        </div>
      `;
      content.appendChild(section);
    }
  }
  
  //====== QR SCANNER INITIALIZATION ======
  async function initQRScanner(container, section, studentName) {
    try {
      if(typeof Html5Qrcode === 'undefined') {
        console.error('Html5Qrcode library not loaded');
        container.innerHTML = '<p style="color: red;">QR Scanner library not available. Please refresh the page.</p>';
        return;
      }
      
      if(html5QrCodeScanner) {
        await html5QrCodeScanner.stop();
        html5QrCodeScanner = null;
      }
      
      html5QrCodeScanner = new Html5Qrcode("qr-scanner");
      
      await html5QrCodeScanner.start(
        { facingMode: "environment" },
        { fps: 10, qrbox: 250 },
        function(decodedText){
          handleQRScan(decodedText, section, studentName);
        },
        function(errorMessage){
          // QR scan error - ignore continuous errors
        }
      );
      
      console.log('QR Scanner started successfully');
    } catch(err) {
      console.error("Scanner initialization error:", err);
      container.innerHTML = '<p style="color: red;">Camera access denied or not available. Please check permissions.</p>';
    }
  }
  
  async function handleQRScan(decodedText, section, studentName) {
    try {
      const parts = decodedText.split("-");
      const scannedStudent = parts[0];
      const today = new Date().toISOString().split("T")[0];
      
      await saveAttendance(scannedStudent, today, "P");
      
      const resultDiv = document.getElementById("scanner-result");
      if(resultDiv) {
        resultDiv.style.display = "block";
        resultDiv.className = "scanner-result success";
        resultDiv.innerHTML = "‚úÖ Marked " + scannedStudent + " present on " + today;
      }
      
      renderAttendanceCalendar(section, studentName);
      addNotification('You were marked present on ' + today, 'attendance', scannedStudent);
      
      if(html5QrCodeScanner) {
        await html5QrCodeScanner.stop();
        html5QrCodeScanner = null;
      }
    } catch(error) {
      console.error('QR Scan handling error:', error);
    }
  }
  
  //====== RENDER FUNCTIONS FOR REAL-TIME DATA ======
  function renderAssignments() {
    const container = document.getElementById('assignmentsContainer');
    if(!container) return;
    
    container.innerHTML = '';
    
    const assignments = window.realtimeAssignments || [];
    const submissions = window.realtimeSubmissions || [];
    
    if(role === "teacher") {
      const teacherAssignments = assignments.filter(a => a.teacher === currentUser);
      if(teacherAssignments.length === 0) {
        container.innerHTML = "<p>No assignments created yet.</p>";
      } else {
        teacherAssignments.forEach(a => {
          const submissions_count = submissions.filter(s => s.assignmentId === a.id).length;
          const div = document.createElement('div');
          div.className = 'assignment-card';
          div.innerHTML = `
            <h4>${a.title}</h4>
            <p>${a.description}</p>
            <p><strong>Subject:</strong> ${a.subject} | <strong>Due:</strong> ${new Date(a.dueDate).toLocaleDateString()}</p>
            <p><strong>Submissions:</strong> ${submissions_count}</p>
            <button onclick="viewSubmissions('${a.id}')" style="width: auto; background: var(--main-blue); color: white;">üìã View Submissions</button>
          `;
          container.appendChild(div);
        });
      }
    } else if(role === "student") {
      const studentAssignments = assignments.filter(a => 
        a.section === currentUserData.section && new Date(a.dueDate) >= new Date()
      );
      
      if(studentAssignments.length === 0) {
        container.innerHTML = "<p>No pending assignments. Great job! üéâ</p>";
      } else {
        studentAssignments.forEach(a => {
          const submission = submissions.find(s => s.assignmentId === a.id && s.student === currentUser);
          let status = 'pending';
          let statusText = '‚è≥ Pending';
          let grade = '';
          
          if(submission) {
            status = submission.graded ? 'graded' : 'submitted';
            statusText = submission.graded ? '‚úÖ Graded' : 'üì§ Submitted';
            grade = submission.graded ? `<br><strong>Grade: ${submission.grade}/${a.points}</strong>` : '';
          } else if(new Date(a.dueDate) < new Date()) {
            status = 'late';
            statusText = '‚ö†Ô∏è Late';
          }
          
          const div = document.createElement('div');
          div.className = 'assignment-card';
          div.innerHTML = `
            <div style="display: flex; justify-content: space-between; align-items: start;">
              <div>
                <h4>${a.title}</h4>
                <p>${a.description}</p>
                <p><strong>Subject:</strong> ${a.subject} | <strong>Due:</strong> ${new Date(a.dueDate).toLocaleDateString()}</p>
                <span class="assignment-status ${status}">${statusText}</span>
                ${grade}
              </div>
              ${!submission ? `
                <button onclick="submitAssignment('${a.id}')" style="width: auto; background: #28a745; color: white;">üì§ Submit</button>
              ` : ''}
            </div>
          `;
          container.appendChild(div);
        });
      }
    }
  }
  
  function renderQuizzes() {
    const container = document.getElementById('quizzesContainer');
    if(!container) return;
    
    container.innerHTML = '';
    
    const quizzes = window.realtimeQuizzes || [];
    const results = window.realtimeQuizResults || [];
    
    if(role === "teacher") {
      const teacherQuizzes = quizzes.filter(q => q.teacher === currentUser);
      if(teacherQuizzes.length === 0) {
        container.innerHTML = "<p>No quizzes created yet.</p>";
      } else {
        teacherQuizzes.forEach(q => {
          const quizResults = results.filter(r => r.quizId === q.id);
          const avg = quizResults.length ? (quizResults.reduce((a,b) => a + b.score, 0) / quizResults.length).toFixed(2) : 'N/A';
          
          const div = document.createElement('div');
          div.className = 'assignment-card';
          div.innerHTML = `
            <h4>${q.title}</h4>
            <p><strong>Subject:</strong> ${q.subject} | <strong>Questions:</strong> ${q.questions?.length || 0}</p>
            <p><strong>Participants:</strong> ${quizResults.length} | <strong>Average:</strong> ${avg}%</p>
            <button onclick="viewQuizResults('${q.id}')" style="width: auto; background: var(--main-blue); color: white;">üìä Results</button>
          `;
          container.appendChild(div);
        });
      }
    } else if(role === "student") {
      const availableQuizzes = quizzes.filter(q => 
        q.section === currentUserData.section && 
        new Date(q.startTime) <= new Date() && 
        new Date(q.endTime) >= new Date()
      );
      
      if(availableQuizzes.length === 0) {
        container.innerHTML = "<p>No available quizzes at the moment.</p>";
      } else {
        availableQuizzes.forEach(q => {
          const taken = results.find(r => r.quizId === q.id && r.student === currentUser);
          const div = document.createElement('div');
          div.className = 'assignment-card';
          
          if(!taken) {
            div.innerHTML = `
              <h4>${q.title}</h4>
              <p><strong>Subject:</strong> ${q.subject} | <strong>Duration:</strong> ${q.duration} minutes</p>
              <p><strong>Questions:</strong> ${q.questions?.length || 0} | <strong>Ends:</strong> ${new Date(q.endTime).toLocaleString()}</p>
              <button onclick="startQuiz('${q.id}')" style="background: #28a745; color: white;">‚ñ∂Ô∏è Start Quiz</button>
            `;
          } else {
            div.innerHTML = `
              <h4>${q.title} ‚úÖ</h4>
              <p><strong>Score:</strong> ${taken.score}% | <strong>Submitted:</strong> ${new Date(taken.submittedAt).toLocaleString()}</p>
            `;
          }
          container.appendChild(div);
        });
      }
    }
  }
  
  function renderCourseMaterials() {
    const container = document.getElementById('materialsContainer');
    if(!container) return;
    
    container.innerHTML = '';
    const materials = window.realtimeMaterials || [];
    const subjects = ["3I's","Genchem 2","P6 2","Perdev","CPAR","Entrepreneurship"];
    
    let hasMaterials = false;
    subjects.forEach(sub => {
      const subMaterials = materials.filter(m => m.subject === sub && (m.section === 'all' || m.section === currentUserData.section));
      if(subMaterials.length > 0) {
        hasMaterials = true;
        const header = document.createElement('h4');
        header.textContent = sub;
        container.appendChild(header);
        
        subMaterials.forEach(m => {
          const div = document.createElement('div');
          div.style.cssText = 'padding: 15px; border: 2px solid #dee2e6; border-radius: 10px; margin: 10px 0;';
          div.innerHTML = `
            <h5>${m.title}</h5>
            <p>${m.description}</p>
            <p style="font-size: 12px; color: #666;">Uploaded: ${new Date(m.uploadedAt).toLocaleDateString()}</p>
            <a href="${m.fileUrl}" download style="display: inline-block; padding: 8px 15px; background: var(--main-blue); color: white; border-radius: 5px; text-decoration: none; margin-top: 10px;">‚¨áÔ∏è Download</a>
          `;
          container.appendChild(div);
        });
      }
    });
    
    if(!hasMaterials) {
      container.innerHTML = '<p>No materials uploaded yet.</p>';
    }
  }
  
  function renderConferences() {
    const container = document.getElementById('conferencesContainer');
    if(!container) return;
    
    container.innerHTML = '';
    const conferences = window.realtimeConferences || [];
    
    if(role === "teacher") {
      const teacherConferences = conferences.filter(c => c.teacher === currentUser);
      const upcoming = teacherConferences.filter(c => new Date(c.dateTime) >= new Date());
      
      if(upcoming.length > 0) {
        const header = document.createElement('h4');
        header.textContent = 'Upcoming Conferences';
        container.appendChild(header);
        
        upcoming.forEach(c => {
          const div = document.createElement('div');
          div.className = 'conference-slot booked';
          div.innerHTML = `
            <div>
              <strong>${c.parent || 'Unknown'}</strong><br>
              <small>${new Date(c.dateTime).toLocaleString()}</small>
            </div>
            <span style="background: #dc3545; color: white; padding: 5px 15px; border-radius: 20px; font-size: 12px;">Booked</span>
          `;
          container.appendChild(div);
        });
      } else {
        container.innerHTML = '<p>No upcoming conferences.</p>';
      }
    } else if(role === "parent") {
      const availableSlots = conferences.filter(c => c.status === 'available');
      const myConferences = conferences.filter(c => c.parent === currentUser && c.status === 'booked');
      
      if(availableSlots.length > 0) {
        const header = document.createElement('h4');
        header.textContent = 'Available Slots';
        container.appendChild(header);
        
        availableSlots.forEach(c => {
          const div = document.createElement('div');
          div.className = 'conference-slot available';
          div.innerHTML = `
            <div>
              <strong>${c.teacher}</strong><br>
              <small>${new Date(c.dateTime).toLocaleString()}</small>
            </div>
            <button onclick="bookConference('${c.id}')" style="width: auto; background: #28a745; color: white;">Book</button>
          `;
          container.appendChild(div);
        });
      }
      
      if(myConferences.length > 0) {
        const header = document.createElement('h4');
        header.textContent = 'Your Booked Conferences';
        container.appendChild(header);
        
        myConferences.forEach(c => {
          const div = document.createElement('div');
          div.className = 'conference-slot booked';
          div.innerHTML = `
            <div>
              <strong>${c.teacher}</strong><br>
              <small>${new Date(c.dateTime).toLocaleString()}</small>
            </div>
            <button onclick="cancelConference('${c.id}')" style="width: auto; background: #dc3545; color: white;">Cancel</button>
          `;
          container.appendChild(div);
        });
      }
      
      if(availableSlots.length === 0 && myConferences.length === 0) {
        container.innerHTML = '<p>No available slots at the moment. Please check back later.</p>';
      }
    }
  }
  
  function renderBehaviorReports() {
    const container = document.getElementById('behaviorContainer');
    if(!container) return;
    
    const logs = window.realtimeBehaviorLog || {};
    
    if(role === "teacher") {
      const recentRecords = [];
      Object.entries(logs).forEach(([student, entries]) => {
        entries.forEach(entry => {
          recentRecords.push({...entry, student});
        });
      });
      
      recentRecords.sort((a,b) => new Date(b.date) - new Date(a.date));
      
      if(recentRecords.length > 0) {
        const header = document.createElement('h4');
        header.textContent = 'Recent Records';
        container.appendChild(header);
        
        recentRecords.slice(0, 10).forEach(r => {
          const div = document.createElement('div');
          div.className = `behavior-item ${r.type}`;
          div.innerHTML = `
            <div class="behavior-points">${r.type === 'merit' ? '+' : '-'}${r.points}</div>
            <div style="flex: 1;">
              <strong>${r.student}</strong> - ${r.reason}<br>
              <small>${new Date(r.date).toLocaleDateString()}</small>
            </div>
          `;
          container.appendChild(div);
        });
      }
    } else {
      let targetStudent = currentUser;
      if(role === "parent") {
        targetStudent = currentUserData.childName || currentUser;
      }
      
      const studentLogs = logs[targetStudent] || [];
      const totalPoints = studentLogs.reduce((acc, entry) => {
        return acc + (entry.type === 'merit' ? entry.points : -entry.points);
      }, 0);
      
      const perfBox = document.createElement('div');
      perfBox.className = 'performance-box';
      perfBox.style.background = totalPoints >= 0 ? 'linear-gradient(135deg, #28a745 0%, #20c997 100%)' : 'linear-gradient(135deg, #dc3545 0%, #fd7e14 100%)';
      perfBox.innerHTML = `
        <h3>Behavior Points</h3>
        <div class="stat-number">${totalPoints > 0 ? '+' : ''}${totalPoints}</div>
        <p>${totalPoints >= 20 ? 'üèÜ Excellent Conduct' : totalPoints >= 0 ? 'üëç Good Standing' : '‚ö†Ô∏è Needs Improvement'}</p>
      `;
      container.appendChild(perfBox);
      
      if(studentLogs.length > 0) {
        const header = document.createElement('h4');
        header.textContent = 'Record History';
        container.appendChild(header);
        
        studentLogs.sort((a,b) => new Date(b.date) - new Date(a.date));
        studentLogs.forEach(entry => {
          const div = document.createElement('div');
          div.className = `behavior-item ${entry.type}`;
          div.innerHTML = `
            <div class="behavior-points">${entry.type === 'merit' ? '+' : '-'}${entry.points}</div>
            <div style="flex: 1;">
              <strong>${entry.reason}</strong><br>
              <small>${new Date(entry.date).toLocaleDateString()} by ${entry.teacher}</small>
            </div>
          `;
          container.appendChild(div);
        });
      }
    }
  }
  
  function renderHonorRoll() {
    const container = document.getElementById('honorRollContainer');
    if(!container) return;
    
    container.innerHTML = '';
    
    const students = window.realtimeStudents || [];
    const gradesData = window.realtimeGrades || {};
    
    const rankings = students.map(s => {
      const grades = gradesData[s.name] || {};
      const gradeValues = Object.values(grades);
      const avg = gradeValues.length ? (gradeValues.reduce((a,b) => a+b, 0) / gradeValues.length) : 0;
      return {...s, average: avg};
    }).sort((a,b) => b.average - a.average);
    
    const withHighestHonors = rankings.filter(s => s.average >= 98);
    const withHighHonors = rankings.filter(s => s.average >= 95 && s.average < 98);
    const withHonors = rankings.filter(s => s.average >= 90 && s.average < 95);
    
    if(withHighestHonors.length > 0) {
      const div = document.createElement('div');
      div.className = 'honor-roll';
      div.innerHTML = `
        <h4>ü•á With Highest Honors (98-100)</h4>
        <ul class="honor-roll-list">
          ${withHighestHonors.map(s => `
            <li>
              <span>${s.name} - ${s.average.toFixed(2)}%</span>
              <span class="honor-badge">Highest Honors</span>
            </li>
          `).join('')}
        </ul>
      `;
      container.appendChild(div);
    }
    
    if(withHighHonors.length > 0) {
      const div = document.createElement('div');
      div.className = 'honor-roll';
      div.style.cssText = 'background: linear-gradient(135deg, #c0c0c0 0%, #e8e8e8 100%); border-color: #808080;';
      div.innerHTML = `
        <h4 style="color: #555;">ü•à With High Honors (95-97)</h4>
        <ul class="honor-roll-list">
          ${withHighHonors.map(s => `
            <li>
              <span>${s.name} - ${s.average.toFixed(2)}%</span>
              <span class="honor-badge" style="background: #808080;">High Honors</span>
            </li>
          `).join('')}
        </ul>
      `;
      container.appendChild(div);
    }
    
    if(withHonors.length > 0) {
      const div = document.createElement('div');
      div.className = 'honor-roll';
      div.style.cssText = 'background: linear-gradient(135deg, #cd7f32 0%, #daa520 100%); border-color: #8b4513;';
      div.innerHTML = `
        <h4 style="color: #8b4513;">ü•â With Honors (90-94)</h4>
        <ul class="honor-roll-list">
          ${withHonors.map(s => `
            <li>
              <span>${s.name} - ${s.average.toFixed(2)}%</span>
              <span class="honor-badge" style="background: #8b4513;">Honors</span>
            </li>
          `).join('')}
        </ul>
      `;
      container.appendChild(div);
    }
    
    if(role === "student") {
      const myRank = rankings.findIndex(s => s.name === currentUser) + 1;
      const myData = rankings.find(s => s.name === currentUser);
      
      const div = document.createElement('div');
      div.className = 'section';
      div.style.cssText = 'margin-top: 30px; text-align: center;';
      div.innerHTML = `
        <h4>Your Ranking</h4>
        <div style="font-size: 48px; font-weight: bold; color: var(--main-blue);">#${myRank}</div>
        <p>out of ${rankings.length} students</p>
        <p><strong>General Average:</strong> ${myData?.average.toFixed(2)}%</p>
      `;
      container.appendChild(div);
    }
  }
  
  function renderPayments() {
    const container = document.getElementById('paymentsContainer');
    if(!container) return;
    
    container.innerHTML = '';
    const payments = window.realtimePayments || [];
    
    let targetUser = currentUser;
    if(role === "parent") {
      targetUser = currentUserData.childName || currentUser;
    }
    
    const myPayments = payments.filter(p => p.student === targetUser);
    const balance = 15000 - myPayments.reduce((a,p) => a + p.amount, 0);
    
    const perfBox = document.createElement('div');
    perfBox.className = 'performance-box';
    perfBox.style.background = balance > 0 ? 'linear-gradient(135deg, #dc3545 0%, #fd7e14 100%)' : 'linear-gradient(135deg, #28a745 0%, #20c997 100%)';
    perfBox.innerHTML = `
      <h3>Outstanding Balance</h3>
      <div class="stat-number">‚Ç±${balance.toLocaleString()}</div>
      <p>${balance > 0 ? 'Please settle your balance' : '‚úÖ Fully Paid'}</p>
    `;
    container.appendChild(perfBox);
    
    if(balance > 0 && role !== 'admin') {
      const paymentSection = document.createElement('div');
      paymentSection.innerHTML = `
        <h4>Make Payment</h4>
        <div class="payment-method" onclick="selectPayment(this, 'gcash')">
          <span class="payment-icon">üì±</span>
          <div>
            <strong>GCash</strong>
            <p style="margin: 0; font-size: 12px; color: #666;">Pay via GCash e-wallet</p>
          </div>
        </div>
        <div class="payment-method" onclick="selectPayment(this, 'bank')">
          <span class="payment-icon">üè¶</span>
          <div>
            <strong>Bank Transfer</strong>
            <p style="margin: 0; font-size: 12px; color: #666;">BDO, BPI, Metrobank</p>
          </div>
        </div>
        <div class="payment-method" onclick="selectPayment(this, 'card')">
          <span class="payment-icon">üí≥</span>
          <div>
            <strong>Credit/Debit Card</strong>
            <p style="margin: 0; font-size: 12px; color: #666;">Visa, Mastercard</p>
          </div>
        </div>
        <input type="number" id="paymentAmount" placeholder="Amount to pay" max="${balance}">
        <button onclick="processPayment()" style="background: #28a745; color: white; margin-top: 10px;">üí≥ Pay Now</button>
      `;
      container.appendChild(paymentSection);
    }
    
    if(myPayments.length > 0) {
      const historyHeader = document.createElement('h4');
      historyHeader.textContent = 'Payment History';
      container.appendChild(historyHeader);
      
      myPayments.sort((a,b) => new Date(b.date) - new Date(a.date));
      myPayments.forEach(p => {
        const div = document.createElement('div');
        div.className = 'payment-history-item';
        div.innerHTML = `
          <div>
            <strong>${p.method.toUpperCase()}</strong><br>
            <small>${new Date(p.date).toLocaleDateString()}</small>
          </div>
          <div style="text-align: right;">
            <strong>‚Ç±${p.amount.toLocaleString()}</strong><br>
            <span class="payment-status paid">‚úÖ Paid</span>
          </div>
        `;
        container.appendChild(div);
      });
    }
  }
  
  function renderScheduleTable(section) {
    const container = document.getElementById('scheduleTable');
    if(!container) return;
    
    let tableHTML = `
      <table>
        <thead>
          <tr>
            <th>Time / Day</th>
            ${WEEKLY_SCHEDULE.days.map(day => `<th>${day}</th>`).join('')}
          </tr>
        </thead>
        <tbody>
    `;
    
    WEEKLY_SCHEDULE.periods.forEach(period => {
      const rowClass = period.type === 'break' ? (period.name === 'Lunch' ? 'lunch' : 'recess') : '';
      tableHTML += `
        <tr class="${rowClass}">
          <td class="time-slot">
            <strong>${period.name}</strong><br>
            <small>${period.time}</small>
          </td>
      `;
      
      if(period.type === 'break') {
        tableHTML += `<td colspan="5" style="text-align: center; font-weight: bold;">${period.name}</td>`;
      } else {
        WEEKLY_SCHEDULE.days.forEach(day => {
          const subject = getSubjectForSchedule(section, day, period.name);
          tableHTML += `<td>${subject}</td>`;
        });
      }
      
      tableHTML += '</tr>';
    });
    
    tableHTML += '</tbody></table>';
    container.innerHTML = tableHTML;
  }
  
  function getSubjectForSchedule(section, day, period) {
    const subjects = ["3I's","Genchem 2","P6 2","Perdev","CPAR","Entrepreneurship"];
    const index = (day.charCodeAt(0) + period.charCodeAt(0)) % subjects.length;
    return subjects[index];
  }
  
  function renderAttendanceStats(attendanceData) {
    const container = document.getElementById('attendanceStats');
    if(!container) return;
    
    const dates = Object.keys(attendanceData);
    const presentDays = dates.filter(d => attendanceData[d] === 'P').length;
    const absentDays = dates.filter(d => attendanceData[d] === 'A').length;
    const percentage = dates.length > 0 ? Math.round((presentDays / dates.length) * 100) : 0;
    
    container.innerHTML = `
      <h3>üìà Your Attendance Performance</h3>
      <div class="performance-stats">
        <div class="stat-item"><div class="stat-number">${presentDays}</div><div class="stat-label">‚úÖ Present</div></div>
        <div class="stat-item"><div class="stat-number">${absentDays}</div><div class="stat-label">‚ùå Absent</div></div>
        <div class="stat-item"><div class="stat-number">${percentage}%</div><div class="stat-label">üìä Rate</div></div>
      </div>
    `;
  }
  
  function renderPlanner() {
    const container = document.getElementById('plannerContainer');
    if(!container) return;
    
    container.innerHTML = '';
    const planner = window.realtimePlanner || { daily: [], weekly: [], monthly: [] };
    
    const dailySection = document.createElement('div');
    dailySection.className = 'planner-section';
    dailySection.innerHTML = '<h4>üìÖ Daily Goals</h4>';
    
    (planner.daily || []).forEach((goal, index) => {
      const item = document.createElement('div');
      item.className = 'planner-item' + (goal.completed ? ' completed' : '');
      item.innerHTML = `
        <input type="checkbox" ${goal.completed ? 'checked' : ''} onchange="togglePlannerGoal('daily', ${index})">
        <span class="goal-text">${goal.text}</span>
        <span class="goal-time">${goal.time || ''}</span>
        <button class="alarm-btn" onclick="setAlarm('${goal.time}')">‚è∞</button>
        <button onclick="deletePlannerGoal('daily', ${index})" style="width:auto;background:#dc3545;color:white;padding:6px 10px;">√ó</button>
      `;
      dailySection.appendChild(item);
    });
    
    dailySection.innerHTML += `
      <input type="text" id="dailyGoalInput" placeholder="Add daily goal..." style="width:55%;">
      <input type="time" id="dailyGoalTime" style="width:auto;">
      <button onclick="addPlannerGoal('daily')" style="width:auto;background:#28a745;color:white;">‚ûï Add</button>
    `;
    container.appendChild(dailySection);
    
    const weeklySection = document.createElement('div');
    weeklySection.className = 'planner-section';
    weeklySection.innerHTML = '<h4>üìÜ Weekly Goals</h4>';
    
    (planner.weekly || []).forEach((goal, index) => {
      const item = document.createElement('div');
      item.className = 'planner-item' + (goal.completed ? ' completed' : '');
      item.innerHTML = `
        <input type="checkbox" ${goal.completed ? 'checked' : ''} onchange="togglePlannerGoal('weekly', ${index})">
        <span class="goal-text">${goal.text}</span>
        <span class="goal-time">${goal.time || ''}</span>
        <button onclick="deletePlannerGoal('weekly', ${index})" style="width:auto;background:#dc3545;color:white;padding:6px 10px;">√ó</button>
      `;
      weeklySection.appendChild(item);
    });
    
    weeklySection.innerHTML += `
      <input type="text" id="weeklyGoalInput" placeholder="Add weekly goal..." style="width:55%;">
      <input type="date" id="weeklyGoalDate" style="width:auto;">
      <button onclick="addPlannerGoal('weekly')" style="width:auto;background:#28a745;color:white;">‚ûï Add</button>
    `;
    container.appendChild(weeklySection);
    
    const monthlySection = document.createElement('div');
    monthlySection.className = 'planner-section';
    monthlySection.innerHTML = '<h4>üìÜ Monthly Goals</h4>';
    
    (planner.monthly || []).forEach((goal, index) => {
      const item = document.createElement('div');
      item.className = 'planner-item' + (goal.completed ? ' completed' : '');
      item.innerHTML = `
        <input type="checkbox" ${goal.completed ? 'checked' : ''} onchange="togglePlannerGoal('monthly', ${index})">
        <span class="goal-text">${goal.text}</span>
        <span class="goal-time">${goal.time || ''}</span>
        <button onclick="deletePlannerGoal('monthly', ${index})" style="width:auto;background:#dc3545;color:white;padding:6px 10px;">√ó</button>
      `;
      monthlySection.appendChild(item);
    });
    
    monthlySection.innerHTML += `
      <input type="text" id="monthlyGoalInput" placeholder="Add monthly goal..." style="width:55%;">
      <input type="date" id="monthlyGoalDate" style="width:auto;">
      <button onclick="addPlannerGoal('monthly')" style="width:auto;background:#28a745;color:white;">‚ûï Add</button>
    `;
    container.appendChild(monthlySection);
  }
  
  function renderPendingStudents(section, students) {
    const header = section.querySelector('h3');
    section.innerHTML = '';
    section.appendChild(header);
    
    if(students.length === 0) {
      section.innerHTML += "<p>‚úÖ No pending approvals.</p>";
    } else {
      students.forEach(function(s){
        const div = document.createElement("div");
        div.style.cssText = 'padding: 15px; border: 2px solid #ddd; margin-bottom: 10px; border-radius: 10px; background: #fff3cd;';
        div.innerHTML = `
          <p><strong>üë§ Name:</strong> ${s.name}</p>
          <p><strong>üÜî ID:</strong> ${s.studentId}</p>
          <p><strong>üè´ Section:</strong> ${s.section}</p>
          <button onclick="approveStudent('${s.id}')" style="background: #28a745; color: white; width: auto; padding: 10px 20px; margin-right: 10px;">‚úÖ Approve</button>
          <button onclick="rejectStudent('${s.id}')" style="background: #dc3545; color: white; width: auto; padding: 10px 20px;">üóëÔ∏è Reject</button>
        `;
        section.appendChild(div);
      });
    }
  }
  
  function renderAllStudents() {
    const container = document.getElementById('studentsContainer');
    if(!container) return;
    
    const students = window.realtimeAllStudents || [];
    const filter = document.getElementById('filterSection')?.value || 'all';
    
    container.innerHTML = '';
    
    let filteredStudents = students;
    if(filter !== "all") {
      filteredStudents = students.filter(s => s.section === filter);
    }
    
    const sections = [...new Set(students.map(s => s.section))];
    const filterSelect = document.getElementById('filterSection');
    if(filterSelect && filterSelect.options.length <= 1) {
      sections.forEach(sec => {
        const opt = document.createElement("option");
        opt.value = sec;
        opt.innerText = sec;
        filterSelect.appendChild(opt);
      });
    }
    
    filteredStudents.forEach(function(s){
      const idCard = document.createElement("div");
      idCard.className = "id-card";
      idCard.innerHTML = '<input type="checkbox" class="id-card-checkbox" data-student-id="' + s.id + '">' +
        '<div class="id-card-header"><h3 style="margin:0;">üéì DUMINGAG SENIOR HIGH SCHOOL</h3><p style="margin:0;font-size:11px;">Student ID Card</p></div>' +
        '<div class="id-card-photo" style="font-size: 36px;">üë§</div>' +
        '<div class="id-card-info"><p><strong>Name:</strong> ' + s.name + '</p><p><strong>ID No:</strong> ' + s.studentId + '</p>' +
        '<p><strong>Section:</strong> ' + s.section + '</p><p><strong>Track:</strong> ' + s.track + '</p>' +
        '<p><strong>Strand:</strong> ' + s.strand + '</p><p><strong>Grade:</strong> ' + s.gradeLevel + '</p></div>' +
        '<div class="id-card-footer">üéì Dumingag Senior High School - Dumingag, Zamboanga del Sur</div>' +
        '<div id="qr-' + s.id + '" style="text-align:center;margin-top:12px;"></div>';
      
      container.appendChild(idCard);
      
      setTimeout(function(){
        try {
          new QRCode(document.getElementById("qr-" + s.id), {
            text: s.name + "-" + s.studentId,
            width: 65,
            height: 65
          });
        } catch(e) {
          console.error('QR generation error:', e);
        }
      }, 100);
    });
  }
  
  function renderParentAccounts() {
    const container = document.getElementById('parentContainer');
    if(!container) return;
    
    const accounts = window.realtimeParentAccounts || [];
    const filter = document.getElementById('filterParentSection')?.value || 'all';
    
    container.innerHTML = '';
    
    let filteredAccounts = accounts;
    if(filter !== "all") {
      filteredAccounts = accounts.filter(p => p.section === filter);
    }
    
    const sections = [...new Set(accounts.map(p => p.section))];
    const filterSelect = document.getElementById('filterParentSection');
    if(filterSelect && filterSelect.options.length <= 1) {
      sections.forEach(sec => {
        const opt = document.createElement("option");
        opt.value = sec;
        opt.innerText = sec;
        filterSelect.appendChild(opt);
      });
    }
    
    if(filteredAccounts.length === 0) {
      container.innerHTML = "<p>‚ùå No parent accounts found.</p>";
      return;
    }
    
    filteredAccounts.forEach(function(p){
      const card = document.createElement("div");
      card.className = "parent-account-card";
      card.innerHTML = '<h4>üë§ ' + p.studentName + '</h4>' +
        '<p><strong>üÜî Student ID:</strong> ' + p.studentId + '</p>' +
        '<p><strong>üè´ Section:</strong> ' + p.section + '</p>' +
        '<div class="credentials">' +
        '<p><strong>üë®‚Äçüíº Parent Email:</strong> ' + p.parentEmail + '</p>' +
        '<p><strong>üîë Parent Password:</strong> ' + p.parentPassword + '</p>' +
        '</div>';
      container.appendChild(card);
    });
  }
  
  function renderManageUsers(allUsers) {
    const container = document.getElementById('manageUsersContainer');
    if(!container) return;
    
    container.innerHTML = '';
    
    const students = allUsers.filter(u => u.role === 'student');
    const teachers = allUsers.filter(u => u.role === 'teacher');
    
    const studentsHeader = document.createElement('h4');
    studentsHeader.textContent = 'üë®‚Äçüéì Students';
    container.appendChild(studentsHeader);
    
    const studentsTable = document.createElement("table");
    studentsTable.innerHTML = "<tr><th>Name</th><th>ID</th><th>Section</th><th>Teacher</th><th>Action</th></tr>";
    students.forEach(function(s){
      const tr = document.createElement("tr");
      tr.innerHTML = '<td>' + s.name + '</td><td>' + s.studentId + '</td><td>' + s.section + '</td><td>' + (s.teacherName || 'Not Assigned') + '</td>' +
        '<td><button onclick="deleteUser(\'' + s.id + '\')" style="background:#dc3545;color:white;width:auto;padding:6px 12px;">üóëÔ∏è Delete</button></td>';
      studentsTable.appendChild(tr);
    });
    container.appendChild(studentsTable);
    
    const teachersHeader = document.createElement('h4');
    teachersHeader.style.marginTop = '25px';
    teachersHeader.textContent = 'üë®‚Äçüè´ Teachers';
    container.appendChild(teachersHeader);
    
    const teachersTable = document.createElement("table");
    teachersTable.innerHTML = "<tr><th>Name</th><th>ID</th><th>Section</th><th>Action</th></tr>";
    teachers.forEach(function(t){
      const tr = document.createElement("tr");
      tr.innerHTML = '<td>' + t.name + '</td><td>' + t.id + '</td><td>' + t.sectionHandled + '</td>' +
        '<td><button onclick="deleteUser(\'' + t.id + '\')" style="background:#dc3545;color:white;width:auto;padding:6px 12px;">üóëÔ∏è Delete</button></td>';
      teachersTable.appendChild(tr);
    });
    container.appendChild(teachersTable);
  }
  
  function renderAnalytics(data) {
    const container = document.getElementById('analyticsContainer');
    if(!container) return;
    
    container.innerHTML = `
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px;">
        <div class="analytics-card">
          <div class="analytics-number">${data.totalStudents || 0}</div>
          <div class="analytics-label">Total Students</div>
        </div>
        <div class="analytics-card">
          <div class="analytics-number">${data.totalTeachers || 0}</div>
          <div class="analytics-label">Teachers</div>
        </div>
        <div class="analytics-card">
          <div class="analytics-number">${data.totalParents || 0}</div>
          <div class="analytics-label">Parents</div>
        </div>
        <div class="analytics-card">
          <div class="analytics-number">${data.pendingApprovals || 0}</div>
          <div class="analytics-label">Pending Approvals</div>
        </div>
      </div>
    `;
    
    if(data.trackDistribution) {
      const trackData = data.trackDistribution;
      const totalStudents = data.totalStudents || 1;
      
      const chartDiv = document.createElement('div');
      chartDiv.className = 'chart-container';
      chartDiv.innerHTML = `
        <h4>Enrollment by Track</h4>
        <div style="margin-top: 20px;">
          ${Object.entries(trackData).map(([track, count]) => `
            <div style="margin: 10px 0;">
              <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                <span>${track}</span>
                <span><strong>${count}</strong> students</span>
              </div>
              <div style="background: #e9ecef; height: 30px; border-radius: 15px; overflow: hidden;">
                <div style="background: linear-gradient(90deg, var(--main-red), var(--main-blue)); height: 100%; width: ${(count/totalStudents*100)}%; display: flex; align-items: center; justify-content: center; color: white; font-size: 12px; font-weight: bold;">
                  ${Math.round(count/totalStudents*100)}%
                </div>
              </div>
            </div>
          `).join('')}
        </div>
      `;
      container.appendChild(chartDiv);
    }
  }
  
  function renderTranscript(grades) {
    const container = document.getElementById('transcriptContainer');
    if(!container) return;
    
    const subjects = ["3I's","Genchem 2","P6 2","Perdev","CPAR","Entrepreneurship"];
    
    container.innerHTML = `
      <div class="transcript-header">
        <h2>DUMINGAG SENIOR HIGH SCHOOL</h2>
        <h3>OFFICIAL TRANSCRIPT OF RECORDS</h3>
        <div class="transcript-seal">OFFICIAL</div>
      </div>
      <div style="margin: 20px 0;">
        <p><strong>Student Name:</strong> ${currentUserData.name}</p>
        <p><strong>Student ID:</strong> ${currentUserData.studentId}</p>
        <p><strong>Track/Strand:</strong> ${currentUserData.track} - ${currentUserData.strand}</p>
        <p><strong>Date of Graduation:</strong> June 2024</p>
      </div>
      <h4>Academic Record</h4>
      <table>
        <tr><th>Subject</th><th>Grade 11</th><th>Grade 12</th><th>Final</th></tr>
        ${subjects.map(sub => {
          const g11Grade = Math.floor(Math.random() * 15) + 85;
          const g12Grade = grades[sub] || 0;
          const final = Math.round((g11Grade + g12Grade) / 2);
          return `
            <tr>
              <td>${sub}</td>
              <td>${g11Grade}</td>
              <td>${g12Grade}</td>
              <td><strong>${final}</strong></td>
            </tr>
          `;
        }).join('')}
      </table>
      <div style="margin-top: 40px; text-align: center;">
        <p><em>This is to certify that the above is a true copy of the academic records of the student.</em></p>
        <div style="margin-top: 60px; display: flex; justify-content: space-around;">
          <div style="text-align: center;">
            <div style="border-top: 1px solid #333; width: 200px; margin: 0 auto; padding-top: 5px;">
              <strong>School Principal</strong><br>
              <small>Signature over Printed Name</small>
            </div>
          </div>
          <div style="text-align: center;">
            <div style="border-top: 1px solid #333; width: 200px; margin: 0 auto; padding-top: 5px;">
              <strong>Registrar</strong><br>
              <small>Signature over Printed Name</small>
            </div>
          </div>
        </div>
        <p style="margin-top: 30px; font-size: 12px; color: #666;">
          Date Issued: ${new Date().toLocaleDateString()}<br>
          Reference No: TR-${currentUserData.studentId}-${Date.now()}
        </p>
      </div>
    `;
  }
  
  //====== ATTENDANCE FUNCTIONS ======
  async function saveAttendance(student, date, status) {
    try {
      const attendanceRef = window.firebaseFns.doc(db, 'attendance', student);
      const doc = await window.firebaseFns.getDoc(attendanceRef);
      
      let data = {};
      if(doc.exists()) {
        data = doc.data();
      }
      
      data[date] = status;
      data.updatedAt = window.firebaseFns.serverTimestamp();
      
      await window.firebaseFns.setDoc(attendanceRef, data);
    } catch(error) {
      console.error('Error saving attendance:', error);
    }
  }
  
  async function loadAttendance(student) {
    try {
      const doc = await window.firebaseFns.getDoc(window.firebaseFns.doc(db, 'attendance', student));
      return doc.exists() ? doc.data() : {};
    } catch(error) {
      console.error('Error loading attendance:', error);
      return {};
    }
  }
  
  //====== HELPER FUNCTIONS ======
  function getSubjectForSlot(section, day, period) {
    const subjects = ["3I's","Genchem 2","P6 2","Perdev","CPAR","Entrepreneurship"];
    const index = (day.charCodeAt(0) + period.charCodeAt(0)) % subjects.length;
    return subjects[index];
  }
  
  //====== PHOTO UPLOAD FUNCTIONS ======
  function triggerPhotoUpload() {
    document.getElementById('photoUpload').click();
  }
  
  async function handlePhotoUpload(event) {
    const file = event.target.files[0];
    if(!file) return;
    
    if(!file.type.startsWith('image/')) {
      alert('Please select an image file');
      return;
    }
    
    if(file.size > 5 * 1024 * 1024) {
      alert('File size must be less than 5MB');
      return;
    }
    
    try {
      document.getElementById('loadingOverlay').style.display = 'flex';
      document.getElementById('loadingStatus').textContent = 'Uploading photo...';
      
      const storageRef = window.firebaseFns.ref(storage, `profilePhotos/${currentUserId}`);
      await window.firebaseFns.uploadBytes(storageRef, file);
      const downloadURL = await window.firebaseFns.getDownloadURL(storageRef);
      
      await window.firebaseFns.setDoc(
        window.firebaseFns.doc(db, 'users', currentUserId),
        { photoURL: downloadURL },
        { merge: true }
      );
      
      currentUserData.photoURL = downloadURL;
      
      const photoDiv = document.getElementById('profilePhoto');
      photoDiv.innerHTML = `<img src="${downloadURL}" style="width: 100%; height: 100%; object-fit: cover;" />`;
      photoDiv.style.background = 'transparent';
      
      document.getElementById('loadingOverlay').style.display = 'none';
      alert('‚úÖ Photo uploaded successfully!');
      
    } catch(error) {
      document.getElementById('loadingOverlay').style.display = 'none';
      console.error('Error uploading photo:', error);
      alert('‚ùå Failed to upload photo. Please try again.');
    }
  }
  
  //====== RENDER FUNCTIONS ======
  function renderAttendanceCalendar(container, studentName) {
    const existingCalendar = document.getElementById("attendanceCalendar");
    if(existingCalendar) existingCalendar.remove();
    
    const calendar = document.createElement("div");
    calendar.id = "attendanceCalendar";
    calendar.className = "attendance-calendar";
    
    const days = ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"];
    days.forEach(function(day){
      const div = document.createElement("div");
      div.className = "attendance-day header";
      div.innerText = day;
      calendar.appendChild(div);
    });
    
    const dateInput = container.querySelector('input[type="month"]');
    const selectedDate = dateInput ? dateInput.value : new Date().toISOString().split("T")[0].substring(0, 7);
    const yearMonth = selectedDate.split("-");
    const year = yearMonth[0];
    const month = yearMonth[1];
    
    const daysInMonth = new Date(year, month, 0).getDate();
    const firstDay = new Date(year, month - 1, 1).getDay();
    
    for(let i = 0; i < firstDay; i++) {
      const div = document.createElement("div");
      div.className = "attendance-day";
      div.style.background = "#f9f9f9";
      calendar.appendChild(div);
    }
    
    loadAttendance(studentName).then(attendanceData => {
      for(let day = 1; day <= daysInMonth; day++) {
        const dateStr = year + "-" + month.padStart(2, '0') + "-" + day.toString().padStart(2, '0');
        const div = document.createElement("div");
        div.className = "attendance-day";
        div.innerText = day;
        
        const status = attendanceData[dateStr];
        if(status === "P") {
          div.classList.add("present");
          div.innerHTML += " ‚úÖ";
        } else if(status === "A") {
          div.classList.add("absent");
          div.innerHTML += " ‚ùå";
        }
        
        div.onclick = function(){
          if(role === "teacher" || role === "admin") {
            const currentStatus = attendanceData[dateStr];
            let newStatus;
            if(currentStatus === "P") {
              newStatus = "A";
            } else if(currentStatus === "A") {
              newStatus = null;
            } else {
              newStatus = "P";
            }
            
            if(newStatus) {
              attendanceData[dateStr] = newStatus;
              saveAttendance(studentName, dateStr, newStatus);
            } else {
              delete attendanceData[dateStr];
              saveAttendance(studentName, dateStr, null);
            }
            
            renderAttendanceCalendar(container, studentName);
          }
        };
        
        calendar.appendChild(div);
      }
    });
    
    container.appendChild(calendar);
    
    const legend = document.createElement("div");
    legend.className = "attendance-legend";
    legend.innerHTML = "<h4>üìã Legend</h4>" +
      "<p style='color:green;'>‚úÖ Present</p>" +
      "<p style='color:red;'>‚ùå Absent</p>" +
      "<p style='font-size:12px;color:#666;margin-top:10px;'>" + ((role === "teacher" || role === "admin") ? "üëÜ Click to toggle" : "üëÅÔ∏è View only") + "</p>";
    container.appendChild(legend);
  }

  function renderGradesTable(container, studentName) {
    const existingTable = document.getElementById("gradesTable");
    if(existingTable) existingTable.remove();
    
    const showHistory = document.getElementById('showHistory')?.checked;
    
    const table = document.createElement("table");
    table.id = "gradesTable";
    
    const gradesData = window.realtimeGrades || {};
    const studentGrades = gradesData[studentName] || {};
    
    if(showHistory){
      table.innerHTML = "<tr><th>üìö Subject</th><th>Q1</th><th>Q2</th><th>Q3</th><th>Q4</th><th>üìä Current</th></tr>";
      
      const subjects = ["3I's","Genchem 2","P6 2","Perdev","CPAR","Entrepreneurship"];
      subjects.forEach(function(sub){
        const tr = document.createElement("tr");
        const grade = studentGrades[sub] || 0;
        
        tr.innerHTML = "<td>" + sub + "</td><td>-</td><td>-</td><td>-</td><td>-</td><td><strong>" + grade + "</strong></td>";
        table.appendChild(tr);
      });
    } else {
      table.innerHTML = "<tr><th>üìö Subject</th><th>üìä Grade</th><th>üìà Status</th></tr>";
      
      let total = 0;
      let count = 0;
      
      const subjects = ["3I's","Genchem 2","P6 2","Perdev","CPAR","Entrepreneurship"];
      subjects.forEach(function(sub){
        const tr = document.createElement("tr");
        const grade = studentGrades[sub] || 0;
        total += grade;
        count++;
        
        let status = "‚úÖ Passing";
        if(grade < 75) status = "‚ö†Ô∏è Needs Improvement";
        
        const editable = (role === "teacher" || role === "admin") ? "contenteditable" : "";
        const onblur = (role === "teacher" || role === "admin") ? " onblur=\"updateGradeFirebase('" + studentName + "', '" + sub + "', this.innerText)\"" : "";
        
        tr.innerHTML = "<td>" + sub + "</td><td " + editable + onblur + ">" + grade + "</td><td style='color:" + (grade >= 75 ? 'green' : 'red') + "'>" + status + "</td>";
        table.appendChild(tr);
      });
      
      const avgRow = document.createElement("tr");
      avgRow.innerHTML = "<td><strong>üìâ Average</strong></td><td><strong>" + (count > 0 ? (total / count).toFixed(2) : 0) + "</strong></td><td></td>";
      table.appendChild(avgRow);
    }
    
    container.appendChild(table);
  }
  
  async function updateGradeFirebase(student, subject, newGrade) {
    const grade = parseInt(newGrade);
    if(isNaN(grade) || grade < 0 || grade > 100) {
      alert("‚ö†Ô∏è Grade must be between 0 and 100.");
      loadSection("Grades");
      return;
    }
    
    try {
      const gradeRef = window.firebaseFns.doc(db, 'grades', student);
      const doc = await window.firebaseFns.getDoc(gradeRef);
      
      let data = {};
      if(doc.exists()) {
        data = doc.data();
      }
      
      data[subject] = grade;
      data.updatedAt = window.firebaseFns.serverTimestamp();
      data.updatedBy = currentUser;
      
      await window.firebaseFns.setDoc(gradeRef, data);
      
      const historyRef = window.firebaseFns.doc(db, 'gradeHistory', student);
      const historyDoc = await window.firebaseFns.getDoc(historyRef);
      let historyData = {};
      if(historyDoc.exists()) {
        historyData = historyDoc.data();
      }
      if(!historyData[subject]) historyData[subject] = [];
      historyData[subject].push({
        quarter: 1,
        grade: grade,
        date: new Date().toISOString(),
        updatedBy: currentUser
      });
      await window.firebaseFns.setDoc(historyRef, historyData);
      
      addNotification(`Your grade in ${subject} has been updated to ${grade}`, 'grade', student);
    } catch(error) {
      console.error('Error updating grade:', error);
      alert('‚ùå Failed to update grade');
    }
  }
  
  function toggleGradeHistory(){
    const studentSelect = document.getElementById('gradesStudentSelect');
    const studentName = studentSelect ? studentSelect.value : currentUser;
    renderGradesTable(document.querySelector('.section'), studentName);
  }

  function toggleSelectAllStudents() {
    const selectAll = document.getElementById("selectAllStudents");
    const checkboxes = document.querySelectorAll(".id-card-checkbox");
    checkboxes.forEach(function(cb){
      cb.checked = selectAll.checked;
    });
  }

  function printSelectedIDs() {
    const checkboxes = document.querySelectorAll(".id-card-checkbox:checked");
    if(checkboxes.length === 0) {
      alert("‚ö†Ô∏è Please select at least one student to print!");
      return;
    }
    window.print();
  }

  //====== ACTION FUNCTIONS ======
  async function approveStudent(studentId) {
    await setDocument('users', studentId, { approved: true });
    
    const studentDoc = await window.firebaseFns.getDoc(window.firebaseFns.doc(db, 'users', studentId));
    if(studentDoc.exists()) {
      const studentData = studentDoc.data();
      currentUserData = studentData;
      currentUserId = studentId;
      await syncStudentWithTeacher();
    }
    
    await updateAnalytics();
    
    addNotification('Your account has been approved!', 'approval', studentId);
    alert("‚úÖ Student approved and synced with teacher!");
  }

  async function rejectStudent(studentId) {
    if(confirm("‚ö†Ô∏è Are you sure you want to reject this student?")) {
      await window.firebaseFns.deleteDoc(window.firebaseFns.doc(db, 'users', studentId));
      
      await updateAnalytics();
      
      alert("üóëÔ∏è Student rejected");
    }
  }

  async function deleteUser(userId) {
    if(confirm("‚ö†Ô∏è Are you sure you want to delete this user?")) {
      await window.firebaseFns.deleteDoc(window.firebaseFns.doc(db, 'users', userId));
      
      await updateAnalytics();
      
      alert("üóëÔ∏è User deleted");
    }
  }

  async function createTeacher() {
    const name = document.getElementById("newTeacherName").value.trim();
    const id = document.getElementById("newTeacherID").value.trim();
    const position = document.getElementById("newTeacherPosition").value.trim();
    const section = document.getElementById("newTeacherSection").value.trim();
    const username = document.getElementById("newTeacherUsername").value.trim();
    const email = document.getElementById("newTeacherEmail").value.trim();
    const password = document.getElementById("newTeacherPassword").value.trim();
    
    if(!name || !username || !password || !section || !email) {
      alert("‚ö†Ô∏è Please fill in all required fields!");
      return;
    }
    
    const emailRegex = /^@[^\s@]+\.[^\s@]+$/;
    if(!emailRegex.test(email)) {
      alert("Please enter a valid email address");
      return;
    }
    
    if(password.length < 8) {
      alert("Password must be at least 8 characters");
      return;
    }
    
    try {
      const userCredential = await window.firebaseFns.createUserWithEmailAndPassword(auth, email, password);
      const teacherUid = userCredential.user.uid;
      
      await window.firebaseFns.setDoc(window.firebaseFns.doc(db, 'users', teacherUid), {
        uid: teacherUid,
        name: name,
        teacherId: id,
        position: position,
        sectionHandled: section,
        username: username,
        email: email,
        role: 'teacher',
        approved: true,
        createdAt: window.firebaseFns.serverTimestamp()
      });
      
      // Auto-sync existing students with same section to this teacher
      await syncStudentsToNewTeacher(section, teacherUid, name);
      
      await updateAnalytics();
      
      alert("‚úÖ Teacher account created successfully! Students in section " + section + " have been automatically linked.");
      document.getElementById("newTeacherName").value = "";
      document.getElementById("newTeacherID").value = "";
      document.getElementById("newTeacherPosition").value = "";
      document.getElementById("newTeacherSection").value = "";
      document.getElementById("newTeacherUsername").value = "";
      document.getElementById("newTeacherEmail").value = "";
      document.getElementById("newTeacherPassword").value = "";
    } catch(error) {
      alert("‚ùå " + error.message);
    }
  }
  
  // New function to sync students to newly created teacher
  async function syncStudentsToNewTeacher(section, teacherId, teacherName) {
    try {
      const studentsQuery = window.firebaseFns.query(
        window.firebaseFns.collection(db, 'users'),
        window.firebaseFns.where('role', '==', 'student'),
        window.firebaseFns.where('section', '==', section),
        window.firebaseFns.where('approved', '==', true)
      );
      
      const studentsSnapshot = await window.firebaseFns.getDocs(studentsQuery);
      
      if(!studentsSnapshot.empty) {
        const students = [];
        const batch = window.firebaseFns.writeBatch(db);
        
        studentsSnapshot.docs.forEach(doc => {
          const studentData = doc.data();
          students.push({
            id: doc.id,
            name: studentData.name,
            studentId: studentData.studentId,
            section: studentData.section,
            gradeLevel: studentData.gradeLevel,
            addedAt: new Date().toISOString()
          });
          
          // Update each student with teacher info
          const studentRef = window.firebaseFns.doc(db, 'users', doc.id);
          batch.update(studentRef, {
            teacherId: teacherId,
            teacherName: teacherName,
            syncedAt: window.firebaseFns.serverTimestamp()
          });
        });
        
        // Create teacherStudents document
        const teacherStudentsRef = window.firebaseFns.doc(db, 'teacherStudents', teacherId);
        batch.set(teacherStudentsRef, { students });
        
        await batch.commit();
        console.log(`Synced ${students.length} students to new teacher ${teacherName}`);
      }
    } catch(error) {
      console.error('Error syncing students to new teacher:', error);
    }
  }
  
  function updateSubject(index, newValue) {
    alert('Subject updated: ' + newValue);
  }

  function updateScheduleTime(subject, time) {
    alert('Schedule time updated for ' + subject + ': ' + time);
  }

  function deleteSubject(index) {
    if(confirm('Delete this subject?')) {
      alert('Subject deleted');
    }
  }

  function addSubject() {
    const name = document.getElementById("newSubjectName").value.trim();
    if(!name) {
      alert("‚ö†Ô∏è Please enter a subject name!");
      return;
    }
    alert('Subject added: ' + name);
    document.getElementById("newSubjectName").value = "";
  }

  //====== MESSAGING FUNCTIONS ======
  function selectContact(contact, element) {
    document.querySelectorAll('.contact-item').forEach(el => el.classList.remove('active'));
    element.classList.add('active');
    
    currentContact = contact;
    
    document.getElementById('chatHeader').innerHTML = `
      <div style="display: flex; align-items: center; gap: 10px;">
        <div class="contact-avatar" style="width: 35px; height: 35px; font-size: 18px;">${contact.avatar}</div>
        <div>${contact.name}</div>
      </div>
    `;
    
    document.getElementById('messageInput').disabled = false;
    document.getElementById('sendBtn').disabled = false;
    
    loadMessages(contact.username);
  }
  
  function loadMessages(contactUsername) {
    const chatMessages = document.getElementById('chatMessages');
    chatMessages.innerHTML = '';
    
    const messages = window.realtimeMessages || [];
    const conversation = messages.filter(m => 
      (m.sender === currentUser && m.recipient === contactUsername) ||
      (m.sender === contactUsername && m.recipient === currentUser)
    ).sort((a,b) => new Date(a.date) - new Date(b.date));
    
    if(conversation.length === 0){
      chatMessages.innerHTML = '<p style="text-align: center; color: #999; margin-top: 50px;">No messages yet. Start the conversation!</p>';
    } else {
      conversation.forEach(m => {
        const isSent = m.sender === currentUser;
        const msgDiv = document.createElement('div');
        msgDiv.className = 'message ' + (isSent ? 'sent' : 'received');
        msgDiv.innerHTML = `
          <div>${m.text}</div>
          <div class="message-time">${new Date(m.date).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</div>
        `;
        chatMessages.appendChild(msgDiv);
      });
    }
    
    chatMessages.scrollTop = chatMessages.scrollHeight;
  }
  
  async function sendMessage() {
    const input = document.getElementById('messageInput');
    const text = input.value.trim();
    
    if(!text || !currentContact) return;
    
    await addDocument('messages', {
      sender: currentUser,
      recipient: currentContact.username,
      text: text,
      date: new Date().toISOString(),
      read: false
    });
    
    input.value = '';
    addNotification(`New message from ${currentUser}`, 'message', currentContact.username);
  }
  
  document.addEventListener('keypress', function(e) {
    if(e.key === 'Enter' && document.getElementById('messageInput') === document.activeElement) {
      sendMessage();
    }
  });

  //====== PLANNER FUNCTIONS ======
  async function addPlannerGoal(type) {
    const input = document.getElementById(type + "GoalInput");
    const timeInput = document.getElementById(type + "GoalTime") || document.getElementById(type + "GoalDate");
    
    if(!input.value.trim()) {
      alert("‚ö†Ô∏è Please enter a goal!");
      return;
    }
    
    const plannerRef = window.firebaseFns.doc(db, 'planners', currentUserId);
    const doc = await window.firebaseFns.getDoc(plannerRef);
    
    let data = { daily: [], weekly: [], monthly: [] };
    if(doc.exists()) {
      data = doc.data();
    }
    
    if(!data[type]) data[type] = [];
    
    data[type].push({
      text: input.value.trim(),
      time: timeInput ? timeInput.value : "",
      completed: false
    });
    
    await window.firebaseFns.setDoc(plannerRef, data);
    input.value = '';
  }

  async function togglePlannerGoal(type, index) {
    const plannerRef = window.firebaseFns.doc(db, 'planners', currentUserId);
    const doc = await window.firebaseFns.getDoc(plannerRef);
    
    if(doc.exists()) {
      const data = doc.data();
      if(data[type] && data[type][index]) {
        data[type][index].completed = !data[type][index].completed;
        await window.firebaseFns.setDoc(plannerRef, data);
      }
    }
  }

  async function deletePlannerGoal(type, index) {
    const plannerRef = window.firebaseFns.doc(db, 'planners', currentUserId);
    const doc = await window.firebaseFns.getDoc(plannerRef);
    
    if(doc.exists()) {
      const data = doc.data();
      if(data[type]) {
        data[type].splice(index, 1);
        await window.firebaseFns.setDoc(plannerRef, data);
      }
    }
  }

  function setAlarm(time) {
    if(!time) {
      alert("‚è∞ No time set for this goal!");
      return;
    }
    alert("üîî Alarm set for " + time + "\n\nNote: Browser notifications must be enabled for actual alerts.");
  }

  //====== MY MOOD AI CHAT FUNCTIONS ======
  let selectedMood = "";

  function selectMood(mood) {
    selectedMood = mood;
    
    const buttons = document.querySelectorAll(".mood-btn");
    buttons.forEach(function(btn) {
      if(btn.innerText === mood) {
        btn.classList.add("selected");
      } else {
        btn.classList.remove("selected");
      }
    });
    
    const chatbox = document.getElementById("moodChatbox");
    chatbox.innerHTML += '<div class="chat-message chat-user"><strong>üë§ You:</strong> ' + mood + '</div>';
    chatbox.scrollTop = chatbox.scrollHeight;
    
    getAIResponse("I feel " + mood);
  }

  function sendMoodMessage() {
    const input = document.getElementById("moodInput");
    const message = input.value.trim();
    
    if(!message && !selectedMood) {
      alert("‚ö†Ô∏è Please select a mood or type a message!");
      return;
    }
    
    const chatbox = document.getElementById("moodChatbox");
    
    if(message) {
      chatbox.innerHTML += '<div class="chat-message chat-user"><strong>üë§ You:</strong> ' + message + '</div>';
      chatbox.scrollTop = chatbox.scrollHeight;
      input.value = "";
      
      getAIResponse(message);
    }
  }

  function getAIResponse(message) {
    const chatbox = document.getElementById("moodChatbox");
    
    chatbox.innerHTML += '<div class="chat-message chat-ai" id="typingIndicator"><em>üí≠ Thinking...</em></div>';
    chatbox.scrollTop = chatbox.scrollHeight;
    
    setTimeout(function() {
      const typingIndicator = document.getElementById("typingIndicator");
      if(typingIndicator) typingIndicator.remove();
      
      const response = getSupportiveResponse(message);
      chatbox.innerHTML += '<div class="chat-message chat-ai"><strong>ü§ó AI Companion:</strong> ' + response + '</div>';
      chatbox.scrollTop = chatbox.scrollHeight;
    }, 1000);
  }

  function getSupportiveResponse(message) {
    const lowerMessage = message.toLowerCase();
    
    if(lowerMessage.includes("üòä") || lowerMessage.includes("happy") || lowerMessage.includes("good") || lowerMessage.includes("great")) {
      return "That's wonderful! üéâ I'm so glad you're feeling good! Keep that positive energy going!";
    }
    
    if(lowerMessage.includes("üò¢") || lowerMessage.includes("sad") || lowerMessage.includes("depressed")) {
      return "I'm here for you. üíô It's okay to feel sad sometimes. Would you like to talk about what's making you feel this way?";
    }
    
    if(lowerMessage.includes("üò†") || lowerMessage.includes("angry") || lowerMessage.includes("mad")) {
      return "I understand you're feeling angry. üò§ Take a deep breath... Inhale for 4 seconds, hold for 7, exhale for 8.";
    }
    
    if(lowerMessage.includes("üò∞") || lowerMessage.includes("anxious") || lowerMessage.includes("nervous")) {
      return "It's okay to feel anxious sometimes. üå∏ Try these tips:\n\n1. Take deep breaths\n2. Write down your worries\n3. Talk to someone you trust";
    }
    
    if(lowerMessage.includes("üò¥") || lowerMessage.includes("tired") || lowerMessage.includes("sleepy")) {
      return "You sound tired! üò¥ Make sure you're getting enough sleep - teens need 8-10 hours.";
    }
    
    return "Thank you for sharing that with me. üíô I'm here to listen. Do you want to talk more about it?";
  }

  //====== SEMESTER AND QUARTER SELECTORS ======
  function selectSemester(sem, btn) {
    const buttons = document.querySelectorAll(".sem-btn");
    buttons.forEach(function(b) {
      b.classList.remove("active");
    });
    btn.classList.add("active");
    
    currentSemester = sem;
    
    const quarterSelector = document.getElementById("quarterSelector");
    if(quarterSelector) {
      if(sem === 1) {
        quarterSelector.innerHTML = `
          <button class="quarter-btn active" onclick="selectQuarter(1, this)">1st Quarter</button>
          <button class="quarter-btn" onclick="selectQuarter(2, this)">2nd Quarter</button>
        `;
      } else {
        quarterSelector.innerHTML = `
          <button class="quarter-btn active" onclick="selectQuarter(3, this)">3rd Quarter</button>
          <button class="quarter-btn" onclick="selectQuarter(4, this)">4th Quarter</button>
        `;
      }
    }
    
    currentQuarter = sem === 1 ? 1 : 3;
  }

  function selectQuarter(quarter, btn) {
    const buttons = document.querySelectorAll(".quarter-btn");
    buttons.forEach(function(b) {
      b.classList.remove("active");
    });
    btn.classList.add("active");
    
    currentQuarter = quarter;
  }

  //====== ADDITIONAL FUNCTIONS FOR FEATURES ======
  function generateReportCards(section, students) {
    if(!section) {
      alert('Please select a section first');
      return;
    }
    
    const container = document.getElementById('reportCardsContainer');
    container.innerHTML = '';
    
    const sectionStudents = students.filter(s => s.section === section);
    
    sectionStudents.forEach(s => {
      const reportCard = document.createElement('div');
      reportCard.className = 'report-card';
      reportCard.style.marginBottom = '30px';
      
      const grades = window.realtimeGrades?.[s.name] || {};
      const genAvg = Object.values(grades).length ? (Object.values(grades).reduce((a,b) => a+b, 0) / Object.values(grades).length).toFixed(2) : 0;
      
      reportCard.innerHTML = `
        <div class="report-card-header">
          <h2>Republic of the Philippines</h2>
          <h3>Department of Education</h3>
          <p>Region IX, Zamboanga Peninsula</p>
          <p style="font-size: 14px; margin-top: 10px;">DUMINGAG SENIOR HIGH SCHOOL</p>
          <p style="font-size: 12px;">Dumingag, Zamboanga del Sur</p>
        </div>
        
        <div class="report-card-info">
          <p><strong>Name:</strong> ${s.name}</p>
          <p><strong>LRN:</strong> ${s.studentId.replace('ST', '')}</p>
          <p><strong>Grade & Section:</strong> ${s.gradeLevel} - ${s.section}</p>
          <p><strong>Track/Strand:</strong> ${s.track} - ${s.strand}</p>
          <p><strong>School Year:</strong> 2023-2024</p>
          <p><strong>Semester:</strong> 1st Semester</p>
        </div>
        
        <table>
          <tr>
            <th rowspan="2">Learning Areas</th>
            <th colspan="2">Quarter</th>
            <th rowspan="2">Final<br>Grade</th>
            <th rowspan="2">Remarks</th>
          </tr>
          <tr>
            <th>1</th>
            <th>2</th>
          </tr>
          ${Object.entries(grades).map(([sub, grade]) => {
            const q1 = Math.floor(Math.random() * 10) + 80;
            const final = Math.round((q1 + grade) / 2);
            return `
              <tr>
                <td style="text-align: left;">${sub}</td>
                <td>${q1}</td>
                <td>${grade}</td>
                <td><strong>${final}</strong></td>
                <td>${final >= 75 ? 'Passed' : 'Failed'}</td>
              </tr>
            `;
          }).join('')}
          <tr style="background: #f0f0f0; font-weight: bold;">
            <td colspan="3" style="text-align: right;">General Average:</td>
            <td>${genAvg}</td>
            <td>${genAvg >= 75 ? 'Passed' : 'Failed'}</td>
          </tr>
        </table>
        
        <div class="report-card-footer">
          <div class="signature-line">
            <strong>Class Adviser</strong><br>
            <small>Signature over Printed Name</small>
          </div>
          <div class="signature-line">
            <strong>School Principal</strong><br>
            <small>School Head</small>
          </div>
        </div>
      `;
      
      container.appendChild(reportCard);
    });
    
    const printBtn = document.createElement('button');
    printBtn.innerHTML = 'üñ®Ô∏è Print All Report Cards';
    printBtn.style.cssText = 'background: #28a745; color: white; margin-top: 20px;';
    printBtn.onclick = () => window.print();
    container.appendChild(printBtn);
  }
  
  function downloadTranscriptPDF(student) {
    alert('üìÑ PDF download would be implemented with jsPDF.\n\nStudent: ' + student.name);
  }
  
  // Assignment Functions
  function showCreateAssignment() {
    const form = document.getElementById('createAssignmentForm');
    form.style.display = form.style.display === 'none' ? 'block' : 'none';
  }
  
  async function createAssignment() {
    const title = document.getElementById('assignmentTitle').value;
    const desc = document.getElementById('assignmentDesc').value;
    const subject = document.getElementById('assignmentSubject').value;
    const due = document.getElementById('assignmentDue').value;
    const points = document.getElementById('assignmentPoints').value;
    
    if(!title || !due) {
      alert('Please fill in all required fields');
      return;
    }
    
    await addDocument('assignments', {
      title,
      description: desc,
      subject,
      dueDate: due,
      points: parseInt(points),
      teacher: currentUser,
      section: currentUserData.sectionHandled,
      createdAt: new Date().toISOString()
    });
    
    alert('‚úÖ Assignment created successfully!');
    document.getElementById('createAssignmentForm').style.display = 'none';
  }
  
  function viewSubmissions(assignmentId) {
    const assignments = window.realtimeAssignments || [];
    const submissions = window.realtimeSubmissions || [];
    
    const assignment = assignments.find(a => a.id === assignmentId);
    const subs = submissions.filter(s => s.assignmentId === assignmentId);
    
    let html = `<h4>Submissions for: ${assignment?.title}</h4>`;
    
    if(subs.length === 0) {
      html += '<p>No submissions yet.</p>';
    } else {
      subs.forEach(sub => {
        html += `
          <div style="padding: 15px; border: 1px solid #ddd; margin: 10px 0; border-radius: 8px;">
            <p><strong>${sub.student}</strong> - Submitted: ${new Date(sub.submittedAt).toLocaleString()}</p>
            ${!sub.graded ? 
              `<div style="margin-top: 10px;">
                <input type="number" id="grade_${sub.id}" placeholder="Grade" max="${assignment?.points || 100}" style="width: 100px;">
                <button onclick="gradeSubmission('${sub.id}', ${assignment?.points || 100})" style="width: auto; background: #28a745; color: white;">‚úì Grade</button>
              </div>` :
              `<p><strong>Grade: ${sub.grade}/${assignment?.points || 100}</strong></p>`
            }
          </div>
        `;
      });
    }
    
    const modal = document.createElement('div');
    modal.style.cssText = 'position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 30px; border-radius: 15px; box-shadow: 0 10px 40px rgba(0,0,0,0.3); z-index: 10000; max-width: 600px; max-height: 80vh; overflow-y: auto;';
    modal.innerHTML = html + '<br><button onclick="this.parentElement.remove()" style="background: var(--main-gray); color: white;">Close</button>';
    document.body.appendChild(modal);
  }
  
  async function gradeSubmission(submissionId, maxPoints) {
    const grade = document.getElementById(`grade_${submissionId}`).value;
    if(!grade || grade < 0 || grade > maxPoints) {
      alert('Invalid grade');
      return;
    }
    
    const submissions = window.realtimeSubmissions || [];
    const sub = submissions.find(s => s.id === submissionId);
    if(sub) {
      await window.firebaseFns.setDoc(
        window.firebaseFns.doc(db, 'submissions', submissionId),
        {
          ...sub,
          grade: parseInt(grade),
          graded: true,
          gradedBy: currentUser,
          gradedAt: new Date().toISOString()
        }
      );
      
      addNotification(`Your submission has been graded: ${grade}/${maxPoints}`, 'grade', sub.student);
      alert('‚úÖ Graded successfully!');
    }
  }
  
  async function submitAssignment(assignmentId) {
    const input = document.createElement('input');
    input.type = 'file';
    input.onchange = async function() {
      const file = this.files[0];
      if(file) {
        await addDocument('submissions', {
          assignmentId,
          student: currentUser,
          fileName: file.name,
          submittedAt: new Date().toISOString(),
          graded: false
        });
        
        alert('‚úÖ Assignment submitted successfully!');
      }
    };
    input.click();
  }
  
  // Quiz Functions
  let questionCount = 0;
  
  function showCreateQuiz() {
    const form = document.getElementById('createQuizForm');
    form.style.display = form.style.display === 'none' ? 'block' : 'none';
  }
  
  function addQuestion() {
    questionCount++;
    const container = document.getElementById('quizQuestions');
    const div = document.createElement('div');
    div.style.cssText = 'background: white; padding: 15px; margin: 10px 0; border-radius: 8px;';
    div.innerHTML = `
      <h5>Question ${questionCount}</h5>
      <input type="text" placeholder="Question text" class="q-text" style="margin-bottom: 10px;">
      <input type="text" placeholder="Option A" class="q-opt">
      <input type="text" placeholder="Option B" class="q-opt">
      <input type="text" placeholder="Option C" class="q-opt">
      <input type="text" placeholder="Option D" class="q-opt">
      <select class="q-answer" style="margin-top: 10px;">
        <option value="">Correct Answer</option>
        <option value="0">A</option>
        <option value="1">B</option>
        <option value="2">C</option>
        <option value="3">D</option>
      </select>
    `;
    container.appendChild(div);
  }
  
  async function saveQuiz() {
    const title = document.getElementById('quizTitle').value;
    const subject = document.getElementById('quizSubject').value;
    const duration = document.getElementById('quizDuration').value;
    const start = document.getElementById('quizStart').value;
    const end = document.getElementById('quizEnd').value;
    
    const questions = [];
    document.querySelectorAll('#quizQuestions > div').forEach(div => {
      const text = div.querySelector('.q-text').value;
      const options = Array.from(div.querySelectorAll('.q-opt')).map(i => i.value);
      const answer = div.querySelector('.q-answer').value;
      if(text && options.every(o => o) && answer !== '') {
        questions.push({text, options, answer: parseInt(answer)});
      }
    });
    
    if(!title || questions.length === 0) {
      alert('Please fill in all fields and add at least one question');
      return;
    }
    
    await addDocument('quizzes', {
      title,
      subject,
      duration: parseInt(duration),
      startTime: start,
      endTime: end,
      questions,
      teacher: currentUser,
      section: currentUserData.sectionHandled
    });
    
    alert('‚úÖ Quiz created successfully!');
    document.getElementById('createQuizForm').style.display = 'none';
  }
  
  function startQuiz(quizId) {
    const quizzes = window.realtimeQuizzes || [];
    const quiz = quizzes.find(q => q.id === quizId);
    if(!quiz) return;
    
    currentQuiz = quiz;
    selectedAnswers = {};
    
    const section = document.querySelector('.section');
    section.innerHTML = `
      <div class="quiz-timer" id="quizTimer">‚è±Ô∏è ${quiz.duration}:00</div>
      <h3>${quiz.title}</h3>
      <p><strong>Subject:</strong> ${quiz.subject} | <strong>Questions:</strong> ${quiz.questions.length}</p>
      <div id="quizContainer"></div>
      <button onclick="submitQuiz()" style="background: #28a745; color: white; margin-top: 20px;">‚úÖ Submit Quiz</button>
    `;
    
    const container = document.getElementById('quizContainer');
    quiz.questions.forEach((q, idx) => {
      const qDiv = document.createElement('div');
      qDiv.className = 'quiz-question';
      qDiv.innerHTML = `
        <h4>Question ${idx + 1}</h4>
        <p>${q.text}</p>
        <div class="quiz-options">
          ${q.options.map((opt, optIdx) => `
            <div class="quiz-option" onclick="selectOption(${idx}, ${optIdx})" data-q="${idx}" data-opt="${optIdx}">
              ${String.fromCharCode(65 + optIdx)}. ${opt}
            </div>
          `).join('')}
        </div>
      `;
      container.appendChild(qDiv);
    });
    
    let timeLeft = quiz.duration * 60;
    quizTimer = setInterval(() => {
      timeLeft--;
      const mins = Math.floor(timeLeft / 60);
      const secs = timeLeft % 60;
      const timerEl = document.getElementById('quizTimer');
      if(timerEl) {
        timerEl.textContent = `‚è±Ô∏è ${mins}:${secs.toString().padStart(2, '0')}`;
      }
      
      if(timeLeft <= 0) {
        clearInterval(quizTimer);
        submitQuiz();
      }
    }, 1000);
  }
  
  function selectOption(questionIdx, optionIdx) {
    selectedAnswers[questionIdx] = optionIdx;
    document.querySelectorAll(`[data-q="${questionIdx}"]`).forEach(el => el.classList.remove('selected'));
    document.querySelector(`[data-q="${questionIdx}"][data-opt="${optionIdx}"]`).classList.add('selected');
  }
  
  async function submitQuiz() {
    clearInterval(quizTimer);
    const timerEl = document.getElementById('quizTimer');
    if(timerEl) timerEl.remove();
    
    let correct = 0;
    currentQuiz.questions.forEach((q, idx) => {
      if(selectedAnswers[idx] === q.answer) correct++;
    });
    
    const score = Math.round((correct / currentQuiz.questions.length) * 100);
    
    await addDocument('quizResults', {
      quizId: currentQuiz.id,
      student: currentUser,
      score,
      answers: selectedAnswers,
      submittedAt: new Date().toISOString()
    });
    
    alert(`‚úÖ Quiz submitted!\n\nScore: ${score}%\nCorrect: ${correct}/${currentQuiz.questions.length}`);
    loadSection('Quizzes');
  }
  
  // Conference Functions
  async function generateSlots() {
    const date = document.getElementById('conferenceDate').value;
    const start = document.getElementById('conferenceStart').value;
    const end = document.getElementById('conferenceEnd').value;
    const duration = parseInt(document.getElementById('slotDuration').value);
    
    if(!date || !start || !end) {
      alert('Please fill in all fields');
      return;
    }
    
    const startTime = new Date(`${date}T${start}`);
    const endTime = new Date(`${date}T${end}`);
    
    let current = startTime;
    while(current < endTime) {
      await addDocument('conferences', {
        teacher: currentUser,
        dateTime: current.toISOString(),
        status: 'available',
        parent: null
      });
      current = new Date(current.getTime() + duration * 60000);
    }
    
    alert('‚úÖ Slots generated successfully!');
  }
  
  async function bookConference(conferenceId) {
    await window.firebaseFns.setDoc(
      window.firebaseFns.doc(db, 'conferences', conferenceId),
      {
        status: 'booked',
        parent: currentUser
      },
      { merge: true }
    );
    
    addNotification(`Conference booked`, 'conference', currentUser);
    alert('‚úÖ Conference booked successfully!');
  }
  
  async function cancelConference(conferenceId) {
    if(!confirm('Are you sure you want to cancel this conference?')) return;
    
    await window.firebaseFns.setDoc(
      window.firebaseFns.doc(db, 'conferences', conferenceId),
      {
        status: 'available',
        parent: null
      },
      { merge: true }
    );
    
    alert('‚úÖ Conference cancelled');
  }
  
  // Behavior Functions
  async function addBehaviorRecord() {
    const studentName = document.getElementById('behaviorStudent').value;
    const type = document.getElementById('behaviorType').value;
    const points = parseInt(document.getElementById('behaviorPoints').value);
    const reason = document.getElementById('behaviorReason').value;
    
    if(!reason) {
      alert('Please enter a reason');
      return;
    }
    
    const logRef = window.firebaseFns.doc(db, 'behaviorLog', studentName);
    const doc = await window.firebaseFns.getDoc(logRef);
    
    let entries = [];
    if(doc.exists()) {
      entries = doc.data().entries || [];
    }
    
    entries.push({
      type,
      points,
      reason,
      teacher: currentUser,
      date: new Date().toISOString()
    });
    
    await window.firebaseFns.setDoc(logRef, { entries });
    
    addNotification(`New behavior record: ${type} ${points} points`, 'behavior', studentName);
    alert('‚úÖ Record added successfully!');
  }
  
  // Payment Functions
  function selectPayment(element, method) {
    document.querySelectorAll('.payment-method').forEach(el => el.classList.remove('selected'));
    element.classList.add('selected');
    selectedPaymentMethod = method;
  }
  
  async function processPayment() {
    const amount = parseFloat(document.getElementById('paymentAmount').value);
    
    if(!amount || amount <= 0) {
      alert('Please enter a valid amount');
      return;
    }
    
    if(!selectedPaymentMethod) {
      alert('Please select a payment method');
      return;
    }
    
    const refNum = 'PAY-' + Date.now();
    
    await addDocument('payments', {
      student: currentUser,
      amount,
      method: selectedPaymentMethod,
      date: new Date().toISOString(),
      status: 'completed',
      reference: refNum
    });
    
    addNotification(`Payment of ‚Ç±${amount.toLocaleString()} received. Ref: ${refNum}`, 'payment', currentUser);
    alert(`‚úÖ Payment successful!\n\nReference: ${refNum}\nAmount: ‚Ç±${amount.toLocaleString()}`);
  }
  
  // Enrollment Wizard
  let currentEnrollStep = 1;
  
  function nextEnrollStep(step) {
    document.getElementById(`enrollStep${step}`).classList.remove('active');
    document.getElementById(`step${step}`).classList.remove('active');
    document.getElementById(`step${step}`).classList.add('completed');
    
    currentEnrollStep = step + 1;
    document.getElementById(`enrollStep${currentEnrollStep}`).classList.add('active');
    document.getElementById(`step${currentEnrollStep}`).classList.add('active');
    
    if(currentEnrollStep === 4) {
      document.getElementById('enrollReview').innerHTML = `
        <p><strong>Name:</strong> ${document.getElementById('enrollLastName').value}, ${document.getElementById('enrollFirstName').value} ${document.getElementById('enrollMiddleName').value}</p>
        <p><strong>Track/Strand:</strong> ${document.getElementById('enrollTrack').value} - ${document.getElementById('enrollStrand').value}</p>
        <p><strong>Grade Level:</strong> Grade ${document.getElementById('enrollGrade').value}</p>
      `;
    }
  }
  
  function prevEnrollStep(step) {
    document.getElementById(`enrollStep${step}`).classList.remove('active');
    document.getElementById(`step${step}`).classList.remove('active');
    
    currentEnrollStep = step - 1;
    document.getElementById(`enrollStep${currentEnrollStep}`).classList.add('active');
    document.getElementById(`step${currentEnrollStep}`).classList.add('active');
    document.getElementById(`step${currentEnrollStep}`).classList.remove('completed');
  }
  
  async function submitEnrollment() {
    alert('‚úÖ Enrollment application submitted!\n\nReference Number: ENR-' + Date.now() + '\n\nPlease wait for admin approval.');
    loadSection('Enrollment');
  }
  
  //====== NOTIFICATION FUNCTIONS ======
  async function addNotification(message, type = 'info', recipientId = null) {
    try {
      await addDocument('notifications', {
        message,
        type,
        recipientId: recipientId || currentUserId,
        date: new Date().toISOString(),
        read: false
      });
      
      updateNotificationBadge();
      
      if ('Notification' in window && Notification.permission === 'granted') {
        new Notification('DSHS School System', {
          body: message,
          icon: 'https://via.placeholder.com/100'
        });
      }
    } catch(error) {
      console.error('Error adding notification:', error);
    }
  }
  
  async function updateNotificationBadge() {
    try {
      const notifications = await getCollectionData('notifications', [
        window.firebaseFns.where('recipientId', '==', currentUserId),
        window.firebaseFns.where('read', '==', false)
      ]);
      
      const badge = document.getElementById('notificationBadge');
      if(notifications.length > 0) {
        badge.textContent = notifications.length > 99 ? '99+' : notifications.length;
        badge.style.display = 'flex';
      } else {
        badge.style.display = 'none';
      }
    } catch(error) {
      console.error('Error updating notification badge:', error);
    }
  }
  
  function toggleNotifications() {
    const panel = document.getElementById('notificationPanel');
    panel.classList.toggle('show');
    
    if(panel.classList.contains('show')) {
      renderNotifications();
    }
  }
  
  async function renderNotifications() {
    try {
      const list = document.getElementById('notificationList');
      const notifications = await getCollectionData('notifications', [
        window.firebaseFns.where('recipientId', '==', currentUserId),
        window.firebaseFns.orderBy('date', 'desc')
      ]);
      
      if(notifications.length === 0) {
        list.innerHTML = '<div style="padding: 20px; text-align: center; color: #666;">No notifications</div>';
        return;
      }
      
      list.innerHTML = '';
      notifications.forEach(n => {
        const item = document.createElement('div');
        item.className = 'notification-item' + (n.read ? '' : ' unread');
        item.innerHTML = `
          <div style="font-weight: ${n.read ? 'normal' : 'bold'}">${n.message}</div>
          <div style="font-size: 11px; color: #666; margin-top: 5px;">${new Date(n.date).toLocaleString()}</div>
        `;
        item.onclick = async () => {
          await window.firebaseFns.setDoc(
            window.firebaseFns.doc(db, 'notifications', n.id),
            { read: true },
            { merge: true }
          );
          updateNotificationBadge();
          renderNotifications();
        };
        list.appendChild(item);
      });
    } catch(error) {
      console.error('Error rendering notifications:', error);
    }
  }
  
  if('Notification' in window && Notification.permission === 'default') {
    Notification.requestPermission();
  }

  //====== SESSION MANAGEMENT ======
  function startSessionTimer() {
    if(sessionTimer) clearTimeout(sessionTimer);
    if(sessionWarningTimer) clearTimeout(sessionWarningTimer);
    
    sessionWarningTimer = setTimeout(() => {
      showSessionWarning();
    }, SESSION_TIMEOUT - WARNING_BEFORE);
    
    sessionTimer = setTimeout(() => {
      logout();
      alert('üîí Your session has expired. Please login again.');
    }, SESSION_TIMEOUT);
    
    document.addEventListener('click', resetSessionTimer);
    document.addEventListener('keypress', resetSessionTimer);
  }
  
  function resetSessionTimer() {
    if(sessionTimer) clearTimeout(sessionTimer);
    if(sessionWarningTimer) clearTimeout(sessionWarningTimer);
    
    document.getElementById('sessionWarning').style.display = 'none';
    
    sessionWarningTimer = setTimeout(() => {
      showSessionWarning();
    }, SESSION_TIMEOUT - WARNING_BEFORE);
    
    sessionTimer = setTimeout(() => {
      logout();
      alert('üîí Your session has expired. Please login again.');
    }, SESSION_TIMEOUT);
  }
  
  function showSessionWarning() {
    const warning = document.getElementById('sessionWarning');
    const countdown = document.getElementById('countdown');
    warning.style.display = 'block';
    
    let seconds = 60;
    const interval = setInterval(() => {
      seconds--;
      countdown.textContent = seconds;
      if(seconds <= 0) clearInterval(interval);
    }, 1000);
  }
  
  function recordFailedLogin() {
    loginAttempts++;
    document.getElementById('loginAttempts').style.display = 'block';
    document.getElementById('attemptCount').textContent = loginAttempts;
    
    if(loginAttempts >= MAX_LOGIN_ATTEMPTS) {
      lockAccount();
    }
  }
  
  function lockAccount() {
    const loginBtn = document.querySelector('#login button');
    loginBtn.disabled = true;
    loginBtn.textContent = 'üîí Account Locked (5 min)';
    
    let minutes = 5;
    lockoutTimer = setInterval(() => {
      minutes--;
      if(minutes > 0) {
        loginBtn.textContent = `üîí Account Locked (${minutes} min)`;
      } else {
        clearInterval(lockoutTimer);
        loginAttempts = 0;
        loginBtn.disabled = false;
        loginBtn.textContent = 'üöÄ Login';
        document.getElementById('loginAttempts').style.display = 'none';
      }
    }, 60000);
  }
  
  function resetLoginAttempts() {
    loginAttempts = 0;
    document.getElementById('loginAttempts').style.display = 'none';
  }
  
  //====== PWA FUNCTIONS ======
  function setupPWA() {
    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      window.deferredPrompt = e;
      document.getElementById('installPwaBtn').classList.add('show');
    });
    
    if('serviceWorker' in navigator) {
      navigator.serviceWorker.register('sw.js').then((registration) => {
        console.log('SW registered:', registration);
      }).catch((error) => {
        console.log('SW registration failed:', error);
      });
    }
  }
  
  function installPWA() {
    if(window.deferredPrompt) {
      window.deferredPrompt.prompt();
      window.deferredPrompt.userChoice.then((choiceResult) => {
        if(choiceResult.outcome === 'accepted') {
          console.log('User accepted PWA install');
        }
        window.deferredPrompt = null;
        document.getElementById('installPwaBtn').classList.remove('show');
      });
    }
  }
  
  //====== UTILITY FUNCTIONS ======
  function showError(msg) {
    const el = document.getElementById('msg') || document.getElementById('recoveryMsg');
    if(el) {
      el.style.color = '#dc3545';
      el.textContent = '‚ùå ' + msg;
    }
  }
  
  function toggleDarkMode() {
    document.body.classList.toggle('dark-mode');
    localStorage.setItem('darkMode', document.body.classList.contains('dark-mode'));
  }
  
  function changeLanguage() {
    const lang = document.getElementById('languageSelect').value;
    localStorage.setItem('language', lang);
    alert('üåê Language changed to ' + (lang === 'en' ? 'English' : lang === 'fil' ? 'Filipino' : 'Cebuano') + '\n\nNote: Full localization would require translation files.');
  }
  
  if(localStorage.getItem('darkMode') === 'true') {
    document.body.classList.add('dark-mode');
  }
</script>

</body>
</html>
