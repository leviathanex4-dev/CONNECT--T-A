<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>DSHS School System</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="theme-color" content="#8B0000">
<meta name="description" content="Dumingag Senior High School Management System">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="DSHS">

<link rel="manifest" href="manifest.json">
<link rel="apple-touch-icon" href="icons/icon-192x192.png">

<!-- Firebase SDK (v9 Modular) - NO STORAGE -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
  import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, sendPasswordResetEmail, updatePassword } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
  import { getFirestore, collection, doc, getDoc, getDocs, setDoc, updateDoc, deleteDoc, query, where, onSnapshot, addDoc, serverTimestamp, orderBy, limit } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";
  import { getAnalytics } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-analytics.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBr-wATdD81M4lc8dlxqhRUEMKVtHPj-DU",
    authDomain: "connect-ta-13ab9.firebaseapp.com",
    projectId: "connect-ta-13ab9",
    storageBucket: "connect-ta-13ab9.firebasestorage.app",
    messagingSenderId: "38813026824",
    appId: "1:38813026824:web:b471597524cdd56618dfbd",
    measurementId: "G-641QGL0YPZ"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);
  const analytics = getAnalytics(app);

  window.firebaseApp = app;
  window.firebaseAuth = auth;
  window.firebaseDB = db;
  window.firebaseAnalytics = analytics;
  window.firebaseFns = {
    onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, sendPasswordResetEmail, updatePassword,
    collection, doc, getDoc, getDocs, setDoc, updateDoc, deleteDoc, query, where, onSnapshot, addDoc, serverTimestamp, orderBy, limit
  };
</script>

<style>
  :root {
    --main-red: #8B0000;
    --main-blue: #003366;
    --main-gray: #6c757d;
    --sub-yellow: #ffc107;
    --sub-orange: #fd7e14;
    --light-gray: #f8f9fa;
    --dark-gray: #495057;
    --success-green: #28a745;
    --danger-red: #dc3545;
    --warning-yellow: #ffc107;
  }
  
  * { box-sizing: border-box; }
  
  body { 
    margin: 0; 
    min-height: 100vh;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    position: relative;
    overflow-x: hidden;
  }
  
  /* RED-BLUE GRADIENT BACKGROUND */
  body::before {
    content: '';
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: linear-gradient(135deg, #8B0000 0%, #003366 100%);
    background-attachment: fixed;
    z-index: -1;
  }
  
  body.dark-mode {
    --main-red: #a00000;
    --main-blue: #004080;
    --light-gray: #2d2d2d;
    --dark-gray: #e0e0e0;
  }
  
  body.dark-mode::before {
    background: linear-gradient(135deg, #1a0000 0%, #001a33 100%);
  }
  
  #loadingOverlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(139, 0, 0, 0.95);
    z-index: 10000;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    color: white;
    transition: opacity 0.5s;
  }
  
  .spinner {
    width: 50px;
    height: 50px;
    border: 4px solid rgba(255,255,255,0.3);
    border-top-color: white;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin-bottom: 20px;
  }
  
  @keyframes spin { to { transform: rotate(360deg); } }
  
  .signup-link { color: var(--main-blue); font-weight: bold; cursor: pointer; }
  .signup-link:hover { text-decoration: underline; }
  
  .password-strength {
    height: 5px;
    margin-top: 5px;
    border-radius: 3px;
    transition: all 0.3s;
  }
  
  .password-strength.weak { background: #dc3545; width: 33%; }
  .password-strength.medium { background: #ffc107; width: 66%; }
  .password-strength.strong { background: #28a745; width: 100%; }
  
  .strength-text { font-size: 12px; margin-top: 3px; font-weight: bold; }
  
  input, button, textarea, select { 
    width: 100%; 
    padding: 12px; 
    margin-top: 8px; 
    font-size: 14px;
    border: 2px solid #ddd;
    border-radius: 6px;
    transition: border-color 0.3s;
  }
  
  input:focus, textarea:focus, select:focus {
    border-color: var(--main-blue);
    outline: none;
  }
  
  button { 
    cursor: pointer; 
    border-radius: 6px; 
    font-weight: bold;
    transition: all 0.3s;
    border: none;
  }
  
  button:hover:not(:disabled) {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
  }
  
  button:disabled {
    opacity: 0.6;
    cursor: not-allowed;
    transform: none;
  }
  
  .toggle-btn { 
    background: linear-gradient(135deg, var(--main-red) 0%, var(--main-blue) 100%); 
    color: white; 
    font-size: 18px; 
    position: fixed; 
    top: 12px; 
    left: 12px; 
    z-index: 1000; 
    padding: 12px 18px; 
    border-radius: 8px;
    display: flex;
    align-items: center;
    gap: 8px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.3);
  }
  
  .toggle-btn:hover:not(:disabled) { 
    background: linear-gradient(135deg, #660000 0%, #002244 100%);
    transform: scale(1.05);
  }
  
  .toggle-btn .icon { font-size: 22px; }
  .toggle-btn.small { padding: 8px 12px; font-size: 14px; }
  .toggle-btn.small .text { display: none; }
  
  .logout-btn {
    position: fixed;
    top: 12px;
    right: 80px;
    background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
    color: white;
    font-size: 14px;
    padding: 12px 20px;
    border-radius: 8px;
    z-index: 999;
    display: flex;
    align-items: center;
    gap: 8px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.3);
  }
  
  .logout-btn:hover {
    background: linear-gradient(135deg, #c82333 0%, #a71e2a 100%);
    transform: scale(1.05);
  }
  
  .session-warning {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    background: #dc3545;
    color: white;
    text-align: center;
    padding: 10px;
    z-index: 10000;
    display: none;
    animation: pulse 2s infinite;
  }
  
  @keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.8; }
  }
  
  .login { 
    min-height: 100vh; 
    display: flex; 
    justify-content: center; 
    align-items: center; 
    padding: 20px;
    position: relative;
    z-index: 1;
  }
  
  .box { 
    background: rgba(255,255,255,0.98); 
    padding: 40px; 
    width: 100%; 
    max-width: 420px; 
    border-radius: 15px; 
    box-shadow: 0 15px 40px rgba(0,0,0,0.3); 
    text-align: center; 
    border-top: 5px solid var(--main-red);
    backdrop-filter: blur(10px);
  }
  
  .box h2 { color: var(--main-blue); margin-bottom: 25px; }
  
  .pass-wrapper { position: relative; }
  .pass-wrapper span { 
    position: absolute; 
    right: 15px; 
    top: 18px; 
    cursor: pointer; 
    font-size: 18px;
  }
  
  .dashboard { display: none; min-height: 100vh; position: relative; z-index: 1; }
  
  .header { 
    background: linear-gradient(135deg, var(--main-red) 0%, var(--main-blue) 100%); 
    color: white; 
    padding: 18px; 
    text-align: center; 
    font-size: 18px; 
    position: relative; 
    z-index: 1;
    padding-left: 70px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.2);
  }
  
  .container { 
    display: flex; 
    min-height: calc(100vh - 60px); 
    position: relative; 
  }
  
  .menu-overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.6);
    z-index: 998;
    backdrop-filter: blur(3px);
  }
  .menu-overlay.show { display: block; }
  
  .menu {
    width: 300px;
    background: linear-gradient(180deg, var(--main-red) 0%, #5a0000 50%, var(--main-blue) 100%);
    padding: 15px;
    display: flex;
    flex-direction: column;
    position: fixed;
    top: 0;
    left: 0;
    height: 100%;
    z-index: 999;
    transition: transform 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
    transform: translateX(-100%);
    overflow-y: auto;
    padding-top: 80px;
    box-shadow: 5px 0 25px rgba(0,0,0,0.4);
  }
  
  .menu.show { transform: translateX(0); }
  
  .menu-header {
    color: white;
    text-align: center;
    padding: 15px;
    border-bottom: 2px solid rgba(255,255,255,0.3);
    margin-bottom: 20px;
    background: rgba(255,255,255,0.1);
    border-radius: 10px;
  }
  
  .menu-header h3 { margin: 0; font-size: 22px; color: var(--sub-yellow); }
  .menu-header p { margin: 5px 0 0 0; font-size: 13px; opacity: 0.9; }
  
  .menu button {
    background: rgba(255,255,255,0.15);
    color: white;
    margin-top: 10px;
    font-size: 15px;
    border: 1px solid rgba(255,255,255,0.25);
    border-radius: 8px;
    padding: 14px 15px;
    transition: all 0.3s;
    text-align: left;
    display: flex;
    align-items: center;
    gap: 12px;
  }
  
  .menu button:hover:not(:disabled) { 
    background: rgba(255,255,255,0.3); 
    transform: translateX(8px);
    padding-left: 20px;
  }
  
  .menu button .tab-icon { font-size: 20px; width: 30px; text-align: center; }
  
  .logout { 
    margin-top: auto; 
    background: var(--sub-orange) !important; 
    color: white !important; 
    text-align: center;
    justify-content: center;
  }
  
  .content { 
    flex: 1; 
    padding: 25px; 
    display: flex; 
    flex-direction: column; 
    align-items: center; 
    overflow-y: auto; 
    background: rgba(248,249,250,0.9);
    min-height: calc(100vh - 60px);
  }
  
  .section { 
    background: white; 
    padding: 25px; 
    border-radius: 12px; 
    width: 100%; 
    max-width: 850px; 
    margin-top: 20px; 
    box-shadow: 0 4px 20px rgba(0,0,0,0.1);
    border-left: 5px solid var(--main-blue);
  }
  
  .section h3 {
    color: var(--main-blue);
    border-bottom: 2px solid var(--sub-yellow);
    padding-bottom: 10px;
    margin-top: 0;
  }
  
  body.dark-mode .box,
  body.dark-mode .section {
    background: #2d2d2d;
    color: #e0e0e0;
    border-color: #444;
  }
  
  body.dark-mode input,
  body.dark-mode select,
  body.dark-mode textarea {
    background: #1a1a1a;
    color: #e0e0e0;
    border-color: #444;
  }
  
  table { 
    border-collapse: collapse; 
    width: 100%; 
    margin-top: 20px; 
    overflow-x: auto;
    display: block;
  }
  
  table, th, td { 
    border: 1px solid #dee2e6; 
    text-align: center; 
    padding: 12px; 
  }
  
  th { 
    background: linear-gradient(135deg, var(--main-red) 0%, var(--main-blue) 100%); 
    color: white; 
    font-weight: bold;
  }
  
  tr:nth-child(even) { background-color: #f8f9fa; }
  tr:hover { background-color: #e9ecef; }
  
  .id-card { 
    background: linear-gradient(135deg, var(--main-red) 0%, var(--main-blue) 100%); 
    border: 4px solid var(--sub-yellow); 
    border-radius: 18px; 
    padding: 22px; 
    width: 100%; 
    max-width: 360px; 
    margin: 18px; 
    display: inline-block; 
    vertical-align: top; 
    color: white;
    position: relative;
    box-shadow: 0 10px 30px rgba(0,0,0,0.3);
  }
  
  .id-card-header { 
    background: rgba(255,255,255,0.12); 
    padding: 18px; 
    text-align: center; 
    border-radius: 12px 12px 0 0; 
    margin: -22px -22px 18px -22px; 
    border-bottom: 3px solid var(--sub-yellow);
  }
  
  .id-card-photo { 
    width: 110px; 
    height: 110px; 
    background: #eee; 
    border-radius: 50%; 
    margin: 12px auto; 
    display: flex; 
    align-items: center; 
    justify-content: center; 
    overflow: hidden; 
    border: 5px solid var(--sub-yellow);
    box-shadow: 0 4px 15px rgba(0,0,0,0.3);
    font-size: 48px;
  }
  
  .id-card-info { 
    text-align: left; 
    font-size: 14px; 
    background: rgba(0,0,0,0.25); 
    padding: 18px; 
    border-radius: 12px;
  }
  
  .id-card-info p { margin: 10px 0; display: flex; justify-content: space-between; }
  .id-card-info strong { color: var(--sub-yellow); }
  
  .school-welcome {
    background: linear-gradient(135deg, var(--main-red) 0%, var(--main-blue) 100%);
    color: white;
    padding: 30px;
    border-radius: 15px;
    text-align: center;
    margin-bottom: 25px;
    box-shadow: 0 8px 25px rgba(0,0,0,0.2);
  }
  
  .school-welcome h2 { margin: 0 0 10px 0; color: var(--sub-yellow); }
  .school-welcome p { margin: 0; opacity: 0.95; }
  
  .notification-bell {
    position: fixed;
    top: 20px;
    right: 20px;
    background: var(--main-red);
    color: white;
    width: 50px;
    height: 50px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 24px;
    cursor: pointer;
    z-index: 999;
    box-shadow: 0 4px 15px rgba(0,0,0,0.3);
  }
  
  .notification-badge {
    position: absolute;
    top: -5px;
    right: -5px;
    background: var(--sub-orange);
    color: white;
    width: 25px;
    height: 25px;
    border-radius: 50%;
    font-size: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
  }
  
  .notification-panel {
    position: fixed;
    top: 80px;
    right: 20px;
    width: 350px;
    max-height: 500px;
    background: white;
    border-radius: 12px;
    box-shadow: 0 10px 40px rgba(0,0,0,0.3);
    z-index: 998;
    display: none;
    overflow: hidden;
  }
  
  .notification-panel.show { display: block; }
  
  .notification-header {
    background: linear-gradient(135deg, var(--main-red) 0%, var(--main-blue) 100%);
    color: white;
    padding: 15px;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  
  .notification-list { max-height: 400px; overflow-y: auto; }
  
  .notification-item {
    padding: 15px;
    border-bottom: 1px solid #eee;
    cursor: pointer;
    transition: all 0.3s;
  }
  
  .notification-item:hover { background: #f8f9fa; }
  .notification-item.unread {
    border-left: 4px solid var(--main-blue);
    background: #f0f8ff;
  }
  
  .offline-indicator {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    background: #ffc107;
    color: #333;
    text-align: center;
    padding: 8px;
    z-index: 10001;
    display: none;
    font-weight: bold;
  }
  
  .install-pwa-btn {
    position: fixed;
    bottom: 20px;
    right: 20px;
    background: var(--success-green);
    color: white;
    padding: 15px 25px;
    border-radius: 50px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.3);
    z-index: 999;
    display: none;
  }
  
  .install-pwa-btn.show { display: block; }
  
  .analytics-card {
    background: white;
    padding: 20px;
    border-radius: 12px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    text-align: center;
  }
  
  .analytics-number { font-size: 36px; font-weight: bold; color: var(--main-blue); margin: 10px 0; }
  .analytics-label { color: var(--main-gray); font-size: 14px; }
  
  .toggle-switch {
    position: relative;
    display: inline-block;
    width: 60px;
    height: 34px;
  }
  
  .toggle-switch input { opacity: 0; width: 0; height: 0; }
  
  .slider {
    position: absolute;
    cursor: pointer;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: #ccc;
    transition: .4s;
    border-radius: 34px;
  }
  
  .slider:before {
    position: absolute;
    content: "";
    height: 26px;
    width: 26px;
    left: 4px;
    bottom: 4px;
    background-color: white;
    transition: .4s;
    border-radius: 50%;
  }
  
  input:checked + .slider { background-color: var(--main-blue); }
  input:checked + .slider:before { transform: translateX(26px); }
  
  .settings-section {
    padding: 20px;
    border-bottom: 1px solid #dee2e6;
  }
  
  .settings-section:last-child { border-bottom: none; }
  
  /* Admin badge styling */
  .admin-badge {
    background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
    color: #000;
    padding: 2px 8px;
    border-radius: 4px;
    font-size: 11px;
    font-weight: bold;
    margin-left: 5px;
  }
  
  @media (max-width: 768px) {
    .menu { width: 85%; max-width: 340px; }
    .section { padding: 18px; margin-top: 12px; }
    .header { padding-left: 55px; font-size: 15px; }
    .toggle-btn { padding: 10px 14px; font-size: 14px; }
    .logout-btn { right: 70px; padding: 10px 15px; font-size: 12px; }
    .box { padding: 25px; }
    .notification-panel { width: 90%; right: 5%; }
    table { display: block; overflow-x: auto; white-space: nowrap; }
    .id-card { max-width: 100%; margin: 12px 0; }
  }
  
  @media print {
    .menu, .toggle-btn, .header, .menu-overlay,
    .notification-bell, .session-warning, .install-pwa-btn, .logout-btn,
    .offline-indicator, #loadingOverlay, body::before {
      display: none !important;
    }
    .id-card { break-inside: avoid; page-break-inside: avoid; border: 3px solid #000; }
    .content { padding: 0; }
    .section { box-shadow: none; padding: 10px; border: none; }
  }
</style>

<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
</head>
<body>
  
  <div id="loadingOverlay">
    <div class="spinner"></div>
    <p>Loading DSHS System...</p>
    <p id="loadingStatus" style="font-size: 12px; opacity: 0.8;">Connecting to Firebase</p>
  </div>

  <div class="offline-indicator" id="offlineIndicator">
    âš ï¸ You are offline. Some features may be limited.
  </div>

  <div class="session-warning" id="sessionWarning">
    âš ï¸ Your session will expire in <span id="countdown">60</span> seconds. Click anywhere to stay logged in.
  </div>
  
  <div class="notification-bell" id="notificationBell" onclick="toggleNotifications()">
    ğŸ””
    <span class="notification-badge" id="notificationBadge" style="display: none;">0</span>
  </div>
  
  <div class="notification-panel" id="notificationPanel">
    <div class="notification-header">
      <strong>ğŸ”” Notifications</strong>
      <button onclick="toggleNotifications()" style="width: auto; padding: 5px 10px; background: white; color: var(--main-blue);">âœ•</button>
    </div>
    <div class="notification-list" id="notificationList"></div>
  </div>
  
  <button class="install-pwa-btn" id="installPwaBtn" onclick="installPWA()">
    ğŸ“± Install App
  </button>

<div class="login" id="login">
  <div class="box">
    <h2>ğŸ“ DSHS Login</h2>
    <input type="text" id="loginEmail" placeholder="ğŸ“§ Email or Username">
    <div class="pass-wrapper">
      <input type="password" id="loginPassword" placeholder="ğŸ”’ Password">
      <span onclick="togglePassword()">ğŸ‘ï¸</span>
    </div>
    <p id="loginAttempts" style="color: #dc3545; font-size: 12px; display: none;">âš ï¸ Failed attempts: <span id="attemptCount">0</span>/5</p>
    <button onclick="login()" style="background: linear-gradient(135deg, var(--main-red) 0%, var(--main-blue) 100%); color: white; padding: 14px; font-size: 16px;">ğŸš€ Login</button>
    <p id="msg" style="color: #dc3545; margin-top: 10px;"></p>
    <p style="font-size: 13px; margin-top: 12px;">
      <span class="signup-link" onclick="showForgotPassword()">Forgot Password?</span> | 
      <span class="signup-link" onclick="showSignup()">Sign up!</span>
    </p>
    <p style="font-size: 11px; color: #666; margin-top: 15px; padding: 8px; background: #f8f9fa; border-radius: 5px;">
      ğŸ”‘ <strong>Admin Login:</strong> Username: <code>admin</code> | Password: <code>admin</code>
    </p>
  </div>
</div>

<div class="login" id="forgotPassword" style="display:none;">
  <div class="box">
    <h2>ğŸ”‘ Password Recovery</h2>
    <p style="font-size: 13px; color: #666;">Enter your email to receive a password reset link.</p>
    <input type="email" id="recoveryEmail" placeholder="ğŸ“§ Email">
    <button onclick="sendRecoveryEmail()" style="background: linear-gradient(135deg, var(--main-red) 0%, var(--main-blue) 100%); color: white; padding: 14px; font-size: 16px;">ğŸ“§ Send Reset Link</button>
    <p id="recoveryMsg" style="margin-top: 10px; font-size: 13px;"></p>
    <p style="font-size: 13px; margin-top: 12px;"><span class="signup-link" onclick="showLogin()">Back to Login</span></p>
  </div>
</div>

<div class="login" id="signup" style="display:none;">
  <div class="box">
    <h2>ğŸ“ Student Sign Up</h2>
    <input type="text" id="signupName" placeholder="ğŸ‘¤ Full Name">
    <input type="text" id="signupID" placeholder="ğŸ†” Student I.D">
    <input type="text" id="signupSection" placeholder="ğŸ« Section">
    <input type="text" id="signupTrack" placeholder="ğŸ“š Track">
    <input type="text" id="signupStrand" placeholder="ğŸ¯ Strand">
    <input type="text" id="signupGradeLevel" placeholder="ğŸ“– Grade Level">
    <input type="email" id="signupEmail" placeholder="ğŸ“§ Email">
    <div class="pass-wrapper">
      <input type="password" id="signupPass" placeholder="ğŸ”’ Password (min 8 chars)" onkeyup="checkPasswordStrength()">
    </div>
    <div class="password-strength" id="signupPasswordStrength"></div>
    <p class="strength-text" id="signupStrengthText"></p>
    <p style="font-size: 11px; color: #666; text-align: left; margin-top: 5px;">
      Password must contain: 8+ characters, uppercase, lowercase, number, special character
    </p>
    <label style="display: flex; align-items: center; gap: 8px; font-size: 12px; margin: 10px 0;">
      <input type="checkbox" id="agreeTerms" style="width: auto;"> I agree to the Terms and Conditions
    </label>
    <button onclick="submitSignup()" id="signupBtn" style="background: linear-gradient(135deg, var(--main-red) 0%, var(--main-blue) 100%); color: white; padding: 14px; font-size: 16px;" disabled>âœ… Create Account</button>
    <button onclick="clearSignup()" style="background: var(--main-gray); color: white; margin-top: 10px;">ğŸ”„ Clear</button>
    <p style="font-size: 13px; margin-top: 12px;">Already have an account? <span class="signup-link" onclick="showLogin()">Login</span></p>
  </div>
</div>

<div class="dashboard" id="dashboard">
  <button class="toggle-btn" id="toggleBtn" onclick="toggleMenu()">
    <span class="icon">â˜°</span>
    <span class="text">Menu</span>
  </button>
  
  <button class="logout-btn" id="headerLogoutBtn" onclick="logout()">
    <span>ğŸšª</span>
    <span>Logout</span>
  </button>
  
  <div class="menu-overlay" id="menuOverlay" onclick="toggleMenu()"></div>
  <div class="header" id="roleTitle"></div>
  <div class="container">
    <div class="menu" id="menu"></div>
    <div class="content" id="content">
      <div class="school-welcome">
        <h2>ğŸ« Dumingag Senior High School</h2>
        <p>Welcome to the DSHS School System</p>
      </div>
      <div class="section"><h3>ğŸ‘‹ Welcome</h3><p>Select an option from the menu to get started.</p></div>
    </div>
  </div>
</div>

<script>
  //====== GLOBAL VARIABLES ======
  let role = "", currentUser = "", currentUserId = "", currentUserData = null;
  let loginAttempts = 0;
  const MAX_LOGIN_ATTEMPTS = 5;
  let lockoutTimer = null;
  let sessionTimer = null;
  let sessionWarningTimer = null;
  const SESSION_TIMEOUT = 30 * 60 * 1000;
  const WARNING_BEFORE = 60 * 1000;
  let db, auth;
  let unsubscribers = [];
  
  // HARDCODED ADMIN CREDENTIALS
  const HARDCODED_ADMIN = {
    username: "admin",
    password: "admin",
    name: "System Administrator",
    email: "admin@dshs.edu",
    role: "admin"
  };
  
  //====== INITIALIZATION ======
  document.addEventListener('DOMContentLoaded', async function() {
    while(!window.firebaseApp) {
      await new Promise(r => setTimeout(r, 100));
    }
    
    db = window.firebaseDB;
    auth = window.firebaseAuth;
    
    document.getElementById('loadingStatus').textContent = 'Checking authentication...';
    
    window.firebaseFns.onAuthStateChanged(auth, async (user) => {
      if(user) {
        currentUserId = user.uid;
        await loadUserData(user.uid);
        document.getElementById('loadingOverlay').style.opacity = '0';
        setTimeout(() => {
          document.getElementById('loadingOverlay').style.display = 'none';
        }, 500);
      } else {
        document.getElementById('loadingOverlay').style.opacity = '0';
        setTimeout(() => {
          document.getElementById('loadingOverlay').style.display = 'none';
        }, 500);
      }
    });
    
    window.addEventListener('online', () => {
      document.getElementById('offlineIndicator').style.display = 'none';
    });
    
    window.addEventListener('offline', () => {
      document.getElementById('offlineIndicator').style.display = 'block';
    });
    
    setupPWA();
  });
  
  //====== FIREBASE DATA FUNCTIONS ======
  async function loadUserData(uid) {
    try {
      const userDoc = await window.firebaseFns.getDoc(window.firebaseFns.doc(db, 'users', uid));
      if(userDoc.exists()) {
        currentUserData = userDoc.data();
        role = currentUserData.role;
        currentUser = currentUserData.name || currentUserData.email;
        
        document.getElementById('login').style.display = 'none';
        document.getElementById('signup').style.display = 'none';
        document.getElementById('dashboard').style.display = 'block';
        
        loadDashboard();
        startSessionTimer();
        addNotification('Welcome back, ' + currentUser + '!', 'system');
      }
    } catch(error) {
      console.error('Error loading user data:', error);
      showError('Error loading user data');
    }
  }
  
  async function getCollectionData(collectionName, constraints = []) {
    try {
      const q = window.firebaseFns.query(
        window.firebaseFns.collection(db, collectionName),
        ...constraints
      );
      const snapshot = await window.firebaseFns.getDocs(q);
      return snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
    } catch(error) {
      console.error('Error getting collection:', error);
      return [];
    }
  }
  
  async function setDocument(collectionName, docId, data) {
    try {
      await window.firebaseFns.setDoc(
        window.firebaseFns.doc(db, collectionName, docId),
        { ...data, updatedAt: window.firebaseFns.serverTimestamp() },
        { merge: true }
      );
      return true;
    } catch(error) {
      console.error('Error setting document:', error);
      showError('Failed to save data');
      return false;
    }
  }
  
  async function addDocument(collectionName, data) {
    try {
      const docRef = await window.firebaseFns.addDoc(
        window.firebaseFns.collection(db, collectionName),
        { ...data, createdAt: window.firebaseFns.serverTimestamp(), updatedAt: window.firebaseFns.serverTimestamp() }
      );
      return docRef.id;
    } catch(error) {
      console.error('Error adding document:', error);
      showError('Failed to add data');
      return null;
    }
  }
  
  function subscribeToCollection(collectionName, callback, constraints = []) {
    const q = window.firebaseFns.query(
      window.firebaseFns.collection(db, collectionName),
      ...constraints
    );
    const unsubscribe = window.firebaseFns.onSnapshot(q, (snapshot) => {
      const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      callback(data);
    }, (error) => {
      console.error('Subscription error:', error);
    });
    unsubscribers.push(unsubscribe);
    return unsubscribe;
  }
  
  //====== AUTHENTICATION FUNCTIONS ======
  async function login() {
    const email = document.getElementById("loginEmail").value.trim();
    const password = document.getElementById("loginPassword").value;
    
    if(!email || !password) {
      showError("Please enter email/username and password");
      return;
    }
    
    // CHECK HARDCODED ADMIN LOGIN
    if(email === HARDCODED_ADMIN.username && password === HARDCODED_ADMIN.password) {
      document.getElementById('loadingOverlay').style.display = 'flex';
      document.getElementById('loadingStatus').textContent = 'Logging in as Admin...';
      
      // Set admin session without Firebase Auth
      role = HARDCODED_ADMIN.role;
      currentUser = HARDCODED_ADMIN.name;
      currentUserId = "HARDCODED_ADMIN_" + Date.now();
      currentUserData = {
        name: HARDCODED_ADMIN.name,
        email: HARDCODED_ADMIN.email,
        role: HARDCODED_ADMIN.role,
        uid: currentUserId
      };
      
      setTimeout(() => {
        document.getElementById('login').style.display = 'none';
        document.getElementById('signup').style.display = 'none';
        document.getElementById('dashboard').style.display = 'block';
        document.getElementById('loadingOverlay').style.display = 'none';
        
        loadDashboard();
        startSessionTimer();
        addNotification('Welcome back, Administrator!', 'system');
      }, 500);
      
      return;
    }
    
    if(loginAttempts >= MAX_LOGIN_ATTEMPTS) {
      showError("Account temporarily locked. Please try again later.");
      return;
    }
    
    try {
      document.getElementById('loadingOverlay').style.display = 'flex';
      document.getElementById('loadingStatus').textContent = 'Authenticating...';
      
      const userCredential = await window.firebaseFns.signInWithEmailAndPassword(auth, email, password);
      resetLoginAttempts();
      
    } catch(error) {
      document.getElementById('loadingOverlay').style.display = 'none';
      console.error('Login error:', error);
      recordFailedLogin();
      
      let errorMsg = "Login failed";
      switch(error.code) {
        case 'auth/user-not-found':
          errorMsg = "User not found";
          break;
        case 'auth/wrong-password':
          errorMsg = "Invalid password";
          break;
        case 'auth/invalid-email':
          errorMsg = "Invalid email format";
          break;
        case 'auth/user-disabled':
          errorMsg = "Account disabled";
          break;
      }
      showError(errorMsg);
    }
  }
  
  async function submitSignup() {
    const name = document.getElementById("signupName").value.trim();
    const id = document.getElementById("signupID").value.trim();
    const section = document.getElementById("signupSection").value.trim();
    const track = document.getElementById("signupTrack").value.trim();
    const strand = document.getElementById("signupStrand").value.trim();
    const gradeLevel = document.getElementById("signupGradeLevel").value.trim();
    const email = document.getElementById("signupEmail").value.trim();
    const password = document.getElementById("signupPass").value;
    
    if(!name || !id || !section || !track || !strand || !gradeLevel || !email || !password) {
      showError("All fields required!");
      return;
    }
    
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    if(!emailRegex.test(email)) {
      showError("Please enter a valid email address");
      return;
    }
    
    try {
      document.getElementById('loadingOverlay').style.display = 'flex';
      document.getElementById('loadingStatus').textContent = 'Creating account...';
      
      const userCredential = await window.firebaseFns.createUserWithEmailAndPassword(auth, email, password);
      const uid = userCredential.user.uid;
      
      await window.firebaseFns.setDoc(window.firebaseFns.doc(db, 'users', uid), {
        uid,
        name,
        studentId: id,
        section,
        track,
        strand,
        gradeLevel,
        email,
        role: 'student',
        approved: false,
        createdAt: window.firebaseFns.serverTimestamp()
      });
      
      const parentPassword = Math.random().toString(36).slice(-8);
      const parentEmail = `parent.${email}`;
      
      const parentCredential = await window.firebaseFns.createUserWithEmailAndPassword(auth, parentEmail, parentPassword);
      await window.firebaseFns.setDoc(window.firebaseFns.doc(db, 'users', parentCredential.user.uid), {
        uid: parentCredential.user.uid,
        name: `Parent of ${name}`,
        childName: name,
        childId: id,
        email: parentEmail,
        role: 'parent',
        approved: true,
        createdAt: window.firebaseFns.serverTimestamp()
      });
      
      await window.firebaseFns.setDoc(window.firebaseFns.doc(db, 'parentAccounts', parentCredential.user.uid), {
        studentName: name,
        studentId: id,
        section,
        parentEmail,
        parentPassword,
        createdAt: window.firebaseFns.serverTimestamp()
      });
      
      await window.firebaseFns.signOut(auth);
      document.getElementById('loadingOverlay').style.display = 'none';
      
      alert(`âœ… Signup successful! Your account is pending approval.\n\nParent Account:\nEmail: ${parentEmail}\nPassword: ${parentPassword}\n\nPlease save these credentials!`);
      clearSignup();
      showLogin();
      
    } catch(error) {
      document.getElementById('loadingOverlay').style.display = 'none';
      console.error('Signup error:', error);
      
      let errorMsg = "Signup failed";
      if(error.code === 'auth/email-already-in-use') {
        errorMsg = "Email already registered";
      } else if(error.code === 'auth/weak-password') {
        errorMsg = "Password is too weak";
      }
      showError(errorMsg);
    }
  }
  
  async function sendRecoveryEmail() {
    const email = document.getElementById("recoveryEmail").value.trim();
    if(!email) {
      showError("Please enter your email");
      return;
    }
    
    try {
      await window.firebaseFns.sendPasswordResetEmail(auth, email);
      document.getElementById("recoveryMsg").style.color = "green";
      document.getElementById("recoveryMsg").textContent = "âœ… Password reset email sent! Check your inbox.";
    } catch(error) {
      document.getElementById("recoveryMsg").style.color = "red";
      document.getElementById("recoveryMsg").textContent = "âŒ " + error.message;
    }
  }
  
  async function logout() {
    unsubscribers.forEach(unsub => unsub());
    unsubscribers = [];
    
    // If hardcoded admin, just clear session without Firebase signOut
    if(currentUserId && currentUserId.startsWith("HARDCODED_ADMIN_")) {
      role = "";
      currentUser = "";
      currentUserId = "";
      currentUserData = null;
      
      document.getElementById("dashboard").style.display = "none";
      document.getElementById("login").style.display = "flex";
      document.getElementById("menu").classList.remove("show");
      document.getElementById("menuOverlay").classList.remove("show");
      
      if(sessionTimer) clearTimeout(sessionTimer);
      if(sessionWarningTimer) clearTimeout(sessionWarningTimer);
      document.getElementById('sessionWarning').style.display = 'none';
      return;
    }
    
    await window.firebaseFns.signOut(auth);
    role = "";
    currentUser = "";
    currentUserId = "";
    currentUserData = null;
    
    document.getElementById("dashboard").style.display = "none";
    document.getElementById("login").style.display = "flex";
    document.getElementById("menu").classList.remove("show");
    document.getElementById("menuOverlay").classList.remove("show");
    
    if(sessionTimer) clearTimeout(sessionTimer);
    if(sessionWarningTimer) clearTimeout(sessionWarningTimer);
    document.getElementById('sessionWarning').style.display = 'none';
  }
  
  //====== UI FUNCTIONS ======
  function toggleMenu() {
    const menu = document.getElementById("menu");
    const overlay = document.getElementById("menuOverlay");
    const toggleBtn = document.getElementById("toggleBtn");
    
    menu.classList.toggle("show");
    overlay.classList.toggle("show");
    toggleBtn.classList.toggle("small", menu.classList.contains("show"));
  }
  
  function togglePassword() {
    const p = document.getElementById("loginPassword");
    p.type = (p.type === "password") ? "text" : "password";
  }
  
  function showSignup() {
    document.getElementById("login").style.display = "none";
    document.getElementById("signup").style.display = "flex";
  }
  
  function showLogin() {
    document.getElementById("signup").style.display = "none";
    document.getElementById("forgotPassword").style.display = "none";
    document.getElementById("login").style.display = "flex";
  }
  
  function showForgotPassword() {
    document.getElementById("login").style.display = "none";
    document.getElementById("forgotPassword").style.display = "flex";
  }
  
  function clearSignup() {
    ["signupName","signupID","signupSection","signupTrack","signupStrand","signupGradeLevel","signupEmail","signupPass"].forEach(function(id) {
      document.getElementById(id).value = "";
    });
    document.getElementById('signupPasswordStrength').className = 'password-strength';
    document.getElementById('signupStrengthText').textContent = '';
    document.getElementById('agreeTerms').checked = false;
    document.getElementById('signupBtn').disabled = true;
  }
  
  function checkPasswordStrength() {
    const password = document.getElementById('signupPass').value;
    const strengthBar = document.getElementById('signupPasswordStrength');
    const strengthText = document.getElementById('signupStrengthText');
    const signupBtn = document.getElementById('signupBtn');
    
    let strength = 0;
    if(password.length >= 8) strength++;
    if(password.match(/[a-z]+/)) strength++;
    if(password.match(/[A-Z]+/)) strength++;
    if(password.match(/[0-9]+/)) strength++;
    if(password.match(/[$@#&!]+/)) strength++;
    
    strengthBar.className = 'password-strength';
    
    if(strength <= 2) {
      strengthBar.classList.add('weak');
      strengthText.textContent = 'Weak - Add more character types';
      strengthText.style.color = '#dc3545';
    } else if(strength === 3 || strength === 4) {
      strengthBar.classList.add('medium');
      strengthText.textContent = 'Medium - Good but could be stronger';
      strengthText.style.color = '#ffc107';
    } else {
      strengthBar.classList.add('strong');
      strengthText.textContent = 'Strong - Excellent password!';
      strengthText.style.color = '#28a745';
    }
    
    const termsAgreed = document.getElementById('agreeTerms').checked;
    signupBtn.disabled = strength < 3 || !termsAgreed;
  }
  
  document.getElementById('agreeTerms')?.addEventListener('change', checkPasswordStrength);
  
  //====== DASHBOARD FUNCTIONS ======
  function loadDashboard() {
    const isHardcodedAdmin = currentUserId && currentUserId.startsWith("HARDCODED_ADMIN_");
    const displayRole = isHardcodedAdmin ? "ADMIN (HARDCODED)" : role.toUpperCase();
    document.getElementById("roleTitle").innerHTML = displayRole + " DASHBOARD" + (isHardcodedAdmin ? ' <span class="admin-badge">HARDCODED</span>' : '');
    
    const menu = document.getElementById("menu");
    menu.innerHTML = "";
    
    let items = [];
    
    if(role === "teacher") {
      items = [
        {name: "Attendance", icon: "ğŸ“…"},
        {name: "Subject Schedule", icon: "ğŸ“š"},
        {name: "My Info", icon: "ğŸ‘¤"},
        {name: "Bulletin Board", icon: "ğŸ“¢"},
        {name: "Grades", icon: "ğŸ“Š"},
        {name: "Report Cards", icon: "ğŸ“‹"},
        {name: "Assignments", icon: "ğŸ“"},
        {name: "Quizzes", icon: "â“"},
        {name: "Course Materials", icon: "ğŸ“–"},
        {name: "Messages", icon: "ğŸ’¬"},
        {name: "Conference Schedule", icon: "ğŸ“…"},
        {name: "Behavior Reports", icon: "ğŸ“‹"},
        {name: "My Planner", icon: "ğŸ—“ï¸"},
        {name: "Emergency Numbers", icon: "ğŸš¨"},
        {name: "School Map", icon: "ğŸ—ºï¸"},
        {name: "Settings", icon: "âš™ï¸"}
      ];
    }
    else if(role === "student") {
      items = [
        {name: "Attendance", icon: "ğŸ“…"},
        {name: "Subject Schedule", icon: "ğŸ“š"},
        {name: "My Info", icon: "ğŸ‘¤"},
        {name: "Bulletin Board", icon: "ğŸ“¢"},
        {name: "Grades", icon: "ğŸ“Š"},
        {name: "Assignments", icon: "ğŸ“"},
        {name: "Quizzes", icon: "â“"},
        {name: "Course Materials", icon: "ğŸ“–"},
        {name: "QR Code", icon: "ğŸ”³"},
        {name: "Messages", icon: "ğŸ’¬"},
        {name: "My Mood", icon: "ğŸ˜Š"},
        {name: "Honor Roll", icon: "ğŸ†"},
        {name: "Emergency Numbers", icon: "ğŸš¨"},
        {name: "School Map", icon: "ğŸ—ºï¸"},
        {name: "Settings", icon: "âš™ï¸"}
      ];
    }
    else if(role === "parent") {
      items = [
        {name: "Child Attendance", icon: "ğŸ“…"},
        {name: "Child Grades", icon: "ğŸ“Š"},
        {name: "Child Schedule", icon: "ğŸ“š"},
        {name: "My Info", icon: "ğŸ‘¤"},
        {name: "Bulletin Board", icon: "ğŸ“¢"},
        {name: "Messages", icon: "ğŸ’¬"},
        {name: "Conference Booking", icon: "ğŸ“…"},
        {name: "Progress Reports", icon: "ğŸ“ˆ"},
        {name: "Behavior Reports", icon: "ğŸ“‹"},
        {name: "Emergency Numbers", icon: "ğŸš¨"},
        {name: "School Map", icon: "ğŸ—ºï¸"},
        {name: "Settings", icon: "âš™ï¸"}
      ];
    }
    else if(role === "admin") {
      items = [
        {name: "Student Approval", icon: "âœ…"},
        {name: "Create Teacher", icon: "ğŸ‘¨â€ğŸ«"},
        {name: "All Students", icon: "ğŸ‘¨â€ğŸ“"},
        {name: "Parent Accounts", icon: "ğŸ‘ª"},
        {name: "Manage Users", icon: "âš™ï¸"},
        {name: "Enrollment", icon: "ğŸ“"},
        {name: "Class Scheduling", icon: "ğŸ“…"},
        {name: "Honor Roll", icon: "ğŸ†"},
        {name: "Analytics", icon: "ğŸ“Š"},
        {name: "Bulletin Board", icon: "ğŸ“¢"},
        {name: "Emergency Numbers", icon: "ğŸš¨"},
        {name: "School Map", icon: "ğŸ—ºï¸"},
        {name: "Settings", icon: "âš™ï¸"}
      ];
    }
    
    menu.innerHTML = '<div class="menu-header"><h3>ğŸ“ DSHS Menu</h3><p>ğŸ‘¤ ' + currentUser + (isHardcodedAdmin ? ' <span class="admin-badge">ADMIN</span>' : '') + '</p></div>';
    
    items.forEach(function(item) {
      const btn = document.createElement("button");
      btn.innerHTML = '<span class="tab-icon">' + item.icon + '</span> ' + item.name;
      btn.onclick = function() {
        toggleMenu();
        loadSection(item.name);
      };
      menu.appendChild(btn);
    });
    
    const logoutBtn = document.createElement("button");
    logoutBtn.innerHTML = '<span class="tab-icon">ğŸšª</span> Logout';
    logoutBtn.className = "logout";
    logoutBtn.onclick = function() {
      toggleMenu();
      logout();
    };
    menu.appendChild(logoutBtn);
    
    updateNotificationBadge();
  }
  
  //====== SECTION LOADING FUNCTIONS ======
  async function loadSection(tab) {
    const content = document.getElementById("content");
    content.innerHTML = "";
    const section = document.createElement("div");
    section.className = "section";
    
    if(tab === "Dashboard" || !tab) {
      section.innerHTML = `
        <div class="school-welcome">
          <h2>ğŸ« Dumingag Senior High School</h2>
          <p>Welcome back, ${currentUser}!</p>
        </div>
      `;
      content.appendChild(section);
      return;
    }
    
    if(tab === "Attendance" || tab === "Child Attendance") {
      section.innerHTML = "<h3>ğŸ“… Attendance</h3><p>Attendance feature coming soon...</p>";
      content.appendChild(section);
    }
    else if(tab === "Grades" || tab === "Child Grades") {
      section.innerHTML = "<h3>ğŸ“Š Grades</h3>";
      
      let targetUserId = currentUserId;
      if(role === "parent") {
        const childData = await getCollectionData('users', [
          window.firebaseFns.where('name', '==', currentUserData.childName)
        ]);
        if(childData.length > 0) targetUserId = childData[0].id;
      }
      
      const grades = await getCollectionData('grades', [
        window.firebaseFns.where('studentId', '==', targetUserId)
      ]);
      
      const table = document.createElement('table');
      table.innerHTML = '<tr><th>Subject</th><th>Grade</th><th>Status</th></tr>';
      
      if(grades.length === 0) {
        table.innerHTML += '<tr><td colspan="3">No grades available</td></tr>';
      } else {
        grades.forEach(g => {
          const tr = document.createElement('tr');
          const status = g.grade >= 75 ? 'âœ… Passing' : 'âš ï¸ Needs Improvement';
          const color = g.grade >= 75 ? 'green' : 'red';
          
          if(role === "teacher") {
            tr.innerHTML = `<td>${g.subject}</td><td contenteditable onblur="updateGrade('${g.id}', this.innerText)">${g.grade}</td><td style="color:${color}">${status}</td>`;
          } else {
            tr.innerHTML = `<td>${g.subject}</td><td>${g.grade}</td><td style="color:${color}">${status}</td>`;
          }
          table.appendChild(tr);
        });
      }
      
      section.appendChild(table);
      content.appendChild(section);
    }
    else if(tab === "Bulletin Board") {
      section.innerHTML = "<h3>ğŸ“¢ Bulletin Board</h3>";
      
      const board = document.createElement('div');
      board.id = 'bulletinBoard';
      section.appendChild(board);
      
      subscribeToCollection('bulletinBoard', (items) => {
        board.innerHTML = '';
        if(items.length === 0) {
          board.innerHTML = '<p>No announcements yet.</p>';
        } else {
          items.forEach(item => {
            const div = document.createElement('div');
            div.style.cssText = 'padding: 15px; border-bottom: 1px solid #ddd; margin-bottom: 10px; background: #f8f9fa; border-radius: 8px;';
            div.innerHTML = `
              <p>${item.content}</p>
              <small style="color: #666;">By ${item.author || 'Unknown'} â€¢ ${item.createdAt?.toDate().toLocaleString() || 'Just now'}</small>
            `;
            board.appendChild(div);
          });
        }
      }, [window.firebaseFns.orderBy('createdAt', 'desc')]);
      
      if(role === "teacher" || role === "admin") {
        const input = document.createElement('input');
        input.id = 'newAnnouncement';
        input.placeholder = 'Type new announcement...';
        section.appendChild(input);
        
        const btn = document.createElement('button');
        btn.innerText = 'â• Add Announcement';
        btn.style.cssText = 'background: linear-gradient(135deg, #8B0000 0%, #003366 100%); color: white; margin-top: 10px;';
        btn.onclick = async () => {
          const text = input.value.trim();
          if(text) {
            await addDocument('bulletinBoard', {
              content: text,
              author: currentUser,
              authorId: currentUserId,
              authorRole: role
            });
            input.value = '';
          }
        };
        section.appendChild(btn);
      }
      
      content.appendChild(section);
    }
    else if(tab === "My Info") {
      section.innerHTML = "<h3>ğŸ‘¤ My Information</h3>";
      
      const user = currentUserData;
      if(user) {
        // Generate initials for avatar
        const initials = user.name ? user.name.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase() : 'ğŸ‘¤';
        
        section.innerHTML += `
          <div style="text-align: center; margin-bottom: 20px;">
            <div class="id-card-photo" style="width: 120px; height: 120px; margin: 0 auto 15px; font-size: 48px; display: flex; align-items: center; justify-content: center; background: linear-gradient(135deg, var(--main-red) 0%, var(--main-blue) 100%); color: white;">
              ${initials}
            </div>
            <p style="color: #666; font-size: 14px;">Profile Photo (Initials Avatar)</p>
          </div>
          <div class="id-card-info" style="background: #f8f9fa; color: #333; padding: 20px; border-radius: 10px;">
            <p><strong>Name:</strong> ${user.name || '-'}</p>
            <p><strong>Email:</strong> ${user.email || '-'}</p>
            <p><strong>Role:</strong> ${user.role || '-'}</p>
            <p><strong>Section:</strong> ${user.section || user.sectionHandled || '-'}</p>
            <p><strong>Track:</strong> ${user.track || '-'}</p>
            <p><strong>Strand:</strong> ${user.strand || '-'}</p>
            <p><strong>Grade Level:</strong> ${user.gradeLevel || '-'}</p>
          </div>
        `;
      }
      
      content.appendChild(section);
    }
    else if(tab === "Student Approval" && role === "admin") {
      section.innerHTML = "<h3>âœ… Approve Students</h3>";
      
      const pendingStudents = await getCollectionData('users', [
        window.firebaseFns.where('role', '==', 'student'),
        window.firebaseFns.where('approved', '==', false)
      ]);
      
      if(pendingStudents.length === 0) {
        section.innerHTML += "<p>âœ… No pending approvals.</p>";
      } else {
        pendingStudents.forEach(s => {
          const div = document.createElement('div');
          div.style.cssText = 'padding: 15px; border: 2px solid #ddd; margin-bottom: 10px; border-radius: 10px; background: #fff3cd;';
          div.innerHTML = `
            <p><strong>ğŸ‘¤ Name:</strong> ${s.name}</p>
            <p><strong>ğŸ†” ID:</strong> ${s.studentId}</p>
            <p><strong>ğŸ« Section:</strong> ${s.section}</p>
            <button onclick="approveStudent('${s.id}')" style="background: #28a745; color: white; width: auto; padding: 10px 20px; margin-right: 10px;">âœ… Approve</button>
            <button onclick="rejectStudent('${s.id}')" style="background: #dc3545; color: white; width: auto; padding: 10px 20px;">ğŸ—‘ï¸ Reject</button>
          `;
          section.appendChild(div);
        });
      }
      
      content.appendChild(section);
    }
    else if(tab === "Analytics" && role === "admin") {
      section.innerHTML = "<h3>ğŸ“Š School Analytics</h3>";
      
      const allUsers = await getCollectionData('users');
      const students = allUsers.filter(u => u.role === 'student');
      const teachers = allUsers.filter(u => u.role === 'teacher');
      const parents = allUsers.filter(u => u.role === 'parent');
      const pending = students.filter(s => !s.approved).length;
      
      section.innerHTML += `
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px;">
          <div class="analytics-card">
            <div class="analytics-number">${students.length}</div>
            <div class="analytics-label">Total Students</div>
          </div>
          <div class="analytics-card">
            <div class="analytics-number">${teachers.length}</div>
            <div class="analytics-label">Teachers</div>
          </div>
          <div class="analytics-card">
            <div class="analytics-number">${parents.length}</div>
            <div class="analytics-label">Parents</div>
          </div>
          <div class="analytics-card">
            <div class="analytics-number">${pending}</div>
            <div class="analytics-label">Pending Approvals</div>
          </div>
        </div>
      `;
      
      content.appendChild(section);
    }
    else if(tab === "Settings") {
      section.innerHTML = `
        <h3>âš™ï¸ Settings</h3>
        <div class="settings-section">
          <h4>ğŸ¨ Appearance</h4>
          <div style="display: flex; justify-content: space-between; align-items: center; margin: 15px 0;">
            <div>
              <strong>Dark Mode</strong>
              <p style="margin: 5px 0; font-size: 13px; color: #666;">Easier on the eyes</p>
            </div>
            <label class="toggle-switch">
              <input type="checkbox" id="toggleDarkMode" onchange="toggleDarkMode()" ${localStorage.getItem('darkMode') === 'true' ? 'checked' : ''}>
              <span class="slider"></span>
            </label>
          </div>
        </div>
        <div class="settings-section">
          <h4>ğŸ”” Notifications</h4>
          <div style="display: flex; justify-content: space-between; align-items: center; margin: 15px 0;">
            <div>
              <strong>Push Notifications</strong>
              <p style="margin: 5px 0; font-size: 13px; color: #666;">Get notified about updates</p>
            </div>
            <label class="toggle-switch">
              <input type="checkbox" id="togglePushNotif" checked>
              <span class="slider"></span>
            </label>
          </div>
        </div>
      `;
      content.appendChild(section);
    }
    else {
      section.innerHTML = `
        <div class="school-welcome">
          <h2>ğŸ« ${tab}</h2>
          <p>This feature is coming soon!</p>
        </div>
      `;
      content.appendChild(section);
    }
  }
  
  //====== HELPER FUNCTIONS ======
  async function updateGrade(gradeId, newGrade) {
    const grade = parseInt(newGrade);
    if(isNaN(grade) || grade < 0 || grade > 100) {
      alert('Grade must be between 0 and 100');
      return;
    }
    
    await setDocument('grades', gradeId, { grade });
    alert('âœ… Grade updated!');
  }
  
  async function approveStudent(studentId) {
    await setDocument('users', studentId, { approved: true });
    addNotification('Your account has been approved!', 'approval', studentId);
    alert('âœ… Student approved!');
    loadSection('Student Approval');
  }
  
  async function rejectStudent(studentId) {
    if(confirm('Are you sure you want to reject this student?')) {
      await window.firebaseFns.deleteDoc(window.firebaseFns.doc(db, 'users', studentId));
      alert('ğŸ—‘ï¸ Student rejected');
      loadSection('Student Approval');
    }
  }
  
  //====== NOTIFICATION FUNCTIONS ======
  function addNotification(message, type = 'info', recipientId = null) {
    const notification = {
      message,
      type,
      recipientId: recipientId || currentUserId,
      read: false,
      createdAt: new Date()
    };
    
    addDocument('notifications', notification);
  }
  
  function updateNotificationBadge() {
    // Implementation for notification badge
  }
  
  function toggleNotifications() {
    document.getElementById('notificationPanel').classList.toggle('show');
  }
  
  //====== SESSION MANAGEMENT ======
  function startSessionTimer() {
    if(sessionTimer) clearTimeout(sessionTimer);
    if(sessionWarningTimer) clearTimeout(sessionWarningTimer);
    
    sessionWarningTimer = setTimeout(() => {
      showSessionWarning();
    }, SESSION_TIMEOUT - WARNING_BEFORE);
    
    sessionTimer = setTimeout(() => {
      logout();
      alert('ğŸ”’ Your session has expired. Please login again.');
    }, SESSION_TIMEOUT);
    
    document.addEventListener('click', resetSessionTimer);
    document.addEventListener('keypress', resetSessionTimer);
  }
  
  function resetSessionTimer() {
    if(sessionTimer) clearTimeout(sessionTimer);
    if(sessionWarningTimer) clearTimeout(sessionWarningTimer);
    
    document.getElementById('sessionWarning').style.display = 'none';
    
    sessionWarningTimer = setTimeout(() => {
      showSessionWarning();
    }, SESSION_TIMEOUT - WARNING_BEFORE);
    
    sessionTimer = setTimeout(() => {
      logout();
      alert('ğŸ”’ Your session has expired. Please login again.');
    }, SESSION_TIMEOUT);
  }
  
  function showSessionWarning() {
    const warning = document.getElementById('sessionWarning');
    const countdown = document.getElementById('countdown');
    warning.style.display = 'block';
    
    let seconds = 60;
    const interval = setInterval(() => {
      seconds--;
      countdown.textContent = seconds;
      if(seconds <= 0) clearInterval(interval);
    }, 1000);
  }
  
  function recordFailedLogin() {
    loginAttempts++;
    document.getElementById('loginAttempts').style.display = 'block';
    document.getElementById('attemptCount').textContent = loginAttempts;
    
    if(loginAttempts >= MAX_LOGIN_ATTEMPTS) {
      lockAccount();
    }
  }
  
  function lockAccount() {
    const loginBtn = document.querySelector('#login button');
    loginBtn.disabled = true;
    loginBtn.textContent = 'ğŸ”’ Account Locked (5 min)';
    
    let minutes = 5;
    lockoutTimer = setInterval(() => {
      minutes--;
      if(minutes > 0) {
        loginBtn.textContent = `ğŸ”’ Account Locked (${minutes} min)`;
      } else {
        clearInterval(lockoutTimer);
        loginAttempts = 0;
        loginBtn.disabled = false;
        loginBtn.textContent = 'ğŸš€ Login';
        document.getElementById('loginAttempts').style.display = 'none';
      }
    }, 60000);
  }
  
  function resetLoginAttempts() {
    loginAttempts = 0;
    document.getElementById('loginAttempts').style.display = 'none';
  }
  
  //====== PWA FUNCTIONS ======
  function setupPWA() {
    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      window.deferredPrompt = e;
      document.getElementById('installPwaBtn').classList.add('show');
    });
    
    if('serviceWorker' in navigator) {
      navigator.serviceWorker.register('sw.js').then((registration) => {
        console.log('SW registered:', registration);
      }).catch((error) => {
        console.log('SW registration failed:', error);
      });
    }
  }
  
  function installPWA() {
    if(window.deferredPrompt) {
      window.deferredPrompt.prompt();
      window.deferredPrompt.userChoice.then((choiceResult) => {
        if(choiceResult.outcome === 'accepted') {
          console.log('User accepted PWA install');
        }
        window.deferredPrompt = null;
        document.getElementById('installPwaBtn').classList.remove('show');
      });
    }
  }
  
  //====== UTILITY FUNCTIONS ======
  function showError(msg) {
    const el = document.getElementById('msg') || document.getElementById('recoveryMsg');
    if(el) {
      el.style.color = '#dc3545';
      el.textContent = 'âŒ ' + msg;
    }
  }
  
  function toggleDarkMode() {
    document.body.classList.toggle('dark-mode');
    localStorage.setItem('darkMode', document.body.classList.contains('dark-mode'));
  }
  
  if(localStorage.getItem('darkMode') === 'true') {
    document.body.classList.add('dark-mode');
  }
</script>

</body>
</html>
